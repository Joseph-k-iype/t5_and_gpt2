from pptx.oxml import parse_xml
from pptx.oxml.ns import nsdecls
from pptx.dml.color import RGBColor

def set_table_borders(table, border_color="000000"):
    """
    Apply borders with the specified color to all cells in a PowerPoint table.

    :param table: The PowerPoint table object
    :param border_color: The border color in hexadecimal format (e.g., "000000" for black)
    """
    for row in table.rows:
        for cell in row.cells:
            tc = cell._tc  # Access the XML element for the cell
            tcPr = tc.get_or_add_tcPr()  # Get or add the <a:tcPr> element

            # Define borders for the cell
            border_xml = f"""
                <a:lnL w="12700" cap="flat" cmpd="sng" algn="ctr" {nsdecls('a')}>
                    <a:solidFill>
                        <a:srgbClr val="{border_color}"/>
                    </a:solidFill>
                </a:lnL>
                <a:lnR w="12700" cap="flat" cmpd="sng" algn="ctr" {nsdecls('a')}>
                    <a:solidFill>
                        <a:srgbClr val="{border_color}"/>
                    </a:solidFill>
                </a:lnR>
                <a:lnT w="12700" cap="flat" cmpd="sng" algn="ctr" {nsdecls('a')}>
                    <a:solidFill>
                        <a:srgbClr val="{border_color}"/>
                    </a:solidFill>
                </a:lnT>
                <a:lnB w="12700" cap="flat" cmpd="sng" algn="ctr" {nsdecls('a')}>
                    <a:solidFill>
                        <a:srgbClr val="{border_color}"/>
                    </a:solidFill>
                </a:lnB>
            """
            try:
                # Clear conflicting border elements
                while tcPr.getchildren():
                    tcPr.remove(tcPr.getchildren()[0])

                # Append border XML to the cell properties
                tcPr.append(parse_xml(border_xml))
            except Exception as e:
                print(f"Error applying border to cell: {e}")

def create_table(slide, headers, num_rows, top_position, slide_width):
    """
    Create a PowerPoint table with borders, header colors, and white row backgrounds.
    """
    cols = len(headers)
    table = slide.shapes.add_table(num_rows, cols, Inches(0.5), top_position, slide_width - Inches(1), Inches(0.5)).table

    # Apply header styles
    for col_idx, header in enumerate(headers):
        cell = table.cell(0, col_idx)
        cell.text = header
        cell.fill.solid()
        cell.fill.fore_color.rgb = RGBColor(0x36, 0x6B, 0x1F)  # Dark green for header
        for paragraph in cell.text_frame.paragraphs:
            for run in paragraph.runs:
                run.font.size = Pt(10)
                run.font.bold = True
                run.font.color.rgb = RGBColor(255, 255, 255)  # White text

    # Apply row styles
    for row_idx in range(1, num_rows):
        for col_idx in range(cols):
            cell = table.cell(row_idx, col_idx)
            cell.fill.solid()
            cell.fill.fore_color.rgb = RGBColor(255, 255, 255)  # White background for rows
            for paragraph in cell.text_frame.paragraphs:
                for run in paragraph.runs:
                    run.font.size = Pt(10)

    # Apply borders to the entire table
    set_table_borders(table, border_color="000000")  # Black borders

    return table
