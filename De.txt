"""
HSBC OpenAI Client wrapper
Creates properly configured clients for HSBC authentication
"""
import logging
import uuid
import httpx
from openai import OpenAI

from .hsbc_token_service import HSBCTokenService
from ..config import Config

logger = logging.getLogger(__name__)


class TokenRefreshTransport(httpx.HTTPTransport):
    """Custom transport that refreshes tokens on 401 errors"""
    
    def __init__(self, token_service: HSBCTokenService, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.token_service = token_service
        self.max_retries = 1
    
    def handle_request(self, request: httpx.Request) -> httpx.Response:
        """Handle request with automatic token refresh on 401"""
        response = super().handle_request(request)
        
        # If we get a 401, refresh token and retry once
        if response.status_code == 401 and self.max_retries > 0:
            logger.info("Got 401, refreshing token and retrying...")
            
            # Get fresh token
            fresh_token = self.token_service.get_token(force_refresh=True)
            
            # Update request headers
            request.headers["X-HSBC-E2E-Trust-Token"] = fresh_token
            request.headers["Authorization"] = f"Bearer {fresh_token}"
            request.headers["x-correlation-id"] = str(uuid.uuid4())
            request.headers["x-usersession-id"] = str(uuid.uuid4())
            
            # Retry the request
            self.max_retries -= 1
            response = super().handle_request(request)
            self.max_retries = 1  # Reset for next request
        
        return response


class HSBCOpenAIClient(OpenAI):
    """
    Custom OpenAI client with HSBC JWT authentication.
    Uses httpx with http2 and truststore for SSL.
    """
    
    def __init__(
        self,
        token_service: HSBCTokenService,
        user_id: str,
        base_url: str,
        **kwargs
    ):
        """
        Initialize HSBC OpenAI Client
        
        Args:
            token_service: HSBCTokenService instance for token management
            user_id: HSBC user ID to include in requests
            base_url: Base URL for OpenAI-compatible API
            **kwargs: Additional arguments for OpenAI client
        """
        self.token_service = token_service
        self.user_id = user_id
        
        initial_token = token_service.get_token()
        httpx_client = token_service.get_httpx_client()
        
        correlation_id = str(uuid.uuid4())
        session_id = str(uuid.uuid4())
        
        default_headers = {
            "X-HSBC-E2E-Trust-Token": initial_token,
            "Token_Type": "SESSION_TOKEN",
            "x-correlation-id": correlation_id,
            "x-usersession-id": session_id,
            "Content-Type": "application/json"
        }
        
        super().__init__(
            api_key=initial_token,
            base_url=base_url,
            http_client=httpx_client,
            default_headers=default_headers,
            **kwargs
        )
        
        logger.info(f"HSBC OpenAI Client initialized")
        logger.info(f"  Base URL: {base_url}")
        logger.info(f"  User ID: {user_id}")
    
    def _refresh_token_and_headers(self):
        """
        Refresh token - simplified version.
        Note: The httpx client handles most of the refresh logic automatically.
        """
        fresh_token = self.token_service.get_token(force_refresh=True)
        self.api_key = fresh_token
        logger.info("Token refreshed")


def create_hsbc_client() -> HSBCOpenAIClient:
    """
    Factory function to create HSBC OpenAI client
    
    Returns:
        HSBCOpenAIClient: Configured client instance
    """
    if not Config.HSBC_PASSWORD:
        raise ValueError(
            "HSBC_PASSWORD environment variable required for HSBC authentication. "
            "Set it using: export HSBC_PASSWORD='your-password'"
        )
    
    logger.info("Creating HSBC token service...")
    
    token_service = HSBCTokenService(
        token_endpoint=Config.HSBC_TOKEN_ENDPOINT,
        username=Config.HSBC_USERNAME,
        password=Config.HSBC_PASSWORD
    )
    
    logger.info("Creating HSBC OpenAI client...")
    
    return HSBCOpenAIClient(
        token_service=token_service,
        user_id=Config.HSBC_USER_ID,
        base_url=Config.BASE_URL
    )


def create_langchain_client():
    """
    Create a properly configured ChatOpenAI instance for LangChain
    Compatible with the working httpx + truststore approach
    
    Returns:
        ChatOpenAI instance configured for HSBC
    """
    from langchain_openai import ChatOpenAI
    
    if not Config.HSBC_PASSWORD:
        raise ValueError(
            "HSBC_PASSWORD environment variable required for HSBC authentication. "
            "Set it using: export HSBC_PASSWORD='your-password'"
        )
    
    logger.info("Creating LangChain ChatOpenAI with HSBC authentication...")
    
    token_service = HSBCTokenService(
        token_endpoint=Config.HSBC_TOKEN_ENDPOINT,
        username=Config.HSBC_USERNAME,
        password=Config.HSBC_PASSWORD
    )
    
    jwt_token = token_service.get_token()
    httpx_client = token_service.get_httpx_client()
    
    invocation_headers = {
        'X-HSBC-E2E-Trust-Token': jwt_token,
        'x-correlation-id': str(uuid.uuid4()),
        'x-usersession-id': str(uuid.uuid4()),
        'Content-Type': 'application/json'
    }
    
    logger.info(f"LangChain client configured:")
    logger.info(f"  Model: {Config.CHAT_MODEL}")
    logger.info(f"  Base URL: {Config.BASE_URL}")
    logger.info(f"  User: {Config.HSBC_USER_ID}")
    
    llm = ChatOpenAI(
        model=Config.CHAT_MODEL,
        api_key=jwt_token,
        base_url=Config.BASE_URL,
        http_client=httpx_client,
        default_headers=invocation_headers,
        model_kwargs={"user": Config.HSBC_USER_ID}
    )
    
    llm._hsbc_token_service = token_service
    
    logger.info("âœ“ LangChain ChatOpenAI client created successfully")
    
    return llm
