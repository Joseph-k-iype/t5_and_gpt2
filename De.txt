"""
HSBC OpenAI Client wrapper
Creates properly configured clients for HSBC authentication
FIXED: Proper OpenAI client structure with token refresh for LangChain
"""
import logging
import uuid
from typing import Any
from openai import OpenAI
from openai._exceptions import APIStatusError

from .hsbc_token_service import HSBCTokenService
from ..config import Config

logger = logging.getLogger(__name__)


class HSBCOpenAIClient(OpenAI):
    """
    Custom OpenAI client with HSBC JWT authentication.
    Uses httpx with http2 and truststore for SSL.
    Automatically refreshes tokens on expiration.
    Works with both direct usage and LangChain.
    """
    
    def __init__(
        self,
        token_service: HSBCTokenService,
        user_id: str,
        base_url: str,
        **kwargs
    ):
        """
        Initialize HSBC OpenAI Client
        
        Args:
            token_service: HSBCTokenService instance for token management
            user_id: HSBC user ID to include in requests
            base_url: Base URL for OpenAI-compatible API
            **kwargs: Additional arguments for OpenAI client
        """
        self.token_service = token_service
        self.user_id = user_id
        self._retry_count = 0
        self._max_retries = 3
        
        initial_token = token_service.get_token()
        httpx_client = token_service.get_httpx_client()
        
        correlation_id = str(uuid.uuid4())
        session_id = str(uuid.uuid4())
        
        default_headers = {
            "X-HSBC-E2E-Trust-Token": initial_token,
            "Token_Type": "SESSION_TOKEN",
            "x-correlation-id": correlation_id,
            "x-usersession-id": session_id,
            "Content-Type": "application/json"
        }
        
        super().__init__(
            api_key=initial_token,
            base_url=base_url,
            http_client=httpx_client,
            default_headers=default_headers,
            **kwargs
        )
        
        # Store headers dict for reference
        self._headers_dict = default_headers
        
        logger.info(f"HSBC OpenAI Client initialized")
        logger.info(f"  Base URL: {base_url}")
        logger.info(f"  User ID: {user_id}")
    
    def _get_fresh_headers(self, force_refresh: bool = False) -> dict:
        """
        Get fresh headers with current/refreshed token and new IDs
        
        Args:
            force_refresh: Force token refresh even if not expired
        """
        # Check if token needs refresh and get current or fresh token
        fresh_token = self.token_service.get_token(force_refresh=force_refresh)
        
        return {
            "X-HSBC-E2E-Trust-Token": fresh_token,
            "Token_Type": "SESSION_TOKEN",
            "x-correlation-id": str(uuid.uuid4()),
            "x-usersession-id": str(uuid.uuid4()),
            "Content-Type": "application/json"
        }
    
    def _make_request(self, *args, **kwargs):
        """
        Override to inject fresh headers and handle token expiration.
        Automatically retries with token refresh on 401 errors.
        This works for both direct usage and LangChain.
        """
        self._retry_count = 0
        
        while self._retry_count < self._max_retries:
            try:
                # Get fresh headers (will auto-refresh if token is expiring)
                force_refresh = self._retry_count > 0  # Force refresh on retries
                fresh_headers = self._get_fresh_headers(force_refresh=force_refresh)
                
                # Update the headers dict we're tracking
                self._headers_dict.update(fresh_headers)
                
                # Inject headers into the request
                if 'extra_headers' not in kwargs:
                    kwargs['extra_headers'] = {}
                kwargs['extra_headers'].update(fresh_headers)
                
                # Update API key
                self.api_key = fresh_headers["X-HSBC-E2E-Trust-Token"]
                
                if self._retry_count > 0:
                    logger.info(f"ðŸ”„ Retrying request with fresh token (attempt {self._retry_count + 1}/{self._max_retries})")
                
                # Make the actual request
                response = super()._make_request(*args, **kwargs)
                
                # Reset retry count on success
                self._retry_count = 0
                return response
                
            except APIStatusError as e:
                # Check for 401 Unauthorized (token expired)
                if e.status_code == 401:
                    self._retry_count += 1
                    
                    if self._retry_count >= self._max_retries:
                        logger.error(f"âŒ Token refresh failed after {self._max_retries} attempts")
                        raise
                    
                    logger.warning(f"âš ï¸ Got 401 Unauthorized - token expired or invalid. Refreshing... (attempt {self._retry_count}/{self._max_retries})")
                    logger.warning(f"   Error detail: {e.message if hasattr(e, 'message') else str(e)}")
                    
                    # Force invalidate the current token
                    self.token_service.invalidate_token()
                    
                    # Continue to retry with fresh token
                    continue
                else:
                    # Not a 401 error, raise immediately
                    raise
                    
            except Exception as e:
                # For other exceptions, check if it's related to authentication
                error_msg = str(e).lower()
                if 'unauthorized' in error_msg or 'token' in error_msg or 'expired' in error_msg or 'sso' in error_msg or 'credential' in error_msg:
                    self._retry_count += 1
                    
                    if self._retry_count >= self._max_retries:
                        logger.error(f"âŒ Token refresh failed after {self._max_retries} attempts")
                        raise
                    
                    logger.warning(f"âš ï¸ Authentication error detected: {e}")
                    logger.warning(f"   Refreshing token... (attempt {self._retry_count}/{self._max_retries})")
                    
                    # Force invalidate the current token
                    self.token_service.invalidate_token()
                    
                    # Continue to retry with fresh token
                    continue
                else:
                    # Not an auth error, raise immediately
                    raise
        
        raise Exception(f"Request failed after {self._max_retries} token refresh attempts")


def create_hsbc_client() -> HSBCOpenAIClient:
    """
    Factory function to create HSBC OpenAI client with automatic token refresh
    
    Returns:
        HSBCOpenAIClient: Configured client instance with token management
    """
    if not Config.HSBC_PASSWORD:
        raise ValueError(
            "HSBC_PASSWORD environment variable required for HSBC authentication. "
            "Set it using: export HSBC_PASSWORD='your-password'"
        )
    
    logger.info("Creating HSBC token service...")
    
    token_service = HSBCTokenService(
        token_endpoint=Config.HSBC_TOKEN_ENDPOINT,
        username=Config.HSBC_USERNAME,
        password=Config.HSBC_PASSWORD,
        token_buffer_seconds=300  # Refresh 5 minutes before expiry
    )
    
    logger.info("Creating HSBC OpenAI client with automatic token refresh...")
    
    return HSBCOpenAIClient(
        token_service=token_service,
        user_id=Config.HSBC_USER_ID,
        base_url=Config.BASE_URL
    )


def create_langchain_client():
    """
    Create a properly configured ChatOpenAI instance for LangChain
    WITH automatic token refresh through custom wrapper
    FIXED: Proper integration with LangChain's expected parameters
    
    Returns:
        ChatOpenAI instance configured for HSBC with token management
    """
    from langchain_openai import ChatOpenAI
    
    if not Config.HSBC_PASSWORD:
        raise ValueError(
            "HSBC_PASSWORD environment variable required for HSBC authentication. "
            "Set it using: export HSBC_PASSWORD='your-password'"
        )
    
    logger.info("=" * 60)
    logger.info("Creating LangChain ChatOpenAI with HSBC authentication")
    logger.info("=" * 60)
    
    # Create the HSBC client (which handles token refresh)
    hsbc_client = create_hsbc_client()
    
    logger.info(f"LangChain client configuration:")
    logger.info(f"  Model: {Config.CHAT_MODEL}")
    logger.info(f"  Base URL: {Config.BASE_URL}")
    logger.info(f"  User: {Config.HSBC_USER_ID}")
    logger.info(f"  Token refresh: âœ“ Enabled (auto-refresh on 401)")
    
    # Get initial token
    initial_token = hsbc_client.token_service.get_token()
    
    # LangChain ChatOpenAI with default_client parameter
    # This ensures LangChain uses our custom client for all requests
    llm = ChatOpenAI(
        model=Config.CHAT_MODEL,
        openai_api_key=initial_token,
        openai_api_base=Config.BASE_URL,
        http_client=hsbc_client._client,  # Pass the httpx client
        model_kwargs={
            "user": Config.HSBC_USER_ID
        }
    )
    
    # CRITICAL: Replace LangChain's internal client with our HSBC client
    # This ensures token refresh works for all LangChain operations
    llm.client = hsbc_client
    
    # Store references for token management
    llm._hsbc_client = hsbc_client
    llm._hsbc_token_service = hsbc_client.token_service
    
    # Add a method to refresh the API key when token is refreshed
    original_generate = llm._generate
    
    def wrapped_generate(*args, **kwargs):
        """Wrap generate to ensure fresh token"""
        # Update API key before each generation
        fresh_token = hsbc_client.token_service.get_token()
        llm.openai_api_key = fresh_token
        return original_generate(*args, **kwargs)
    
    llm._generate = wrapped_generate
    
    logger.info("=" * 60)
    logger.info("âœ“ LangChain ChatOpenAI created with HSBC token management")
    logger.info("  Client replaced with HSBCOpenAIClient")
    logger.info("  Token will auto-refresh on 401 errors")
    logger.info("=" * 60)
    
    return llm
