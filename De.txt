"""
OpenAI API service for the legislation rules converter.
Updated to support HSBC authentication with httpx + truststore
"""
import logging
from typing import List, Union, Dict, Optional, Any
from openai import OpenAI
from langchain_core.messages import HumanMessage, SystemMessage, AIMessage

from ..config import Config

logger = logging.getLogger(__name__)


class OpenAIService:
    """Service for OpenAI API interactions with HSBC auth support."""

    def __init__(self, api_key: str = None, base_url: str = None, use_hsbc_auth: bool = None):
        """
        Initialize OpenAI service
        
        Args:
            api_key: OpenAI API key (defaults to Config.API_KEY, ignored if using HSBC)
            base_url: OpenAI API base URL (defaults to Config.BASE_URL)
            use_hsbc_auth: Whether to use HSBC authentication (defaults to Config.USE_HSBC_AUTH)
        """
        self.use_hsbc_auth = use_hsbc_auth if use_hsbc_auth is not None else Config.USE_HSBC_AUTH
        self.base_url = base_url or Config.BASE_URL
        
        logger.info(f"Initializing OpenAI Service:")
        logger.info(f"  Base URL: {self.base_url}")
        logger.info(f"  HSBC Auth: {self.use_hsbc_auth}")
        
        if self.use_hsbc_auth:
            from .hsbc_openai_client import create_hsbc_client
            
            logger.info("  Using HSBC authentication (httpx + truststore)")
            self.client = create_hsbc_client()
            self.api_key = "HSBC_MANAGED"
            
        else:
            self.api_key = api_key or Config.API_KEY
            
            if not self.api_key:
                raise ValueError("API key is required. Set OPENAI_API_KEY environment variable.")
            
            logger.info(f"  API Key: ***{self.api_key[-4:] if self.api_key else 'NOT SET'}")
            
            self.client = OpenAI(
                api_key=self.api_key,
                base_url=self.base_url
            )
        
        logger.info("âœ“ OpenAI client initialized")

    async def get_embeddings(self, texts: List[str]) -> List[List[float]]:
        """
        Generate embeddings using configured connection.
        
        Args:
            texts: List of text strings to embed
            
        Returns:
            List of embedding vectors
        """
        try:
            response = self.client.embeddings.create(
                model=Config.EMBEDDING_MODEL,
                input=texts,
                encoding_format="float"
            )
            embeddings = [data.embedding for data in response.data]
            logger.info(f"Generated {len(embeddings)} embeddings")
            return embeddings
        except Exception as e:
            logger.error(f"Error generating embeddings: {e}")
            
            if self.use_hsbc_auth and hasattr(self.client, '_refresh_token_and_headers'):
                logger.info("Attempting token refresh and retry...")
                self.client._refresh_token_and_headers()
                
                response = self.client.embeddings.create(
                    model=Config.EMBEDDING_MODEL,
                    input=texts,
                    encoding_format="float"
                )
                embeddings = [data.embedding for data in response.data]
                logger.info(f"Generated {len(embeddings)} embeddings after retry")
                return embeddings
            
            raise

    async def chat_completion(
        self, 
        messages: List[Union[Dict[str, str], SystemMessage, HumanMessage, AIMessage]],
        **kwargs
    ) -> str:
        """
        Generate chat completion with default settings.
        
        Args:
            messages: List of messages in the conversation
            **kwargs: Additional arguments for chat completion
            
        Returns:
            String response from the model
        """
        try:
            formatted_messages = self._format_messages(messages)
            
            if self.use_hsbc_auth and 'user' not in kwargs:
                kwargs['user'] = Config.HSBC_USER_ID
            
            response = self.client.chat.completions.create(
                model=Config.CHAT_MODEL,
                messages=formatted_messages,
                **kwargs
            )
            return response.choices[0].message.content
            
        except Exception as e:
            logger.error(f"Error in chat completion: {e}")
            
            if self.use_hsbc_auth and hasattr(self.client, '_refresh_token_and_headers'):
                logger.info("Attempting token refresh and retry...")
                self.client._refresh_token_and_headers()
                
                response = self.client.chat.completions.create(
                    model=Config.CHAT_MODEL,
                    messages=formatted_messages,
                    **kwargs
                )
                return response.choices[0].message.content
            
            raise

    async def get_completion(
        self,
        messages: List[Union[Dict[str, str], SystemMessage, HumanMessage, AIMessage]],
        **kwargs
    ) -> Any:
        """
        Generate chat completion with default settings.
        
        Args:
            messages: List of messages in the conversation
            **kwargs: Additional arguments for chat completion
            
        Returns:
            Response object with content attribute
        """
        try:
            formatted_messages = self._format_messages(messages)
            
            if self.use_hsbc_auth and 'user' not in kwargs:
                kwargs['user'] = Config.HSBC_USER_ID

            response = self.client.chat.completions.create(
                model=Config.CHAT_MODEL,
                messages=formatted_messages,
                **kwargs
            )
            
            class CompletionResponse:
                def __init__(self, content):
                    self.content = content
            
            return CompletionResponse(response.choices[0].message.content)
            
        except Exception as e:
            logger.error(f"Error in get_completion: {e}")
            
            if self.use_hsbc_auth and hasattr(self.client, '_refresh_token_and_headers'):
                logger.info("Attempting token refresh and retry...")
                self.client._refresh_token_and_headers()
                
                response = self.client.chat.completions.create(
                    model=Config.CHAT_MODEL,
                    messages=formatted_messages,
                    **kwargs
                )
                
                class CompletionResponse:
                    def __init__(self, content):
                        self.content = content
                
                return CompletionResponse(response.choices[0].message.content)
            
            raise
    
    def _format_messages(
        self, 
        messages: List[Union[Dict[str, str], SystemMessage, HumanMessage, AIMessage]]
    ) -> List[Dict[str, str]]:
        """
        Format messages to OpenAI API format.
        
        Args:
            messages: List of messages in various formats
            
        Returns:
            List of formatted message dicts
        """
        formatted_messages = []
        
        for msg in messages:
            if isinstance(msg, (SystemMessage, HumanMessage, AIMessage)):
                if isinstance(msg, SystemMessage):
                    formatted_messages.append({"role": "system", "content": msg.content})
                elif isinstance(msg, HumanMessage):
                    formatted_messages.append({"role": "user", "content": msg.content})
                elif isinstance(msg, AIMessage):
                    formatted_messages.append({"role": "assistant", "content": msg.content})
            elif isinstance(msg, dict):
                if msg.get("role") == "developer":
                    formatted_messages.append({"role": "system", "content": msg.get("content", "")})
                else:
                    formatted_messages.append(msg)
            else:
                formatted_messages.append({"role": "user", "content": str(msg)})
        
        return formatted_messages
    
    def get_client(self) -> OpenAI:
        """
        Get the underlying OpenAI client.
        
        Returns:
            OpenAI client instance (standard or HSBC)
        """
        return self.client
    
    def create_langchain_client(self):
        """
        Create a LangChain ChatOpenAI client with HSBC authentication.
        Only works when HSBC auth is enabled.
        
        Returns:
            ChatOpenAI instance configured for HSBC
        """
        if not self.use_hsbc_auth:
            raise ValueError("create_langchain_client only works with HSBC authentication enabled")
        
        from .hsbc_openai_client import create_langchain_client
        return create_langchain_client()
