from falkordb import FalkorDB
from app.config import settings
from typing import List, Dict, Any
import logging

logger = logging.getLogger(__name__)


class FalkorDBConnection:
    def __init__(self):
        self.client = None
        self.graph = None
        
    def connect(self):
        """Establish connection to FalkorDB"""
        try:
            self.client = FalkorDB(
                host=settings.FALKORDB_HOST,
                port=settings.FALKORDB_PORT
            )
            self.graph = self.client.select_graph(settings.FALKORDB_GRAPH_NAME)
            logger.info(f"Connected to FalkorDB: {settings.FALKORDB_GRAPH_NAME}")
        except Exception as e:
            logger.error(f"Failed to connect to FalkorDB: {e}")
            raise
    
    def disconnect(self):
        """Close FalkorDB connection"""
        if self.client:
            self.client.close()
            logger.info("Disconnected from FalkorDB")
    
    def execute_query(self, query: str, params: Dict[str, Any] = None) -> List[Any]:
        """Execute Cypher query and return results"""
        try:
            if params:
                result = self.graph.query(query, params)
            else:
                result = self.graph.query(query)
            return result.result_set
        except Exception as e:
            logger.error(f"Query execution failed: {e}")
            logger.error(f"Query: {query}")
            raise
    
    def get_all_lineage(self) -> Dict[str, Any]:
        """Retrieve complete lineage graph"""
        query = """
        MATCH (c:Country)
        OPTIONAL MATCH (c)-[:HOSTS]->(d:Database)
        OPTIONAL MATCH (d)-[:CONTAINS]->(a:Attribute)
        OPTIONAL MATCH (a1:Attribute)-[t:TRANSFERS_TO]->(a2:Attribute)
        RETURN c, d, a, a1, t, a2
        """
        return self.execute_query(query)
    
    def get_lineage_by_country(self, country_code: str) -> Dict[str, Any]:
        """Retrieve lineage starting from a specific country"""
        query = """
        MATCH (c:Country {code: $country_code})
        OPTIONAL MATCH (c)-[:HOSTS]->(d:Database)
        OPTIONAL MATCH (d)-[:CONTAINS]->(a:Attribute)
        OPTIONAL MATCH (a)-[t:TRANSFERS_TO*1..5]->(target:Attribute)
        RETURN c, d, a, t, target
        """
        return self.execute_query(query, {"country_code": country_code})
    
    def get_transfer_path(self, start_attribute: str, end_attribute: str) -> List[Any]:
        """Get transfer path between two attributes"""
        query = """
        MATCH path = (start:Attribute {name: $start_attr})-[:TRANSFERS_TO*1..10]->(end:Attribute {name: $end_attr})
        RETURN path
        LIMIT 10
        """
        return self.execute_query(query, {
            "start_attr": start_attribute,
            "end_attr": end_attribute
        })
    
    def get_attribute_lineage(self, attribute_name: str) -> List[Any]:
        """Get complete lineage for a specific attribute"""
        query = """
        MATCH (a:Attribute {name: $attr_name})
        MATCH (a)<-[:CONTAINS]-(d:Database)<-[:HOSTS]-(c:Country)
        OPTIONAL MATCH path = (a)-[:TRANSFERS_TO*0..10]->(target:Attribute)
        OPTIONAL MATCH (target)<-[:CONTAINS]-(td:Database)<-[:HOSTS]-(tc:Country)
        RETURN c, d, a, path, target, td, tc
        """
        return self.execute_query(query, {"attr_name": attribute_name})


# Global database connection instance
db = FalkorDBConnection()
