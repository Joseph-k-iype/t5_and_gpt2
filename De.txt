graph TB
    subgraph "Application Layer"
        APP1[Data API Service<br/>FastAPI]
        APP2[Graph Service<br/>FalkorDB Client]
        APP3[Compute Provisioner]
        APP4[Policy Evaluator]
    end

    subgraph "Database Layer"
        FALKORDB[(FalkorDB)]
        FUSEKI[Apache Fuseki]
        POSTGRES[(PostgreSQL)]
        REDIS[(Redis)]
    end

    subgraph "Metrics Collection - Prometheus"
        PROM_SERVER[Prometheus Server<br/>Time-Series Database]
        
        subgraph "Exporters"
            NODE_EXP[Node Exporter<br/>Host Metrics]
            KUBE_STATE[kube-state-metrics<br/>K8s Objects]
            CADVISOR[cAdvisor<br/>Container Metrics]
            FALKOR_EXP[FalkorDB Exporter<br/>Redis Metrics]
            FUSEKI_EXP[Fuseki JMX Exporter<br/>SPARQL Metrics]
            SQL_EXP[Cloud SQL Exporter<br/>DB Metrics]
            CUSTOM_EXP[Custom App Metrics<br/>Prometheus Client]
        end
        
        NODE_EXP --> PROM_SERVER
        KUBE_STATE --> PROM_SERVER
        CADVISOR --> PROM_SERVER
        FALKOR_EXP --> PROM_SERVER
        FUSEKI_EXP --> PROM_SERVER
        SQL_EXP --> PROM_SERVER
        CUSTOM_EXP --> PROM_SERVER
        
        FALKORDB --> FALKOR_EXP
        FUSEKI --> FUSEKI_EXP
        POSTGRES --> SQL_EXP
        APP1 --> CUSTOM_EXP
        APP2 --> CUSTOM_EXP
    end

    subgraph "Logging - Loki"
        LOKI_SERVER[Loki Server<br/>Log Aggregation]
        
        PROMTAIL[Promtail DaemonSet<br/>Log Shipper]
        
        LOG_SOURCES[Log Sources:<br/>- Pod stdout/stderr<br/>- Application logs<br/>- Audit logs<br/>- System logs]
        
        LOG_SOURCES --> PROMTAIL
        PROMTAIL --> LOKI_SERVER
        
        APP1 -.-> LOG_SOURCES
        APP2 -.-> LOG_SOURCES
        FALKORDB -.-> LOG_SOURCES
        FUSEKI -.-> LOG_SOURCES
    end

    subgraph "Tracing - Tempo"
        TEMPO_SERVER[Tempo Server<br/>Trace Storage]
        
        OTEL_COLLECTOR[OpenTelemetry Collector<br/>Trace Receiver]
        
        TRACE_SOURCES[Instrumented Apps:<br/>- OpenTelemetry SDK<br/>- Context Propagation<br/>- Span Creation]
        
        TRACE_SOURCES --> OTEL_COLLECTOR
        OTEL_COLLECTOR --> TEMPO_SERVER
        
        APP1 -.-> TRACE_SOURCES
        APP2 -.-> TRACE_SOURCES
        APP3 -.-> TRACE_SOURCES
    end

    subgraph "Visualization - Grafana"
        GRAF_UI[Grafana UI<br/>Port 3000]
        
        subgraph "Dashboards"
            DASH1[Infrastructure Dashboard<br/>CPU, Memory, Disk, Network]
            DASH2[Database Dashboard<br/>FalkorDB, Fuseki, PostgreSQL]
            DASH3[Application Dashboard<br/>API Latency, Error Rate, Throughput]
            DASH4[Cost Dashboard<br/>Per-Team Resource Usage]
            DASH5[Semantic Web Dashboard<br/>Graph Size, Query Performance]
        end
        
        GRAF_UI --> DASH1
        GRAF_UI --> DASH2
        GRAF_UI --> DASH3
        GRAF_UI --> DASH4
        GRAF_UI --> DASH5
        
        PROM_SERVER --> GRAF_UI
        LOKI_SERVER --> GRAF_UI
        TEMPO_SERVER --> GRAF_UI
    end

    subgraph "Alerting - Alertmanager"
        ALERT_MGR[Alertmanager<br/>Alert Routing & Deduplication]
        
        ALERT_RULES[Alert Rules:<br/>- HighCPUUsage > 80%<br/>- HighMemoryUsage > 85%<br/>- FalkorDBDown<br/>- HighQueryLatency<br/>- HighErrorRate > 5%]
        
        ALERT_CHANNELS[Notification Channels:<br/>- Slack<br/>- Email<br/>- PagerDuty<br/>- Webhook]
        
        PROM_SERVER --> ALERT_RULES
        ALERT_RULES --> ALERT_MGR
        ALERT_MGR --> ALERT_CHANNELS
    end

    subgraph "GCP Native Observability"
        CLOUD_MON[Cloud Monitoring<br/>Metrics API]
        CLOUD_LOG[Cloud Logging<br/>Logs API]
        OPS_AGENT[Ops Agent<br/>On Compute Engine VMs]
        
        OPS_AGENT --> CLOUD_MON
        OPS_AGENT --> CLOUD_LOG
        
        GKE_METRICS[GKE System Metrics<br/>Auto-collected]
        SQL_METRICS[Cloud SQL Metrics<br/>Auto-collected]
        
        GKE_METRICS --> CLOUD_MON
        SQL_METRICS --> CLOUD_MON
        
        CLOUD_MON -.-> GRAF_UI
        CLOUD_LOG -.-> LOKI_SERVER
    end

    subgraph "Policy Management - OPA"
        OPA_SERVER[OPA Server<br/>Policy Decision Point]
        
        POLICY_BUNDLE[Policy Bundle<br/>Rego Files]
        
        subgraph "Policy Types"
            POL_COMPUTE[Compute Policies:<br/>- Team GPU quota<br/>- User CPU limits<br/>- Cost budgets<br/>- Spot enforcement]
            
            POL_DATA[Data Access Policies:<br/>- PII protection<br/>- Classification rules<br/>- Approval requirements<br/>- Audit logging]
            
            POL_K8S[K8s Admission Policies:<br/>- Resource limits<br/>- Security context<br/>- Image policies<br/>- Namespace quotas]
        end
        
        POLICY_BUNDLE --> OPA_SERVER
        POL_COMPUTE --> POLICY_BUNDLE
        POL_DATA --> POLICY_BUNDLE
        POL_K8S --> POLICY_BUNDLE
        
        OPA_DATA_STORE[(OPA Data Store:<br/>- Team quotas<br/>- Current usage<br/>- User roles<br/>- Dataset metadata)]
        
        OPA_DATA_STORE --> OPA_SERVER
    end

    subgraph "Policy Enforcement Points"
        PEP1[Compute Provisioner<br/>Pre-provisioning Check]
        PEP2[Data API<br/>Query Authorization]
        PEP3[K8s API Server<br/>Admission Webhook]
        
        APP3 --> PEP1
        PEP1 --> OPA_SERVER
        
        APP1 --> PEP2
        PEP2 --> OPA_SERVER
        
        PEP3 --> OPA_SERVER
    end

    subgraph "Policy Evaluation Flow"
        REQ[User Request<br/>GPU: 2x A100<br/>Team: data-science]
        
        CHECK{OPA Evaluation}
        
        ALLOW[Allow:<br/>Provision Resources<br/>Log Decision]
        
        DENY[Deny:<br/>Return 403<br/>Log Violation]
        
        AUDIT[Audit Log<br/>PostgreSQL]
        
        REQ --> PEP1
        PEP1 --> CHECK
        CHECK -->|Quota OK| ALLOW
        CHECK -->|Quota Exceeded| DENY
        ALLOW --> AUDIT
        DENY --> AUDIT
    end

    subgraph "Metrics Examples"
        MET1["# Infrastructure
node_cpu_seconds_total
container_memory_working_set_bytes
kube_pod_status_phase"]
        
        MET2["# FalkorDB
falkordb_commands_processed_total
falkordb_connected_clients
falkordb_graph_nodes_count
falkordb_query_duration_seconds"]
        
        MET3["# Fuseki
fuseki_requests_total
fuseki_query_duration_seconds
fuseki_triple_count
fuseki_dataset_size_bytes"]
        
        MET4["# Application
http_requests_total{status='200'}
http_request_duration_seconds
http_requests_in_flight
api_errors_total"]
        
        MET1 --> PROM_SERVER
        MET2 --> PROM_SERVER
        MET3 --> PROM_SERVER
        MET4 --> PROM_SERVER
    end

    subgraph "Log Query Examples"
        LOG1["{namespace='production'} 
|= 'error' 
| json 
| level='ERROR'"]
        
        LOG2["{job='falkordb'} 
|~ 'slow query' 
| json 
| duration > 1000"]
        
        LOG3["{app='data-api'} 
|= 'status=5' 
| line_format '{{.user_id}}: {{.error}}'"]
        
        LOG1 -.-> LOKI_SERVER
        LOG2 -.-> LOKI_SERVER
        LOG3 -.-> LOKI_SERVER
    end

    subgraph "Cost Tracking Integration"
        COST_METRICS[Cost Metrics:<br/>- Resource usage by team<br/>- GPU hours consumed<br/>- Storage utilization<br/>- API request counts]
        
        COST_DB[(PostgreSQL<br/>compute_requests<br/>cost tracking)]
        
        COST_DASHBOARD[Cost Dashboard<br/>Real-time Spend<br/>Budget Alerts]
        
        PROM_SERVER --> COST_METRICS
        COST_METRICS --> COST_DB
        COST_DB --> COST_DASHBOARD
        COST_DASHBOARD --> GRAF_UI
    end

    subgraph "Incident Response Flow"
        INCIDENT[Alert Triggered<br/>HighErrorRate > 5%]
        
        NOTIFY[Notify On-Call<br/>PagerDuty]
        
        INVESTIGATE[Investigate:<br/>- Check Grafana Dashboard<br/>- Query Loki for errors<br/>- View traces in Tempo<br/>- Check OPA policy logs]
        
        MITIGATE[Mitigate:<br/>- Scale resources<br/>- Restart services<br/>- Update policies<br/>- Apply hotfix]
        
        POSTMORTEM[Post-mortem:<br/>- Document incident<br/>- Update runbooks<br/>- Improve monitoring]
        
        ALERT_MGR --> INCIDENT
        INCIDENT --> NOTIFY
        NOTIFY --> INVESTIGATE
        INVESTIGATE --> MITIGATE
        MITIGATE --> POSTMORTEM
    end

    %% Styling
    style PROM_SERVER fill:#E6522C,stroke:#333,stroke-width:3px
    style LOKI_SERVER fill:#34A853,stroke:#333,stroke-width:3px
    style TEMPO_SERVER fill:#FBBC04,stroke:#333,stroke-width:3px
    style GRAF_UI fill:#F46800,stroke:#333,stroke-width:3px
    style OPA_SERVER fill:#7D64FF,stroke:#333,stroke-width:3px
    style ALERT_MGR fill:#EA4335,stroke:#333,stroke-width:3px
    style ALLOW fill:#34A853
    style DENY fill:#EA4335
    style COST_DASHBOARD fill:#4285F4
