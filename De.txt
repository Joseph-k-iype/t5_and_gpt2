CREATE SCHEMA IF NOT EXISTS ai_stitching_platform;

-- Create extension for vector operations
CREATE EXTENSION IF NOT EXISTS vector;

-- Create tables in the ai_stitching_platform schema
SET search_path TO ai_stitching_platform, public;

-- Business terms table
CREATE TABLE IF NOT EXISTS business_terms (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT NOT NULL,
    embedding vector(1536) NOT NULL,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes
CREATE INDEX IF NOT EXISTS business_terms_embedding_idx 
ON business_terms 
USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

CREATE INDEX IF NOT EXISTS business_terms_name_idx 
ON business_terms 
USING btree (name);

-- Jobs table
CREATE TABLE IF NOT EXISTS jobs (
    id VARCHAR(255) PRIMARY KEY,
    job_type VARCHAR(50) NOT NULL,
    status VARCHAR(50) NOT NULL,
    data JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create index on job_type and status
CREATE INDEX IF NOT EXISTS jobs_type_status_idx 
ON jobs 
USING btree (job_type, status);

-- System stats table
CREATE TABLE IF NOT EXISTS system_stats (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    cpu_usage FLOAT NOT NULL,
    memory_usage FLOAT NOT NULL,
    db_size BIGINT NOT NULL,
    active_connections INTEGER NOT NULL,
    enhancement_jobs_count INTEGER NOT NULL,
    tagging_jobs_count INTEGER NOT NULL,
    pbt_tagging_jobs_count INTEGER NOT NULL DEFAULT 0
);

-- Create index on timestamp
CREATE INDEX IF NOT EXISTS system_stats_timestamp_idx 
ON system_stats 
USING btree (timestamp);

-- Create sample data for testing (optional)
INSERT INTO business_terms (id, name, description, embedding, metadata)
VALUES
    ('sample_term_1', 'sample term', 'This is a sample business term for testing.', '[0.1,0.2,0.3]'::vector(1536), '{"cdm": "Sample"}'),
    ('sample_term_2', 'test term', 'This is another test business term.', '[0.2,0.3,0.4]'::vector(1536), '{"cdm": "Test"}')
ON CONFLICT (id) DO NOTHING;
