from pptx import Presentation
from pptx.util import Inches, Pt

# Helper function to trim the URL to show only the part after "ISO"
def trim_url(url):
    iso_index = url.find("ISO")
    return url[iso_index:] if iso_index != -1 else url

# Updated populate_slide_10 function without hyperlinks, only displaying trimmed URLs
def populate_slide_10(slide, df_slide10):
    delete_existing_tables(slide)
    headers = ["Issue", "Summary", "Issues (URL)"]
    table = create_table(slide, headers, num_rows=1 + len(df_slide10), top_position=Inches(1))

    # Populate the table with data and display trimmed URLs in the "Issues (URL)" column
    for row_idx, row_data in enumerate(df_slide10.itertuples(index=False), start=1):
        # Set Issue and Summary cells
        table.cell(row_idx, 0).text = str(row_data.Issue)
        table.cell(row_idx, 1).text = str(row_data.Summary)
        
        # Trim and set the Issues (URL) cell text without hyperlink
        issue_url = str(row_data.issueUrl)  # Assuming `issueUrl` is the column name in the DataFrame
        table.cell(row_idx, 2).text = trim_url(issue_url)

# Example usage within create_report function
def create_report(template_path, output_folder, report_value):
    try:
        prs = Presentation(template_path)
        # Generate data for Slide 10
        df_slide10 = generate_slide10_data(report_value)
        
        # Create folder for report
        report_name = "example_report"  # Replace with actual logic to get report name
        report_folder = os.path.join(output_folder, report_name)
        os.makedirs(report_folder, exist_ok=True)

        # Populate Slide 10 with trimmed URLs as plain text
        if len(prs.slides) > 9:
            populate_slide_10(prs.slides[9], df_slide10)

        # Save the PowerPoint
        pptx_path = os.path.join(report_folder, f"{report_name}.pptx")
        prs.save(pptx_path)
        print(f"PowerPoint saved as {pptx_path}")

    except Exception as e:
        print(f"Error processing report URL {report_value}: {e}")
