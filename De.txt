"""
Legal Summary Word Document Generator
Generates formatted Word documents from legal analysis
"""

from typing import Dict, List, Any, Optional
from docx import Document
from docx.shared import Pt, RGBColor, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.enum.style import WD_STYLE_TYPE
from datetime import datetime
import os


class LegalSummaryGenerator:
    """
    Generates professional Word documents from legal document analysis
    """
    
    def __init__(self, output_dir: str = "output/legal_summaries"):
        self.output_dir = output_dir
        os.makedirs(output_dir, exist_ok=True)
    
    def create_document(self, analysis: Dict[str, Any]) -> Document:
        """Create a formatted Word document from analysis"""
        doc = Document()
        
        # Set up styles
        self._setup_styles(doc)
        
        # Add content
        self._add_title(doc, analysis)
        self._add_metadata(doc, analysis)
        self._add_description(doc, analysis)
        self._add_actions_section(doc, analysis)
        self._add_duties_section(doc, analysis)
        self._add_constraints_section(doc, analysis)
        self._add_classification_section(doc, analysis)
        self._add_footer(doc, analysis)
        
        return doc
    
    def _setup_styles(self, doc: Document):
        """Set up custom styles for the document"""
        styles = doc.styles
        
        # Main Title style
        if 'CustomTitle' not in styles:
            title_style = styles.add_style('CustomTitle', WD_STYLE_TYPE.PARAGRAPH)
            title_style.font.name = 'Calibri'
            title_style.font.size = Pt(24)
            title_style.font.bold = True
            title_style.font.color.rgb = RGBColor(0, 51, 102)  # Dark blue
        
        # Heading 1 style modification
        heading1 = styles['Heading 1']
        heading1.font.name = 'Calibri'
        heading1.font.size = Pt(16)
        heading1.font.color.rgb = RGBColor(0, 51, 102)
        
        # Heading 2 style modification
        heading2 = styles['Heading 2']
        heading2.font.name = 'Calibri'
        heading2.font.size = Pt(14)
        heading2.font.color.rgb = RGBColor(0, 102, 204)
        
        # Normal text
        normal = styles['Normal']
        normal.font.name = 'Calibri'
        normal.font.size = Pt(11)
    
    def _add_title(self, doc: Document, analysis: Dict[str, Any]):
        """Add document title"""
        metadata = analysis.get("metadata", {})
        rule_name = metadata.get("rule_name", "Legal Rule Analysis")
        
        title = doc.add_paragraph(rule_name, style='CustomTitle')
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        # Add subtitle with jurisdiction
        jurisdiction = metadata.get("jurisdiction", "General")
        subtitle = doc.add_paragraph(f"Jurisdiction: {jurisdiction}")
        subtitle.alignment = WD_ALIGN_PARAGRAPH.CENTER
        subtitle.runs[0].font.size = Pt(12)
        subtitle.runs[0].font.italic = True
        subtitle.runs[0].font.color.rgb = RGBColor(80, 80, 80)
        
        doc.add_paragraph()  # Spacing
    
    def _add_metadata(self, doc: Document, analysis: Dict[str, Any]):
        """Add metadata section"""
        metadata = analysis.get("metadata", {})
        
        # Create a table for metadata
        table = doc.add_table(rows=0, cols=2)
        table.style = 'Light Grid Accent 1'
        
        def add_metadata_row(label: str, value: str):
            row = table.add_row()
            label_cell = row.cells[0]
            value_cell = row.cells[1]
            
            label_cell.text = label
            value_cell.text = value
            
            # Make label bold
            label_cell.paragraphs[0].runs[0].font.bold = True
        
        add_metadata_row("Rule Name", metadata.get("rule_name", "N/A"))
        add_metadata_row("Jurisdiction", metadata.get("jurisdiction", "N/A"))
        add_metadata_row("Analysis Date", datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
        add_metadata_row("Confidence Level", analysis.get("confidence", "medium").upper())
        
        if metadata.get("enterprise_context"):
            ent_ctx = metadata["enterprise_context"]
            if ent_ctx.get("organization"):
                add_metadata_row("Organization", ent_ctx["organization"])
            if ent_ctx.get("internal_tools"):
                add_metadata_row("Internal Tools", ", ".join(ent_ctx["internal_tools"]))
        
        doc.add_paragraph()  # Spacing
    
    def _add_description(self, doc: Document, analysis: Dict[str, Any]):
        """Add description section"""
        doc.add_heading("Description of the Rule", level=1)
        
        description = analysis.get("description", "No description provided.")
        para = doc.add_paragraph(description)
        para.style = 'Normal'
        
        # Add any additional notes
        notes = analysis.get("notes")
        if notes:
            doc.add_paragraph()
            note_para = doc.add_paragraph()
            note_para.add_run("Note: ").bold = True
            note_para.add_run(notes).italic = True
        
        doc.add_paragraph()  # Spacing
    
    def _add_actions_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add actions section"""
        doc.add_heading("Actions", level=1)
        
        # User actions
        doc.add_heading("Actions by User", level=2)
        user_actions = analysis.get("user_actions", [])
        
        if user_actions:
            for action in user_actions:
                para = doc.add_paragraph(action, style='List Bullet')
        else:
            doc.add_paragraph("No user actions specified.", style='Normal')
        
        doc.add_paragraph()  # Spacing
        
        # System actions
        doc.add_heading("Actions by System", level=2)
        system_actions = analysis.get("system_actions", [])
        
        if system_actions:
            for action in system_actions:
                para = doc.add_paragraph(action, style='List Bullet')
        else:
            doc.add_paragraph("No system actions specified.", style='Normal')
        
        doc.add_paragraph()  # Spacing
    
    def _add_duties_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add duties section"""
        doc.add_heading("Duties and Obligations", level=1)
        
        # User duties
        doc.add_heading("Duties by User", level=2)
        user_duties = analysis.get("user_duties", [])
        
        if user_duties:
            for duty in user_duties:
                para = doc.add_paragraph(duty, style='List Bullet')
        else:
            doc.add_paragraph("No user duties specified.", style='Normal')
        
        doc.add_paragraph()  # Spacing
        
        # System duties
        doc.add_heading("Duties by System", level=2)
        system_duties = analysis.get("system_duties", [])
        
        if system_duties:
            for duty in system_duties:
                para = doc.add_paragraph(duty, style='List Bullet')
        else:
            doc.add_paragraph("No system duties specified.", style='Normal')
        
        doc.add_paragraph()  # Spacing
    
    def _add_constraints_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add constraints section"""
        doc.add_heading("Applicable Constraints and Conditions", level=1)
        
        constraints = analysis.get("constraints", [])
        
        if not constraints:
            doc.add_paragraph("No specific constraints identified.", style='Normal')
        else:
            # Group constraints by type
            constraint_groups = {}
            for constraint in constraints:
                if isinstance(constraint, dict):
                    constraint_type = constraint.get("type", "general")
                    description = constraint.get("description", str(constraint))
                else:
                    constraint_type = "general"
                    description = str(constraint)
                
                if constraint_type not in constraint_groups:
                    constraint_groups[constraint_type] = []
                constraint_groups[constraint_type].append(description)
            
            # Display grouped constraints
            for constraint_type, descriptions in constraint_groups.items():
                doc.add_heading(constraint_type.replace("_", " ").title(), level=2)
                
                for desc in descriptions:
                    para = doc.add_paragraph(desc, style='List Bullet')
        
        doc.add_paragraph()  # Spacing
    
    def _add_classification_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add classification section"""
        doc.add_heading("Rule Classification", level=1)
        
        rule_type = analysis.get("rule_type", "Not classified")
        
        # Create a highlighted box for classification
        para = doc.add_paragraph()
        
        para.add_run("Classification Type: ").bold = True
        
        rule_run = para.add_run(rule_type.upper())
        rule_run.bold = True
        rule_run.font.size = Pt(12)
        
        # Color code based on type
        if "permission" in rule_type.lower():
            rule_run.font.color.rgb = RGBColor(0, 128, 0)  # Green
        elif "prohibition" in rule_type.lower():
            rule_run.font.color.rgb = RGBColor(192, 0, 0)  # Red
        elif "obligation" in rule_type.lower():
            rule_run.font.color.rgb = RGBColor(0, 0, 192)  # Blue
        else:
            rule_run.font.color.rgb = RGBColor(128, 128, 0)  # Olive for combination
        
        # Add explanation
        doc.add_paragraph()
        explanations = {
            "permission": "This rule grants permission to perform certain actions under specified conditions.",
            "prohibition": "This rule prohibits specific actions and must be strictly enforced.",
            "obligation": "This rule requires mandatory actions or duties to be fulfilled.",
            "combination": "This rule combines elements of permissions, prohibitions, and/or obligations."
        }
        
        explanation = explanations.get(rule_type.lower(), "This rule requires careful interpretation.")
        doc.add_paragraph(explanation, style='Normal')
        
        doc.add_paragraph()  # Spacing
    
    def _add_footer(self, doc: Document, analysis: Dict[str, Any]):
        """Add footer with additional information"""
        doc.add_page_break()
        
        doc.add_heading("Additional Information", level=1)
        
        # Add level-specific analyses if available
        level_analyses = analysis.get("level_analyses")
        if level_analyses:
            doc.add_paragraph("This analysis synthesizes information from multiple documentation levels:")
            
            for level_name, level_data in level_analyses.items():
                level_num = level_name.replace("level_", "Level ")
                doc.add_paragraph(f"{level_num}: Analyzed", style='List Bullet')
        
        # Add disclaimer
        doc.add_paragraph()
        disclaimer = doc.add_paragraph()
        disclaimer.add_run("Legal Disclaimer: ").bold = True
        disclaimer.add_run(
            "This document is a summary generated for legal review purposes. "
            "It should be reviewed by qualified legal professionals before implementation. "
            "The analysis is based on the documents provided and may require updates "
            "as regulations evolve."
        )
        disclaimer.runs[-1].font.italic = True
        disclaimer.runs[-1].font.size = Pt(9)
        disclaimer.runs[-1].font.color.rgb = RGBColor(100, 100, 100)
        
        # Add generation timestamp
        doc.add_paragraph()
        timestamp = doc.add_paragraph(
            f"Document generated on {datetime.now().strftime('%Y-%m-%d at %H:%M:%S')}"
        )
        timestamp.alignment = WD_ALIGN_PARAGRAPH.CENTER
        timestamp.runs[0].font.size = Pt(9)
        timestamp.runs[0].font.color.rgb = RGBColor(150, 150, 150)
    
    def save_document(
        self,
        doc: Document,
        rule_name: str,
        jurisdiction: str,
        filename: Optional[str] = None
    ) -> str:
        """Save the document to file"""
        if filename is None:
            # Generate filename from rule name and jurisdiction
            safe_rule_name = "".join(c if c.isalnum() or c in (' ', '_') else '_' for c in rule_name)
            safe_rule_name = safe_rule_name.replace(' ', '_')
            safe_jurisdiction = jurisdiction.replace(' ', '_')
            
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"{safe_rule_name}_{safe_jurisdiction}_{timestamp}.docx"
        
        filepath = os.path.join(self.output_dir, filename)
        doc.save(filepath)
        
        return filepath
    
    def generate_legal_summary(
        self,
        analysis: Dict[str, Any],
        filename: Optional[str] = None
    ) -> str:
        """
        Main method to generate a complete legal summary document
        
        Args:
            analysis: Dictionary containing the legal analysis
            filename: Optional custom filename
            
        Returns:
            Path to the saved document
        """
        doc = self.create_document(analysis)
        
        metadata = analysis.get("metadata", {})
        rule_name = metadata.get("rule_name", "Legal_Rule")
        jurisdiction = metadata.get("jurisdiction", "General")
        
        filepath = self.save_document(doc, rule_name, jurisdiction, filename)
        
        return filepath
    
    def generate_batch_summaries(
        self,
        analyses: Dict[str, Dict[str, Any]]
    ) -> List[str]:
        """
        Generate multiple legal summary documents from a batch of analyses
        
        Args:
            analyses: Dictionary mapping rule names to their analyses
            
        Returns:
            List of paths to saved documents
        """
        filepaths = []
        
        for rule_name, analysis in analyses.items():
            try:
                filepath = self.generate_legal_summary(analysis)
                filepaths.append(filepath)
                print(f"✓ Generated summary for: {rule_name}")
            except Exception as e:
                print(f"✗ Error generating summary for {rule_name}: {str(e)}")
        
        return filepaths
    
    def create_index_document(
        self,
        analyses: Dict[str, Dict[str, Any]],
        output_filename: str = "Legal_Summaries_Index.docx"
    ) -> str:
        """
        Create an index document listing all analyzed rules
        
        Args:
            analyses: Dictionary mapping rule names to their analyses
            output_filename: Name for the index document
            
        Returns:
            Path to the saved index document
        """
        doc = Document()
        self._setup_styles(doc)
        
        # Title
        title = doc.add_paragraph("Legal Rules Summary Index", style='CustomTitle')
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        subtitle = doc.add_paragraph(f"Generated on {datetime.now().strftime('%Y-%m-%d')}")
        subtitle.alignment = WD_ALIGN_PARAGRAPH.CENTER
        subtitle.runs[0].font.size = Pt(12)
        subtitle.runs[0].font.italic = True
        
        doc.add_paragraph()
        
        # Summary statistics
        doc.add_heading("Summary Statistics", level=1)
        doc.add_paragraph(f"Total Rules Analyzed: {len(analyses)}")
        
        # Count by type
        type_counts = {}
        for analysis in analyses.values():
            rule_type = analysis.get("rule_type", "unknown")
            type_counts[rule_type] = type_counts.get(rule_type, 0) + 1
        
        if type_counts:
            doc.add_paragraph("Rules by Type:")
            for rule_type, count in type_counts.items():
                doc.add_paragraph(f"{rule_type.title()}: {count}", style='List Bullet')
        
        doc.add_paragraph()
        
        # Rules list
        doc.add_heading("Rules Analyzed", level=1)
        
        # Create table
        table = doc.add_table(rows=1, cols=4)
        table.style = 'Light Grid Accent 1'
        
        # Header row
        header_cells = table.rows[0].cells
        header_cells[0].text = "Rule Name"
        header_cells[1].text = "Jurisdiction"
        header_cells[2].text = "Type"
        header_cells[3].text = "Confidence"
        
        for cell in header_cells:
            cell.paragraphs[0].runs[0].font.bold = True
        
        # Data rows
        for rule_name, analysis in analyses.items():
            metadata = analysis.get("metadata", {})
            row = table.add_row()
            
            row.cells[0].text = rule_name
            row.cells[1].text = metadata.get("jurisdiction", "N/A")
            row.cells[2].text = analysis.get("rule_type", "N/A").title()
            row.cells[3].text = analysis.get("confidence", "medium").upper()
        
        # Save
        filepath = os.path.join(self.output_dir, output_filename)
        doc.save(filepath)
        
        return filepath
