"""
Advanced Prompting Strategies for Legal Document Analysis
COMPLETE VERSION with all methods
Location: src/prompting/advanced_strategies.py
"""
from typing import Optional, Dict, Any


class AdvancedPromptingStrategies:
    """Advanced prompting strategies for legal document analysis"""
    
    def __init__(self, rule_name: str, jurisdiction: str):
        self.rule_name = rule_name
        self.jurisdiction = jurisdiction
    
    def get_complete_extraction_prompt(
        self,
        chunk_text: str,
        chunk_id: int,
        level: int,
        enterprise_context: Optional[Dict[str, Any]]
    ) -> str:
        """Get complete extraction prompt with all requirements"""
        
        level_desc = self._get_level_description(level)
        enterprise_section = ""
        if enterprise_context:
            org = enterprise_context.get("organization", "")
            tools = enterprise_context.get("internal_tools", [])
            if org or tools:
                enterprise_section = f"\n\nENTERPRISE CONTEXT:\n- Organization: {org}\n- Internal Tools: {', '.join(tools)}"
        
        return f"""You are analyzing legal/regulatory text for {self.rule_name} in {self.jurisdiction}.

DOCUMENT LEVEL: {level_desc}
CHUNK ID: {chunk_id}{enterprise_section}

TEXT TO ANALYZE:
{chunk_text}

EXTRACTION REQUIREMENTS:

Extract the following in valid JSON format:

1. RULE DESCRIPTION (MANDATORY):
   - "description": Comprehensive summary in simple, clear English (minimum 100 chars)
   - Must explain what is required/prohibited/allowed
   - NO document structure references (like "section 2.3" or "the guidance states")
   - Use simple language: "Organizations must..." not "The document requires..."

2. CITATIONS (MANDATORY - minimum 3):
   - Each citation must have:
     * "text": EXACT VERBATIM quote from above text (20-200 chars)
     * "reasoning": Why this quote is relevant (minimum 30 chars)
     * "level": {level}
   - Citations must be EXACT matches to the text above
   - Every extracted requirement must have supporting citations

3. DATA ACTIONS (extract ALL found):
   - "type": Use ONLY: "data_sharing_and_access", "data_storage_and_hosting", or "data_usage"
   - "description": What data action is required in simple English (minimum 30 chars)
   - "citations": List of citation texts supporting this action
   - "thought_process": Detailed reasoning for extracting this action (minimum 50 chars)

4. CONSTRAINTS (extract ALL found):
   - "type": Type of constraint (temporal, geographic, purpose, etc.)
   - "description": What the constraint requires in simple English (minimum 40 chars)
   - "left_operand": What is being constrained
   - "operator": Comparison operator (eq, neq, lt, gt, lte, gte, in, contains)
   - "right_operand": Value or condition
   - "scope": Scope of constraint
   - "citations": List of citation texts supporting this constraint
   - "thought_process": Detailed reasoning (minimum 50 chars)

5. USER EVIDENCE (what users must/can/cannot do):
   - "description": What evidence users must provide or actions they take (minimum 40 chars)
   - "citations": List of citation texts supporting this evidence
   - "thought_process": Detailed reasoning (minimum 50 chars)
   - Focus on individual user actions, not organizational requirements

6. SYSTEM EVIDENCE (what systems must implement):
   - "description": What systems must implement or provide (minimum 40 chars)
   - "citations": List of citation texts supporting this evidence
   - "thought_process": Detailed reasoning (minimum 50 chars)
   - Focus on technical/system implementations

7. ENTERPRISE POLICIES (if Level 3 only):
   - "policy_name": Name of the enterprise-specific policy
   - "description": What the policy requires (minimum 50 chars)
   - "organization": Organization name
   - "applies_to": List of who it applies to
   - "internal_tools": List of internal tools mentioned
   - "thought_process": How this differs from legal requirements (minimum 50 chars)

8. CLASSIFICATION (MANDATORY):
   - "classification": Either "condition" OR "restriction"
     * "condition" = Allowed under certain conditions
     * "restriction" = Prohibited or restricted
   - "classification_reasoning": Detailed explanation (minimum 50 chars)

CRITICAL QUALITY REQUIREMENTS:
✓ EVERY item has citations from the text above
✓ EVERY citation is VERBATIM from the text (exact match)
✓ EVERY item has thought_process (minimum 50 chars)
✓ Descriptions are COMPLETE sentences in simple English
✓ NO document structure references (no "section 2", "the document", etc.)
✓ NO truncation - write full descriptions
✓ NO placeholders or "..."
✓ Extract ONLY what is EXPLICITLY stated in the text

Return ONLY valid JSON with this structure:
{{
  "description": "...",
  "citations": [
    {{"text": "exact quote", "reasoning": "why relevant", "level": {level}}}
  ],
  "data_actions": [
    {{"type": "data_usage", "description": "...", "citations": [...], "thought_process": "..."}}
  ],
  "constraints": [
    {{"type": "temporal", "description": "...", "left_operand": "...", "operator": "eq", 
      "right_operand": "...", "scope": "...", "citations": [...], "thought_process": "..."}}
  ],
  "user_evidence": [
    {{"description": "...", "citations": [...], "thought_process": "..."}}
  ],
  "system_evidence": [
    {{"description": "...", "citations": [...], "thought_process": "..."}}
  ],
  "enterprise_policies": [
    {{"policy_name": "...", "description": "...", "organization": "...", 
      "applies_to": [...], "internal_tools": [...], "thought_process": "..."}}
  ],
  "classification": "condition",
  "classification_reasoning": "..."
}}

REMEMBER:
- Extract ONLY from the text provided above
- ALL citations must be EXACT VERBATIM quotes
- Use simple, clear English without document references
- Provide detailed thought_process for everything
- Minimum lengths are MANDATORY
"""
    
    def _get_level_description(self, level: int) -> str:
        """Get description of document level"""
        descriptions = {
            1: "PRIMARY LEGISLATION - Base legal requirements",
            2: "REGULATORY GUIDANCE - Detailed interpretation and guidance",
            3: "ENTERPRISE POLICIES - Organization-specific implementation"
        }
        return descriptions.get(level, "Unknown level")
    
    def get_react_agent_system_prompt(self) -> str:
        """ReAct agent system prompt"""
        return f"""You are a legal document analyzer using ReAct methodology.

Rule: {self.rule_name}
Jurisdiction: {self.jurisdiction}

CRITICAL REQUIREMENTS:
1. CITATIONS: For every claim, provide exact text excerpts (max 200 chars) with reasoning
2. EVIDENCE: Separate user perspective (what users do) from system perspective (what systems implement)
3. ACTION TAXONOMY: Use ONLY these three categories:
   - data_sharing_and_access (sharing, transferring, disclosing, accessing)
   - data_storage_and_hosting (storing, hosting, retaining, archiving)
   - data_usage (using, processing, analyzing, collecting)
4. CLASSIFICATION: Classify as either:
   - "condition" = Allowed under certain conditions
   - "restriction" = Prohibited or restricted

Extract:
- Rule description with citations
- Data actions (using simplified taxonomy)
- User evidence (what users must/can/cannot do)
- System evidence (what systems must implement)
- Constraints with citations
- Classification with reasoning

Return structured JSON with all citations."""
