// ============================================================================
// Grafana Alloy Configuration - Windows Simplified
// Collects: Logs + Metrics (No Tracing)
// ============================================================================

// ============================================================================
// LOGGING - Backend Application Logs
// ============================================================================

// Scrape logs from backend log files
local.file_match "backend_logs" {
  path_targets = [{
    __path__ = "/var/log/tia-backend/*.log",
    job      = "tia-backend",
    service  = "fastapi",
    host     = "windows",
  }]
}

loki.source.file "backend_logs" {
  targets    = local.file_match.backend_logs.targets
  forward_to = [loki.process.backend_logs.receiver]
}

// Process and enrich backend logs
loki.process "backend_logs" {
  forward_to = [loki.write.default.receiver]

  // Parse JSON logs
  stage.json {
    expressions = {
      timestamp  = "timestamp",
      level      = "level",
      logger     = "logger",
      message    = "message",
      request_id = "request_id",
      endpoint   = "endpoint",
      method     = "method",
      status     = "status",
      duration   = "duration",
      user_ip    = "user_ip",
      case_id    = "case_id",
    }
  }

  // Add labels for filtering
  stage.labels {
    values = {
      level    = "",
      logger   = "",
      endpoint = "",
      method   = "",
    }
  }

  // Timestamp parsing
  stage.timestamp {
    source = "timestamp"
    format = "RFC3339"
  }

  // Add severity labels for better filtering
  stage.match {
    selector = "{level=~\"ERROR|CRITICAL\"}"
    stage.static_labels {
      values = {
        severity = "error",
      }
    }
  }

  stage.match {
    selector = "{level=\"WARNING\"}"
    stage.static_labels {
      values = {
        severity = "warning",
      }
    }
  }

  stage.match {
    selector = "{level=~\"INFO|DEBUG\"}"
    stage.static_labels {
      values = {
        severity = "info",
      }
    }
  }
}

// ============================================================================
// METRICS - Backend Application Metrics
// ============================================================================

// Scrape FastAPI metrics endpoint
prometheus.scrape "backend_metrics" {
  targets = [{
    __address__ = "host.docker.internal:8000",
    job         = "tia-backend",
    instance    = "windows-backend",
  }]
  forward_to      = [prometheus.relabel.backend.receiver]
  scrape_interval = "15s"
  metrics_path    = "/metrics"
}

// Relabel and filter metrics
prometheus.relabel "backend" {
  forward_to = [prometheus.remote_write.default.receiver]

  // Keep HTTP metrics
  rule {
    source_labels = ["__name__"]
    regex         = "http_.*"
    action        = "keep"
  }

  // Keep application metrics
  rule {
    source_labels = ["__name__"]
    regex         = "app_.*"
    action        = "keep"
  }

  // Keep Python/process metrics
  rule {
    source_labels = ["__name__"]
    regex         = "process_.*"
    action        = "keep"
  }

  // Add environment label
  rule {
    target_label = "environment"
    replacement  = "development"
  }
}

// ============================================================================
// OUTPUT - Loki (Logs)
// ============================================================================

loki.write "default" {
  endpoint {
    url = "http://loki:3100/loki/api/v1/push"
    
    // Retry configuration
    retry_backoff {
      initial_interval = "500ms"
      max_interval     = "5s"
      max_elapsed_time = "30s"
    }

    // Batch configuration for better performance
    batch_wait       = "1s"
    batch_size       = 1048576 // 1MB
  }

  external_labels = {
    cluster = "tia-evaluation",
    env     = "development",
  }
}

// ============================================================================
// OUTPUT - Prometheus (Metrics)
// ============================================================================

prometheus.remote_write "default" {
  endpoint {
    url = "http://prometheus:9090/api/v1/write"

    queue_config {
      capacity             = 10000
      max_shards           = 10
      min_shards           = 1
      max_samples_per_send = 5000
      batch_send_deadline  = "5s"
    }

    metadata_config {
      send_interval = "1m"
    }
  }

  external_labels = {
    cluster = "tia-evaluation",
    env     = "development",
  }
}

// ============================================================================
// LOGGING CONFIGURATION
// ============================================================================

logging {
  level  = "info"
  format = "logfmt"
}
