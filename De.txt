"""
ODRL Rule Generator - Creates ODRL policies from extracted components

UPDATED:
- Removed assigner and assignee fields from permissions/prohibitions/duties
- Enhanced comment generation for detailed explanations
- Action taxonomy validation to ensure only: share, store, process, update, create

Location: src/generators/odrl_rule_generator.py
"""

import logging
import uuid
from typing import Dict, List, Any, Optional
from datetime import datetime

logger = logging.getLogger(__name__)


class ODRLRuleGenerator:
    """Generates ODRL policies from extracted rule components."""
    
    # Standard action taxonomy - ONLY these actions are permitted
    STANDARD_ACTIONS = {
        "share", "store", "process", "update", "create"
    }
    
    # ODRL namespace and standard actions
    ODRL_NAMESPACE = "http://www.w3.org/ns/odrl/2/"
    ODRL_ACTIONS = {
        "share": "http://www.w3.org/ns/odrl/2/distribute",  # Map to ODRL distribute
        "store": "http://www.w3.org/ns/odrl/2/archive",     # Map to ODRL archive
        "process": "http://www.w3.org/ns/odrl/2/use",       # Map to ODRL use
        "update": "http://www.w3.org/ns/odrl/2/modify",     # Map to ODRL modify
        "create": "http://www.w3.org/ns/odrl/2/derive"      # Map to ODRL derive
    }
    
    # ODRL operator mappings
    ODRL_OPERATORS = {
        "eq": "http://www.w3.org/ns/odrl/2/eq",
        "neq": "http://www.w3.org/ns/odrl/2/neq",
        "gt": "http://www.w3.org/ns/odrl/2/gt",
        "gteq": "http://www.w3.org/ns/odrl/2/gteq",
        "lt": "http://www.w3.org/ns/odrl/2/lt",
        "lteq": "http://www.w3.org/ns/odrl/2/lteq",
        "isAnyOf": "http://www.w3.org/ns/odrl/2/isAnyOf",
        "isAllOf": "http://www.w3.org/ns/odrl/2/isAllOf",
        "isNoneOf": "http://www.w3.org/ns/odrl/2/isNoneOf",
        "isPartOf": "http://www.w3.org/ns/odrl/2/isPartOf"
    }
    
    def __init__(self):
        """Initialize ODRL rule generator."""
        pass
    
    def validate_action(self, action: str) -> str:
        """
        Validate and normalize action to standard taxonomy.
        
        Args:
            action: Action to validate
            
        Returns:
            Normalized action from standard taxonomy
            
        Raises:
            ValueError: If action cannot be mapped to standard taxonomy
        """
        if not action:
            logger.warning("Empty action provided, defaulting to 'process'")
            return "process"
        
        action_lower = action.lower().strip()
        
        # Direct match
        if action_lower in self.STANDARD_ACTIONS:
            return action_lower
        
        # Map common synonyms
        action_mapping = {
            # Share synonyms
            "transfer": "share",
            "distribute": "share",
            "disclose": "share",
            "transmit": "share",
            "send": "share",
            "communicate": "share",
            
            # Store synonyms
            "retain": "store",
            "keep": "store",
            "archive": "store",
            "maintain": "store",
            "hold": "store",
            "save": "store",
            
            # Process synonyms
            "use": "process",
            "analyze": "process",
            "transform": "process",
            "modify": "process",
            "manipulate": "process",
            "handle": "process",
            "execute": "process",
            
            # Update synonyms
            "change": "update",
            "amend": "update",
            "revise": "update",
            "alter": "update",
            "edit": "update",
            "correct": "update",
            
            # Create synonyms
            "collect": "create",
            "generate": "create",
            "produce": "create",
            "derive": "create",
            "obtain": "create",
            "gather": "create"
        }
        
        if action_lower in action_mapping:
            mapped_action = action_mapping[action_lower]
            logger.info(f"Mapped action '{action}' to standard action '{mapped_action}'")
            return mapped_action
        
        # If no mapping found, log warning and use process as default
        logger.warning(f"Unknown action '{action}', defaulting to 'process'")
        return "process"
    
    def generate_detailed_comment(
        self, 
        rule_type: str, 
        action: str, 
        target: str, 
        constraints: List[Dict[str, Any]] = None,
        existing_description: str = None
    ) -> str:
        """
        Generate detailed comment for lawyers and non-lawyers.
        
        Args:
            rule_type: 'permission', 'prohibition', or 'duty'
            action: The action being performed
            target: What the action applies to
            constraints: List of constraints
            existing_description: Existing description if any
            
        Returns:
            Detailed comment (2-3+ sentences)
        """
        if existing_description and len(existing_description) > 100:
            # If we have a good existing description, use it
            return existing_description
        
        # Generate detailed comment based on rule type
        action_past = {
            "share": "shared", "store": "stored", "process": "processed",
            "update": "updated", "create": "created"
        }.get(action, "used")
        
        if rule_type == "permission":
            comment = f"This permission allows {target} to be {action_past} under specific conditions. "
            
            if constraints:
                constraint_desc = ", ".join([c.get('description', '') for c in constraints if c.get('description')])
                if constraint_desc:
                    comment += f"The following conditions must be met: {constraint_desc}. "
                else:
                    comment += "Specific conditions apply as defined in the constraints. "
            
            comment += f"Organizations must ensure all conditions are satisfied before {action}ing {target}."
            
        elif rule_type == "prohibition":
            comment = f"This prohibition forbids {target} from being {action_past} under certain circumstances. "
            
            if constraints:
                constraint_desc = ", ".join([c.get('description', '') for c in constraints if c.get('description')])
                if constraint_desc:
                    comment += f"The prohibition applies when: {constraint_desc}. "
                else:
                    comment += "Specific conditions trigger this prohibition as defined in the constraints. "
            
            comment += f"Violating this prohibition may result in non-compliance and potential legal consequences."
            
        else:  # duty
            comment = f"This duty requires that {target} must be {action_past} to fulfill compliance obligations. "
            
            if constraints:
                constraint_desc = ", ".join([c.get('description', '') for c in constraints if c.get('description')])
                if constraint_desc:
                    comment += f"The duty must be fulfilled when: {constraint_desc}. "
            
            comment += f"Failure to complete this duty may result in non-compliance with data protection requirements."
        
        return comment
    
    def generate_policy(
        self, 
        rules: List[Any],
        policy_uid: str = None,
        policy_type: str = "Set"
    ) -> Dict[str, Any]:
        """
        Generate complete ODRL policy from rules.
        
        Args:
            rules: List of Rule objects
            policy_uid: Optional policy UID, will be generated if not provided
            policy_type: ODRL policy type (Set, Offer, Agreement)
            
        Returns:
            Complete ODRL policy dictionary
        """
        if policy_uid is None:
            policy_uid = f"urn:uuid:{uuid.uuid4()}"
        
        policy = {
            "@context": {
                "odrl": "http://www.w3.org/ns/odrl/2/",
                "rdfs": "http://www.w3.org/2000/01/rdf-schema#",
                "rdf": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
                "dct": "http://purl.org/dc/terms/",
                "xsd": "http://www.w3.org/2001/XMLSchema#",
                "dpv": "https://w3id.org/dpv#"
            },
            "@type": f"odrl:{policy_type}",
            "uid": policy_uid,
            "profile": "http://www.w3.org/ns/odrl/2/core"
        }
        
        # Add metadata
        policy["dct:created"] = datetime.now().isoformat()
        policy["dct:creator"] = "ODRL Policy Generator"
        
        all_permissions = []
        all_prohibitions = []
        
        # Process each rule
        for rule in rules:
            # Extract permissions from rule
            if hasattr(rule, 'permissions') and rule.permissions:
                for perm in rule.permissions:
                    odrl_perm = self._create_permission(perm)
                    if odrl_perm:
                        all_permissions.append(odrl_perm)
            
            # Extract prohibitions from rule
            if hasattr(rule, 'prohibitions') and rule.prohibitions:
                for prohib in rule.prohibitions:
                    odrl_prohib = self._create_prohibition(prohib)
                    if odrl_prohib:
                        all_prohibitions.append(odrl_prohib)
        
        # Add to policy
        if all_permissions:
            policy["permission"] = all_permissions
        if all_prohibitions:
            policy["prohibition"] = all_prohibitions
        
        return policy
    
    def _get_action_uri(self, action: str) -> str:
        """
        Get ODRL action URI, validating against standard taxonomy.
        
        Args:
            action: Action name
            
        Returns:
            ODRL action URI
        """
        # Validate and normalize action
        normalized_action = self.validate_action(action)
        
        # Return corresponding ODRL URI
        return self.ODRL_ACTIONS.get(normalized_action, self.ODRL_ACTIONS["process"])
    
    def _create_asset_reference(self, target: str) -> str:
        """
        Create asset/target reference.
        
        Args:
            target: Target description
            
        Returns:
            Asset URI or description
        """
        if not target:
            return "urn:data:unspecified"
        
        # If it looks like a URI, use it
        if target.startswith("http://") or target.startswith("https://") or target.startswith("urn:"):
            return target
        
        # Otherwise create a URN from the description
        safe_target = target.replace(" ", "_").replace("/", "_")
        return f"urn:data:{safe_target}"
    
    def _create_permission(
        self, 
        permission: Dict[str, Any],
        data_category_uuids: Dict[str, str] = None
    ) -> Optional[Dict[str, Any]]:
        """
        Create ODRL permission from extracted permission data.
        
        UPDATED: Removed assigner and assignee fields
        """
        try:
            odrl_permission = {}
            
            # Add action (validated)
            action = permission.get("action")
            if action:
                action_uri = self._get_action_uri(action)
                odrl_permission["action"] = action_uri
            else:
                # Default to 'process' if no action specified
                odrl_permission["action"] = self.ODRL_ACTIONS["process"]
            
            # Add target (asset)
            target = permission.get("target", "data")
            odrl_permission["target"] = self._create_asset_reference(target)
            
            # NOTE: Assigner and assignee fields REMOVED
            # Focus on the action and conditions, not who grants permission
            
            # Add constraints
            constraints = permission.get("constraints", [])
            if constraints:
                odrl_constraints = []
                for constraint in constraints:
                    odrl_constraint = self._create_constraint(constraint)
                    if odrl_constraint:
                        odrl_constraints.append(odrl_constraint)
                
                if odrl_constraints:
                    odrl_permission["constraint"] = odrl_constraints
            
            # Add duties
            duties = permission.get("duties", [])
            if duties:
                odrl_duties = []
                for duty in duties:
                    odrl_duty = self._create_duty(duty)
                    if odrl_duty:
                        odrl_duties.append(odrl_duty)
                
                if odrl_duties:
                    odrl_permission["duty"] = odrl_duties
            
            # Add detailed description as comment
            description = permission.get("description")
            if not description or len(description) < 50:
                # Generate detailed comment if not provided or too short
                description = self.generate_detailed_comment(
                    "permission",
                    permission.get("action", "process"),
                    target,
                    constraints,
                    description
                )
            
            odrl_permission["rdfs:comment"] = description
            
            return odrl_permission
        
        except Exception as e:
            logger.error(f"Error creating permission: {e}")
            logger.error(f"Permission data: {permission}")
            return None
    
    def _create_prohibition(
        self, 
        prohibition: Dict[str, Any],
        data_category_uuids: Dict[str, str] = None
    ) -> Optional[Dict[str, Any]]:
        """
        Create ODRL prohibition from extracted prohibition data.
        
        UPDATED: Removed assigner and assignee fields
        """
        try:
            odrl_prohibition = {}
            
            # Add action (validated)
            action = prohibition.get("action")
            if action:
                action_uri = self._get_action_uri(action)
                odrl_prohibition["action"] = action_uri
            else:
                # Default to 'process' if no action specified
                odrl_prohibition["action"] = self.ODRL_ACTIONS["process"]
            
            # Add target (asset)
            target = prohibition.get("target", "data")
            odrl_prohibition["target"] = self._create_asset_reference(target)
            
            # NOTE: Assigner and assignee fields REMOVED
            
            # Add constraints
            constraints = prohibition.get("constraints", [])
            if constraints:
                odrl_constraints = []
                for constraint in constraints:
                    odrl_constraint = self._create_constraint(constraint)
                    if odrl_constraint:
                        odrl_constraints.append(odrl_constraint)
                
                if odrl_constraints:
                    odrl_prohibition["constraint"] = odrl_constraints
            
            # Add detailed description as comment
            description = prohibition.get("description")
            if not description or len(description) < 50:
                # Generate detailed comment if not provided or too short
                description = self.generate_detailed_comment(
                    "prohibition",
                    prohibition.get("action", "process"),
                    target,
                    constraints,
                    description
                )
            
            odrl_prohibition["rdfs:comment"] = description
            
            return odrl_prohibition
        
        except Exception as e:
            logger.error(f"Error creating prohibition: {e}")
            logger.error(f"Prohibition data: {prohibition}")
            return None
    
    def _create_duty(self, duty: Dict[str, Any]) -> Optional[Dict[str, Any]]:
        """
        Create ODRL duty.
        
        UPDATED: Removed assigner and assignee fields
        """
        try:
            odrl_duty = {}
            
            # Add action (validated)
            action = duty.get("action")
            if action:
                action_uri = self._get_action_uri(action)
                odrl_duty["action"] = action_uri
            else:
                odrl_duty["action"] = self.ODRL_ACTIONS["process"]
            
            # Add target if present
            target = duty.get("target")
            if target:
                odrl_duty["target"] = self._create_asset_reference(target)
            
            # NOTE: Assigner and assignee fields REMOVED
            
            # Add constraints if present
            constraints = duty.get("constraints", [])
            if constraints:
                odrl_constraints = []
                for constraint in constraints:
                    odrl_constraint = self._create_constraint(constraint)
                    if odrl_constraint:
                        odrl_constraints.append(odrl_constraint)
                
                if odrl_constraints:
                    odrl_duty["constraint"] = odrl_constraints
            
            # Add detailed description as comment
            description = duty.get("description")
            if not description or len(description) < 50:
                # Generate detailed comment if not provided or too short
                description = self.generate_detailed_comment(
                    "duty",
                    duty.get("action", "process"),
                    target or "data",
                    constraints,
                    description
                )
            
            odrl_duty["rdfs:comment"] = description
            
            return odrl_duty
        
        except Exception as e:
            logger.error(f"Error creating duty: {e}")
            return None
    
    def _create_constraint(self, constraint: Dict[str, Any]) -> Optional[Dict[str, Any]]:
        """Create ODRL constraint."""
        try:
            odrl_constraint = {}
            
            # Left operand
            left_operand = constraint.get("leftOperand")
            if left_operand:
                if left_operand.startswith("http://"):
                    odrl_constraint["leftOperand"] = left_operand
                else:
                    odrl_constraint["leftOperand"] = f"{self.ODRL_NAMESPACE}{left_operand}"
            
            # Operator
            operator = constraint.get("operator")
            if operator:
                if operator in self.ODRL_OPERATORS:
                    odrl_constraint["operator"] = self.ODRL_OPERATORS[operator]
                else:
                    odrl_constraint["operator"] = operator
            
            # Right operand
            right_operand = constraint.get("rightOperand")
            if right_operand is not None:
                odrl_constraint["rightOperand"] = right_operand
            
            # Optional fields
            if "unit" in constraint:
                odrl_constraint["unit"] = constraint["unit"]
            
            if "dataType" in constraint:
                odrl_constraint["dataType"] = constraint["dataType"]
            
            # Add detailed description as comment
            description = constraint.get("description")
            if description:
                odrl_constraint["rdfs:comment"] = description
            
            return odrl_constraint
        
        except Exception as e:
            logger.error(f"Error creating constraint: {e}")
            return None
    
    def convert_to_json_ld(self, policy: Dict[str, Any]) -> Dict[str, Any]:
        """
        Convert ODRL policy to JSON-LD format.
        
        Args:
            policy: ODRL policy dictionary
            
        Returns:
            JSON-LD formatted policy
        """
        # ODRL is already in JSON-LD format with @context
        return policy
    
    def convert_to_turtle(self, policy: Dict[str, Any]) -> str:
        """
        Convert ODRL policy to Turtle/TTL format.
        
        Args:
            policy: ODRL policy dictionary
            
        Returns:
            Turtle formatted string
        """
        try:
            from rdflib import Graph
            import json
            
            # Create RDF graph from JSON-LD
            g = Graph()
            g.parse(data=json.dumps(policy), format='json-ld')
            
            # Serialize to Turtle
            return g.serialize(format='turtle')
        
        except Exception as e:
            logger.error(f"Error converting to Turtle: {e}")
            return ""
