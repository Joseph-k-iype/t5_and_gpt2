"""
HSBC OpenAI Client wrapper
Extends OpenAI client with HSBC authentication
Location: src/services/hsbc_openai_client.py
"""
import logging
from typing import Optional, Any
from openai import OpenAI, APIError, AuthenticationError
import httpx

from .hsbc_token_service import HSBCTokenService
from ..config import Config

logger = logging.getLogger(__name__)


class HSBCOpenAIClient(OpenAI):
    """
    Custom OpenAI client with HSBC JWT authentication.
    Automatically handles token refresh on auth errors.
    """
    
    def __init__(
        self,
        token_service: HSBCTokenService,
        user_id: str,
        base_url: str,
        **kwargs
    ):
        """
        Initialize HSBC OpenAI Client
        
        Args:
            token_service: HSBCTokenService instance for token management
            user_id: HSBC user ID to include in requests
            base_url: Base URL for OpenAI-compatible API
            **kwargs: Additional arguments for OpenAI client
        """
        self.token_service = token_service
        self.user_id = user_id
        
        # Get initial token
        initial_token = token_service.get_token()
        
        # Initialize parent OpenAI client
        super().__init__(
            api_key=initial_token,
            base_url=base_url,
            **kwargs
        )
        
        logger.info(f"HSBC OpenAI Client initialized with base URL: {base_url}")
    
    def _get_custom_headers(self) -> dict:
        """
        Get custom headers for HSBC API
        
        Returns:
            dict: Headers including authentication token
        """
        token = self.token_service.get_token()
        return {
            "X-HSBC-E2E-Trust-Token": token,
            "Token_Type": "SESSION_TOKEN",
            "Content-Type": "application/json"
        }
    
    def _make_request_with_retry(self, method_name: str, *args, **kwargs) -> Any:
        """
        Make request with automatic token refresh on auth errors
        
        Args:
            method_name: Name of the OpenAI method to call
            *args: Positional arguments for the method
            **kwargs: Keyword arguments for the method
            
        Returns:
            Response from the API
        """
        max_retries = 2
        
        for attempt in range(max_retries):
            try:
                # Update API key with current token
                self.api_key = self.token_service.get_token()
                
                # Add custom headers if not present
                if 'extra_headers' not in kwargs:
                    kwargs['extra_headers'] = {}
                kwargs['extra_headers'].update(self._get_custom_headers())
                
                # Get the method from parent class
                method = getattr(super(), method_name)
                if callable(method):
                    return method(*args, **kwargs)
                else:
                    # For nested attributes like chat.completions
                    parts = method_name.split('.')
                    obj = super()
                    for part in parts:
                        obj = getattr(obj, part)
                    return obj(*args, **kwargs)
                
            except (AuthenticationError, APIError) as e:
                error_message = str(e).lower()
                
                # Check if it's an auth error
                if any(keyword in error_message for keyword in ['auth', 'unauthorized', '401', '403', 'token']):
                    if attempt < max_retries - 1:
                        logger.warning(f"Authentication error on attempt {attempt + 1}, refreshing token...")
                        self.token_service.invalidate_token()
                        continue
                    else:
                        logger.error("Max retries reached for authentication")
                        raise
                else:
                    # Not an auth error, raise immediately
                    raise
            except Exception as e:
                logger.error(f"Unexpected error in request: {e}")
                raise
        
        raise Exception("Failed to complete request after retries")
    
    # Override key methods to add custom headers and retry logic
    
    @property
    def chat(self):
        """Override chat property to return custom wrapper"""
        return self._ChatWrapper(self)
    
    class _ChatWrapper:
        """Wrapper for chat completions"""
        def __init__(self, client):
            self.client = client
            self._completions = self._CompletionsWrapper(client)
        
        @property
        def completions(self):
            return self._completions
        
        class _CompletionsWrapper:
            """Wrapper for completions"""
            def __init__(self, client):
                self.client = client
            
            def create(self, *args, **kwargs):
                """Create chat completion with HSBC auth"""
                # Add user field if not present
                if 'user' not in kwargs:
                    kwargs['user'] = self.client.user_id
                
                # Update token and headers
                self.client.api_key = self.client.token_service.get_token()
                
                if 'extra_headers' not in kwargs:
                    kwargs['extra_headers'] = {}
                kwargs['extra_headers'].update(self.client._get_custom_headers())
                
                try:
                    # Call parent's chat.completions.create
                    parent_client = OpenAI.__get__(self.client, type(self.client))
                    return parent_client.chat.completions.create(*args, **kwargs)
                except (AuthenticationError, APIError) as e:
                    error_message = str(e).lower()
                    if any(keyword in error_message for keyword in ['auth', 'unauthorized', '401', '403', 'token']):
                        logger.warning("Authentication error, refreshing token and retrying...")
                        self.client.token_service.invalidate_token()
                        
                        # Retry with new token
                        self.client.api_key = self.client.token_service.get_token()
                        kwargs['extra_headers'].update(self.client._get_custom_headers())
                        
                        parent_client = OpenAI.__get__(self.client, type(self.client))
                        return parent_client.chat.completions.create(*args, **kwargs)
                    else:
                        raise
    
    @property
    def embeddings(self):
        """Override embeddings property to return custom wrapper"""
        return self._EmbeddingsWrapper(self)
    
    class _EmbeddingsWrapper:
        """Wrapper for embeddings"""
        def __init__(self, client):
            self.client = client
        
        def create(self, *args, **kwargs):
            """Create embeddings with HSBC auth"""
            # Update token and headers
            self.client.api_key = self.client.token_service.get_token()
            
            if 'extra_headers' not in kwargs:
                kwargs['extra_headers'] = {}
            kwargs['extra_headers'].update(self.client._get_custom_headers())
            
            try:
                # Call parent's embeddings.create
                parent_client = OpenAI.__get__(self.client, type(self.client))
                return parent_client.embeddings.create(*args, **kwargs)
            except (AuthenticationError, APIError) as e:
                error_message = str(e).lower()
                if any(keyword in error_message for keyword in ['auth', 'unauthorized', '401', '403', 'token']):
                    logger.warning("Authentication error, refreshing token and retrying...")
                    self.client.token_service.invalidate_token()
                    
                    # Retry with new token
                    self.client.api_key = self.client.token_service.get_token()
                    kwargs['extra_headers'].update(self.client._get_custom_headers())
                    
                    parent_client = OpenAI.__get__(self.client, type(self.client))
                    return parent_client.embeddings.create(*args, **kwargs)
                else:
                    raise


def create_hsbc_client() -> HSBCOpenAIClient:
    """
    Factory function to create HSBC OpenAI client
    
    Returns:
        HSBCOpenAIClient: Configured client instance
    """
    if not Config.HSBC_PASSWORD:
        raise ValueError(
            "HSBC_PASSWORD environment variable required for HSBC authentication. "
            "Set it using: export HSBC_PASSWORD='your-password'"
        )
    
    # Create token service
    token_service = HSBCTokenService(
        token_endpoint=Config.HSBC_TOKEN_ENDPOINT,
        username=Config.HSBC_USERNAME,
        password=Config.HSBC_PASSWORD
    )
    
    # Create and return HSBC client
    return HSBCOpenAIClient(
        token_service=token_service,
        user_id=Config.HSBC_USER_ID,
        base_url=Config.BASE_URL
    )
