import json
import re

# Load the JSON data (adjust the file path as needed)
with open("input.json", "r") as f:
    data = json.load(f)

for entry in data:
    # Get the regex fragments and classification name
    regex_list = entry.get("classification_regex", [])
    classification_name = entry.get("classification_name", "")
    
    words = []
    
    # Extract words from each regex fragment (only keep those with 3+ characters)
    for pattern in regex_list:
        extracted = re.findall(r'\w+', pattern)
        words.extend([w for w in extracted if len(w) >= 3])
    
    # Split the classification name by underscore and include words with 3+ characters
    name_words = classification_name.split('_')
    words.extend([w for w in name_words if len(w) >= 3])
    
    # Remove duplicate words
    unique_words = list(set(words))
    
    if unique_words:
        # Escape words to avoid regex metacharacter issues
        escaped_words = [re.escape(word) for word in unique_words]
        # Combine the words using alternation
        alternation = "|".join(escaped_words)
        # Build a pattern that requires the entire string (with no whitespace) 
        # to be one or more concatenated occurrences of these words.
        combined_pattern = rf"(?i)^(?:{alternation})+$"
        entry["classification_regex"] = combined_pattern
    else:
        # Fallback pattern that never matches if no valid words are found
        entry["classification_regex"] = r"(?i)$^"

# Write the updated data back to a JSON file
with open("output.json", "w") as f:
    json.dump(data, f, indent=4)

print("Updated JSON written to output.json")
