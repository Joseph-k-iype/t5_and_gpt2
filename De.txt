"""
Global configuration for the legislation rules converter
Updated with HSBC authentication and FalkorDB settings
"""
import os
from openai import OpenAI


class Config:
    """Global configuration"""
    
    # HSBC Authentication Configuration
    USE_HSBC_AUTH = os.getenv("USE_HSBC_AUTH", "true").lower() == "true"
    HSBC_TOKEN_ENDPOINT = os.getenv(
        "HSBC_TOKEN_ENDPOINT",
        "https://cmb-ib2b-dsp-pprod-eu.systems.uk.hsbc:8443/dsp/rest-sts/DSP_iB2B/iB2B_tokenTranslator?_action=translate"
    )
    HSBC_USERNAME = os.getenv("HSBC_USERNAME", "GB-RulesEng-Dev")
    HSBC_PASSWORD = os.getenv("HSBC_PASSWORD", "")
    HSBC_USER_ID = os.getenv("HSBC_USER_ID", "UC0002731")
    
    # OpenAI API Configuration
    # When using HSBC, BASE_URL points to HSBC gateway
    # When not using HSBC, points to OpenAI directly
    BASE_URL = os.getenv(
        "OPENAI_BASE_URL",
        "https://gaip-api-uat.hsbc-12152296-gaipuat-dev.dev.gcp.cloud.hk.hsbc/etiv-ssvc-aigateway-ea-chatcompletion-uat-internal-proxy/v1/api/v1" 
        if USE_HSBC_AUTH else "https://api.openai.com/v1"
    )
    API_KEY = os.getenv("OPENAI_API_KEY", "")  # Will be overridden by HSBC token if USE_HSBC_AUTH
    CHAT_MODEL = os.getenv("OPENAI_CHAT_MODEL", "o3-mini")
    EMBEDDING_MODEL = os.getenv("OPENAI_EMBEDDING_MODEL", "text-embedding-3-large")
    
    # FalkorDB Configuration
    FALKORDB_HOST = os.getenv("FALKORDB_HOST", "localhost")
    FALKORDB_PORT = int(os.getenv("FALKORDB_PORT", "6379"))
    FALKORDB_GRAPH_NAME = "legal_knowledge_graph"
    
    # Paths
    LEGISLATION_PDF_PATH = "./legislation_pdfs/"
    RULES_OUTPUT_PATH = "./extracted_rules/"
    EMBEDDINGS_PATH = "./embeddings/"
    LOGS_PATH = "./logs/"
    EXISTING_RULES_FILE = "./extracted_rules/all_rules.json"
    METADATA_CONFIG_FILE = "./config/legislation_metadata.json"
    STANDARDS_OUTPUT_PATH = "./standards_output/"
    
    # DPV Namespaces
    DPV_NAMESPACE = "https://w3id.org/dpv#"
    DPV_PD_NAMESPACE = "https://w3id.org/dpv/dpv-pd#"
    DPV_TECH_NAMESPACE = "https://w3id.org/dpv/tech#"
    DPV_LEGAL_NAMESPACE = "https://w3id.org/dpv/legal/"
    ODRL_NAMESPACE = "http://www.w3.org/ns/odrl/2/"
    DPVCG_NAMESPACE = "https://w3id.org/dpv/"
    ACTION_NAMESPACE = "https://w3id.org/dpv/actions#"
    
    # PDF Processing Configuration
    CHUNK_SIZE = 4000
    OVERLAP_SIZE = 300
    MAX_FILE_SIZE = 5 * 1024 * 1024  # 5MB
    
    # Enterprise Tool Recognition
    ENTERPRISE_TOOLS = [
        "DataVisa",
        "DataHub", 
        "PrivacyHub",
        "PrivacyPortal",
        "ComplianceManager"
    ]
    
    # Document Classification Markers (to ignore)
    CLASSIFICATION_MARKERS = [
        "INTERNAL",
        "CONFIDENTIAL",
        "RESTRICTED",
        "PRIVATE",
        "SENSITIVE"
    ]


# Export for backward compatibility
OPENAI_MODEL = Config.CHAT_MODEL
API_KEY = Config.API_KEY
BASE_URL = Config.BASE_URL
EMBEDDING_MODEL = Config.EMBEDDING_MODEL


def get_openai_client() -> OpenAI:
    """
    Get OpenAI client instance
    
    Returns:
        OpenAI: Configured client
        
    Raises:
        ValueError: If API key not set and not using HSBC auth
    """
    if not Config.USE_HSBC_AUTH and not Config.API_KEY:
        raise ValueError(
            "OPENAI_API_KEY environment variable required when not using HSBC auth. "
            "Set it using: export OPENAI_API_KEY='your-api-key'"
        )
    
    # This will be overridden by HSBCOpenAIClient when using HSBC auth
    return OpenAI(
        api_key=Config.API_KEY or "placeholder",
        base_url=Config.BASE_URL
    )
