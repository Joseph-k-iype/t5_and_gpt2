from fastapi import APIRouter, HTTPException, Query
from typing import List, Optional, Dict, Any, Set
from app.models import LineageGraph, NodeData, EdgeData, LineagePath, HighlightRequest
from app.database import db
import logging

logger = logging.getLogger(__name__)
router = APIRouter(prefix="/api/lineage", tags=["lineage"])


def process_lineage_results(results: List[Any]) -> LineageGraph:
    """Process FalkorDB query results into nodes and edges"""
    nodes_dict: Dict[str, NodeData] = {}
    edges_dict: Dict[str, EdgeData] = {}
    
    for record in results:
        # Process Country nodes
        if record[0] and hasattr(record[0], 'properties'):
            country = record[0]
            country_id = f"country_{country.properties.get('code', '')}"
            if country_id not in nodes_dict:
                nodes_dict[country_id] = NodeData(
                    id=country_id,
                    label=country.properties.get('name', 'Unknown Country'),
                    type='country',
                    country=country.properties.get('code', ''),
                    is_collapsed=True
                )
        
        # Process Database nodes
        if record[1] and hasattr(record[1], 'properties'):
            database = record[1]
            country = record[0]
            country_code = country.properties.get('code', '') if country else ''
            db_id = f"db_{country_code}_{database.properties.get('name', '')}"
            country_id = f"country_{country_code}"
            
            if db_id not in nodes_dict:
                nodes_dict[db_id] = NodeData(
                    id=db_id,
                    label=database.properties.get('name', 'Unknown DB'),
                    type='database',
                    country=country_code,
                    database=database.properties.get('name', ''),
                    parent_id=country_id,
                    is_collapsed=True
                )
        
        # Process Attribute nodes
        if record[2] and hasattr(record[2], 'properties'):
            attribute = record[2]
            database = record[1]
            country = record[0]
            
            country_code = country.properties.get('code', '') if country else ''
            db_name = database.properties.get('name', '') if database else ''
            attr_id = f"attr_{country_code}_{db_name}_{attribute.properties.get('name', '')}"
            db_id = f"db_{country_code}_{db_name}"
            
            if attr_id not in nodes_dict:
                nodes_dict[attr_id] = NodeData(
                    id=attr_id,
                    label=attribute.properties.get('name', 'Unknown Attr'),
                    type='attribute',
                    country=country_code,
                    database=db_name,
                    parent_id=db_id,
                    data_category=attribute.properties.get('data_category', ''),
                    is_collapsed=False
                )
        
        # Process Transfer relationships (record[3] is source attr, record[4] is relationship, record[5] is target attr)
        if len(record) > 5 and record[3] and record[4] and record[5]:
            source_attr = record[3]
            transfer_rel = record[4]
            target_attr = record[5]
            
            if hasattr(source_attr, 'properties') and hasattr(target_attr, 'properties'):
                # Get source attribute info
                source_country = ''
                source_db = ''
                # Try to find source country and db from nodes
                for node in nodes_dict.values():
                    if node.type == 'attribute' and node.label == source_attr.properties.get('name', ''):
                        source_country = node.country or ''
                        source_db = node.database or ''
                        break
                
                source_id = f"attr_{source_country}_{source_db}_{source_attr.properties.get('name', '')}"
                
                # Get target attribute info
                target_country = ''
                target_db = ''
                for node in nodes_dict.values():
                    if node.type == 'attribute' and node.label == target_attr.properties.get('name', ''):
                        target_country = node.country or ''
                        target_db = node.database or ''
                        break
                
                target_id = f"attr_{target_country}_{target_db}_{target_attr.properties.get('name', '')}"
                
                edge_id = f"edge_{source_id}_to_{target_id}"
                if edge_id not in edges_dict:
                    edges_dict[edge_id] = EdgeData(
                        id=edge_id,
                        source=source_id,
                        target=target_id,
                        transfer_type=transfer_rel.properties.get('transfer_type', 'CROSS_BORDER') if hasattr(transfer_rel, 'properties') else 'CROSS_BORDER',
                        hop_number=transfer_rel.properties.get('hop_number', 1) if hasattr(transfer_rel, 'properties') else 1
                    )
    
    return LineageGraph(
        nodes=list(nodes_dict.values()),
        edges=list(edges_dict.values())
    )


@router.get("/graph", response_model=LineageGraph)
async def get_lineage_graph(
    country: Optional[str] = Query(None, description="Filter by country code")
):
    """Get the complete lineage graph or filtered by country"""
    try:
        if country:
            results = db.get_lineage_by_country(country)
        else:
            results = db.get_all_lineage()
        
        lineage = process_lineage_results(results)
        return lineage
    except Exception as e:
        logger.error(f"Error fetching lineage graph: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/highlight", response_model=Dict[str, Any])
async def get_highlighted_path(request: HighlightRequest):
    """Get highlighted path for a specific node or attribute"""
    try:
        highlighted_nodes: Set[str] = set()
        highlighted_edges: Set[str] = set()
        
        if request.attribute:
            # Get all lineage for this attribute
            results = db.get_attribute_lineage(request.attribute)
            
            for record in results:
                # Add country, database, and attribute
                if record[0] and hasattr(record[0], 'properties'):  # country
                    country_code = record[0].properties.get('code', '')
                    highlighted_nodes.add(f"country_{country_code}")
                
                if record[1] and hasattr(record[1], 'properties'):  # database
                    db_name = record[1].properties.get('name', '')
                    country_code = record[0].properties.get('code', '') if record[0] else ''
                    highlighted_nodes.add(f"db_{country_code}_{db_name}")
                
                if record[2] and hasattr(record[2], 'properties'):  # attribute
                    attr_name = record[2].properties.get('name', '')
                    db_name = record[1].properties.get('name', '') if record[1] else ''
                    country_code = record[0].properties.get('code', '') if record[0] else ''
                    highlighted_nodes.add(f"attr_{country_code}_{db_name}_{attr_name}")
                
                # Process path if exists
                if record[3]:  # path
                    # Add target nodes
                    if record[4] and hasattr(record[4], 'properties'):  # target attribute
                        target_attr = record[4].properties.get('name', '')
                        target_db = record[5].properties.get('name', '') if record[5] else ''
                        target_country = record[6].properties.get('code', '') if record[6] else ''
                        
                        target_id = f"attr_{target_country}_{target_db}_{target_attr}"
                        highlighted_nodes.add(target_id)
                        highlighted_nodes.add(f"db_{target_country}_{target_db}")
                        highlighted_nodes.add(f"country_{target_country}")
                        
                        # Add edge
                        source_attr = record[2].properties.get('name', '')
                        source_db = record[1].properties.get('name', '') if record[1] else ''
                        source_country = record[0].properties.get('code', '') if record[0] else ''
                        source_id = f"attr_{source_country}_{source_db}_{source_attr}"
                        
                        edge_id = f"edge_{source_id}_to_{target_id}"
                        highlighted_edges.add(edge_id)
        
        elif request.node_id:
            # Parse node_id to determine type and highlight accordingly
            if request.node_id.startswith('country_'):
                highlighted_nodes.add(request.node_id)
                # Get all related databases and attributes
                country_code = request.node_id.replace('country_', '')
                results = db.get_lineage_by_country(country_code)
                lineage = process_lineage_results(results)
                
                for node in lineage.nodes:
                    if node.country == country_code:
                        highlighted_nodes.add(node.id)
                
                for edge in lineage.edges:
                    if edge.source in highlighted_nodes and edge.target in highlighted_nodes:
                        highlighted_edges.add(edge.id)
            
            elif request.node_id.startswith('db_'):
                highlighted_nodes.add(request.node_id)
                # Get parent country
                parts = request.node_id.split('_')
                if len(parts) >= 3:
                    country_code = parts[1]
                    highlighted_nodes.add(f"country_{country_code}")
                
                # Get all attributes under this database
                results = db.get_all_lineage()
                lineage = process_lineage_results(results)
                
                for node in lineage.nodes:
                    if node.parent_id == request.node_id:
                        highlighted_nodes.add(node.id)
            
            elif request.node_id.startswith('attr_'):
                # Extract attribute name from node_id
                parts = request.node_id.split('_')
                if len(parts) >= 4:
                    attr_name = '_'.join(parts[3:])
                    return await get_highlighted_path(HighlightRequest(attribute=attr_name))
        
        return {
            "highlighted_nodes": list(highlighted_nodes),
            "highlighted_edges": list(highlighted_edges)
        }
    
    except Exception as e:
        logger.error(f"Error highlighting path: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/countries", response_model=List[Dict[str, str]])
async def get_countries():
    """Get all countries in the lineage"""
    try:
        query = "MATCH (c:Country) RETURN c.code as code, c.name as name"
        results = db.execute_query(query)
        countries = [{"code": r[0], "name": r[1]} for r in results]
        return countries
    except Exception as e:
        logger.error(f"Error fetching countries: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/stats", response_model=Dict[str, Any])
async def get_lineage_stats():
    """Get statistics about the lineage graph"""
    try:
        stats_query = """
        MATCH (c:Country) WITH count(c) as countries
        MATCH (d:Database) WITH countries, count(d) as databases
        MATCH (a:Attribute) WITH countries, databases, count(a) as attributes
        MATCH ()-[t:TRANSFERS_TO]->() WITH countries, databases, attributes, count(t) as transfers
        RETURN countries, databases, attributes, transfers
        """
        results = db.execute_query(stats_query)
        
        if results and len(results) > 0:
            record = results[0]
            return {
                "total_countries": record[0],
                "total_databases": record[1],
                "total_attributes": record[2],
                "total_transfers": record[3]
            }
        return {
            "total_countries": 0,
            "total_databases": 0,
            "total_attributes": 0,
            "total_transfers": 0
        }
    except Exception as e:
        logger.error(f"Error fetching stats: {e}")
        raise HTTPException(status_code=500, detail=str(e))
