import json
import re

# Load the JSON data (adjust the file path as needed)
with open("input.json", "r") as f:
    data = json.load(f)

for entry in data:
    # Get the regex fragments and classification name
    regex_list = entry.get("classification_regex", [])
    classification_name = entry.get("classification_name", "")
    
    allowed_words = []
    
    # Extract words from each regex fragment (only those with 3+ characters)
    for pattern in regex_list:
        allowed_words.extend([w for w in re.findall(r'\w+', pattern) if len(w) >= 3])
    
    # Extract words from the classification name. This will capture words separated by
    # spaces or underscores (or any non-word characters) and filter for length.
    allowed_words.extend([w for w in re.findall(r'\w+', classification_name) if len(w) >= 3])
    
    # Remove duplicate words
    allowed_words = list(set(allowed_words))
    
    if allowed_words:
        # Escape each word in case any contains regex metacharacters
        escaped_words = [re.escape(word) for word in allowed_words]
        # Combine the words with alternation (|) operator
        alternation = "|".join(escaped_words)
        # Build a regex pattern that requires the entire string (with no whitespace)
        # to be composed solely of one or more allowed words in any order.
        combined_pattern = rf"(?i)^(?:{alternation})+$"
        entry["classification_regex"] = combined_pattern
    else:
        # If no valid words are found, create a regex that will never match.
        entry["classification_regex"] = r"(?i)$^"

# Write the updated data back to a JSON file
with open("output.json", "w") as f:
    json.dump(data, f, indent=4)

print("Updated JSON written to output.json")
