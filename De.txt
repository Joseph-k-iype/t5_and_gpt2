"""
Anti-hallucination prompting strategies focused on dual action inference, decision-making, and whole document analysis.
Enhanced with decision inference capabilities for yes/no/maybe outcomes.

UPDATED: 
- Handle legal article references (reason but don't include in output)
- Standardize action taxonomy to: share, store, process, update, create
- Remove assigner/assignee fields
- Enhanced detailed comments for lawyers and non-lawyers
- Handle DataVisa references (HSBC internal tool)

Location: src/prompting/strategies.py
"""

import json


class PromptingStrategies:
    """Anti-hallucination prompting strategies focused on dual action inference, decision-making, and whole document analysis."""

    # Standard action taxonomy - all synonyms should map to these
    STANDARD_ACTIONS = {
        "share": ["transfer", "distribute", "disclose", "transmit", "send", "communicate"],
        "store": ["retain", "keep", "archive", "maintain", "hold", "save"],
        "process": ["use", "analyze", "transform", "modify", "manipulate", "handle", "execute"],
        "update": ["change", "amend", "revise", "alter", "edit", "correct"],
        "create": ["collect", "generate", "produce", "derive", "obtain", "gather"]
    }

    @staticmethod
    def comprehensive_document_analysis_prompt(legislation_text: str, existing_context: str = "", level: str = "level_1", chunk_info: str = "") -> str:
        """Comprehensive document analysis prompt that ensures the entire document is understood."""
        context_section = f"\n\nEXISTING RULES CONTEXT:\n{existing_context}\n" if existing_context else ""
        chunk_section = f"\n\nCHUNK INFORMATION:\n{chunk_info}\n" if chunk_info else ""

        return f"""
        Perform a comprehensive analysis of this legislation text with strict adherence to what is stated.
        Read and understand the ENTIRE document before extracting any rules, conditions, or decisions.
        {context_section}{chunk_section}

        LEGISLATION TEXT TO ANALYZE:
        {legislation_text}

        IMPORTANT INSTRUCTIONS FOR LEGAL REFERENCES:
        - You may encounter references to legal articles, regulations, or external documents (e.g., "Article 6(1)(a)", "GDPR Article 28", "Regulation XYZ")
        - If the document mentions "DataVisa", this refers to HSBC's internal data privacy governance tool
        - When processing legal references:
          * Use your training knowledge to understand what these references mean
          * Reason about their requirements and implications
          * Extract the SUBSTANCE of the requirement in plain language
          * DO NOT include article numbers, legal citations, or document references in the machine-readable output
          * Convert legal requirements into actionable, testable conditions
        
        EXAMPLE:
        - Input: "As required by Article 6(1)(a) GDPR, obtain explicit consent"
        - Your understanding: Use knowledge of Article 6(1)(a) to know it's about consent as lawful basis
        - Output: "Obtain explicit consent from data subject before processing" (NO article reference)

        COMPREHENSIVE ANALYSIS REQUIREMENTS:

        1. FULL DOCUMENT UNDERSTANDING:
        - Read the entire text from beginning to end
        - Identify all sections, articles, paragraphs, and subsections
        - Understand the overall structure and purpose of the legislation
        - Note cross-references between different parts of the document
        - Identify how different sections relate to each other
        - Understand legal references using your training knowledge but don't include them in output

        2. EXTRACT ALL OBLIGATIONS FROM ENTIRE DOCUMENT:
        - Extract every obligation stated anywhere in the text
        - Identify who has each obligation (controller, processor, joint_controller, data_subject)
        - Note the exact text that creates each obligation
        - Link related obligations across different sections
        - Use simple, clear English without legal jargon or document references
        - Convert legal citations into plain language requirements

        3. IDENTIFY ALL CONDITIONS AND TRIGGERS:
        - Find all conditions that trigger obligations throughout the document
        - Note data-related triggers (data types, processing activities, transfers)
        - Extract factual conditions that can be evaluated
        - Identify when conditions in one section affect obligations in another
        - Express conditions in testable terms without citing articles

        4. COMPREHENSIVE DATA REQUIREMENTS:
        - Identify all requirements for data handling mentioned anywhere
        - Note all data categories mentioned throughout the text
        - Extract all data processing operations referenced
        - Map data requirements to specific obligations
        - Use plain language descriptions instead of regulatory references

        5. COMPREHENSIVE ROLE AND RESPONSIBILITY MAPPING:
        - Identify every role mentioned in the document
        - Map all responsibilities to each role
        - Note how roles interact with each other
        - Identify role-specific obligations throughout the document
        - DO NOT extract or include "assigner" or "assignee" concepts
        - Focus on the actual parties performing actions, not who grants permissions

        6. CROSS-REFERENCE RESOLUTION:
        - When the text references other sections or articles, understand the connection
        - Use your knowledge to resolve what referenced articles require
        - Consolidate information from referenced sections into the main requirement
        - Present the complete requirement without external references

        7. IDENTIFY DECISION POINTS:
        - Where does the legislation require decisions to be made?
        - What are the possible outcomes (yes/no/conditional)?
        - What conditions determine each outcome?
        - What actions follow from each decision?

        OUTPUT REQUIREMENTS:
        - Provide comprehensive analysis in plain, clear English
        - NO legal jargon or citations (Article X, Section Y, etc.)
        - NO references to external documents unless essential to understanding
        - Convert all legal requirements into actionable, testable statements
        - Make the analysis understandable to both lawyers and non-lawyers
        - Focus on WHAT must be done, not WHERE it's written in law
        
        Your analysis should enable precise policy creation without requiring legal expertise to understand.
        """

    @staticmethod
    def focused_analysis_prompt(legislation_text: str, existing_context: str = "", level: str = "level_1") -> str:
        """Focused analysis on specific data operations, conditions, and decision points."""
        context_section = f"\n\nEXISTING RULES CONTEXT:\n{existing_context}\n" if existing_context else ""

        return f"""
        Analyze this legislation text focusing on specific data operations, conditions, and decision scenarios.
        {context_section}

        LEGISLATION TEXT:
        {legislation_text}

        HANDLING LEGAL REFERENCES:
        - If you encounter legal article references, use your knowledge to understand them
        - Extract the SUBSTANCE, not the citation
        - Convert legal language into plain, actionable requirements
        - Ignore article numbers, section references, and legal citations in your output

        ACTION TAXONOMY - CRITICAL:
        All actions MUST be mapped to this standard taxonomy:
        1. SHARE - any form of transfer, distribution, disclosure, transmission
        2. STORE - retention, archiving, keeping, maintaining data
        3. PROCESS - using, analyzing, transforming, handling data
        4. UPDATE - changing, amending, correcting data
        5. CREATE - collecting, generating, obtaining, deriving new data

        When you identify actions, you MUST:
        - Identify the action described in the text
        - Map it to ONE of the five standard actions above
        - Use ONLY the standard action name (share, store, process, update, create)
        - If an action could fit multiple categories, choose the most specific one

        EXAMPLE ACTION MAPPING:
        - "transfer data to third party" → SHARE
        - "retain records for 7 years" → STORE
        - "analyze customer behavior" → PROCESS
        - "correct inaccurate data" → UPDATE
        - "collect personal information" → CREATE

        FOCUSED ANALYSIS TASKS:

        1. DATA OPERATIONS:
        - What specific data operations are mentioned?
        - Map each operation to standard taxonomy: share, store, process, update, create
        - What data categories are involved?
        - What are the conditions for each operation?
        - Express in plain language without legal references

        2. CONDITIONAL LOGIC:
        - What conditions must be evaluated?
        - What are the logical operators (AND, OR, NOT)?
        - What data points are checked?
        - How do conditions combine?
        - Make conditions testable and concrete

        3. DECISION SCENARIOS:
        - What decisions need to be made?
        - What are possible outcomes (yes/no/conditional)?
        - What triggers each decision?
        - What actions follow each outcome?
        - Use plain language for decision criteria

        4. ROLE-SPECIFIC REQUIREMENTS:
        - What must the controller do?
        - What must the processor do?
        - What must the data subject do?
        - What must joint controllers do?
        - Express requirements without "assigner" or "assignee" concepts

        5. TEMPORAL ASPECTS:
        - Are there time limits or deadlines?
        - Are there sequence requirements?
        - What triggers timing requirements?
        - Express timing in concrete, measurable terms

        OUTPUT REQUIREMENTS:
        - Use ONLY standard action taxonomy (share, store, process, update, create)
        - NO legal citations or article references
        - Plain language understandable by non-lawyers
        - Concrete, testable conditions
        - Clear decision criteria
        - NO "assigner" or "assignee" fields

        Provide specific, focused analysis that can be directly converted to machine-readable rules.
        """

    @staticmethod
    def expert_verification_prompt(legislation_text: str, focused_analysis: str) -> str:
        """Expert verification with enhanced comment requirements."""
        return f"""
        Verify and enhance the focused analysis with expert review.
        Ensure all comments are detailed enough for both lawyers and non-lawyers to understand.

        ORIGINAL LEGISLATION:
        {legislation_text}

        FOCUSED ANALYSIS TO VERIFY:
        {focused_analysis}

        VERIFICATION TASKS:

        1. ACTION TAXONOMY VERIFICATION:
        - Confirm all actions use standard taxonomy: share, store, process, update, create
        - If any action uses synonyms, map it to the correct standard action
        - Ensure no actions outside the standard taxonomy remain
        - Verify action choice is the most specific and accurate

        2. LEGAL REFERENCE REMOVAL:
        - Check for any remaining legal citations (Article X, Section Y, etc.)
        - If found, convert to plain language requirements
        - Ensure all requirements are expressed without legal references
        - Verify substance is preserved when removing citations

        3. COMMENT ENHANCEMENT:
        For each rule, permission, prohibition, or duty, create DETAILED comments that:
        - Explain WHAT the requirement is in simple terms
        - Explain WHY it exists (purpose/rationale)
        - Explain WHEN it applies (conditions in plain language)
        - Explain HOW to comply (practical steps)
        - Use language a non-lawyer can understand
        - Also include legal context for lawyers (without article citations)
        - Be specific and comprehensive (minimum 2-3 sentences per comment)

        EXAMPLE OF GOOD COMMENT:
        "This requirement ensures that personal data is only shared with recipients who have adequate 
        data protection measures in place. It applies whenever data is transferred outside the organization, 
        particularly to third countries or international organizations. To comply, organizations must verify 
        that the recipient has equivalent data protection safeguards, such as standard contractual clauses 
        or binding corporate rules, and document this verification before any data transfer occurs. This 
        protects individuals' privacy rights by ensuring their data receives consistent protection regardless 
        of where it is processed."

        4. COMPLETENESS CHECK:
        - Are all obligations from the legislation captured?
        - Are all conditions clearly expressed?
        - Are all decision points identified?
        - Are comments sufficiently detailed?
        - Is the language accessible to non-experts?

        5. PARTY VERIFICATION:
        - Ensure NO "assigner" or "assignee" fields remain
        - Focus on who PERFORMS the action
        - Identify data controller, processor, data subject, or joint controller as appropriate
        - Remove any permission-granting party references

        6. DATAVISA REFERENCES:
        - If "DataVisa" is mentioned, note it's HSBC's internal data privacy governance tool
        - Convert any DataVisa-specific requirements into general data governance principles
        - Ensure requirements are understandable without knowing about DataVisa

        OUTPUT REQUIREMENTS:
        - Verified and enhanced analysis
        - All actions using standard taxonomy only
        - No legal citations
        - Detailed, comprehensive comments (2-3+ sentences each)
        - Accessible to both lawyers and non-lawyers
        - No assigner/assignee references
        - DataVisa references clarified if present

        Provide thorough verification and enhancement focusing on clarity and completeness.
        """

    @staticmethod
    def synthesis_prompt_template(
        legislation_text: str,
        article_reference: str,
        source_files: str,
        document_level: str,
        chunk_reference: str,
        existing_context: str,
        metadata_context: str,
        applicable_countries: str,
        adequacy_countries: str,
        focused_analysis: str,
        verified_analysis: str,
        agent_analysis: str,
        comprehensive_analysis: str,
        decision_analysis: str = ""
    ) -> str:
        """Template for synthesis prompt with all analyses including decisions."""
        chunk_context = f"\nCHUNK REFERENCE: {chunk_reference}\n" if chunk_reference else ""
        decision_context = f"\nDECISION ANALYSIS:\n{decision_analysis}\n" if decision_analysis else ""

        return f"""
        Based on the analyses below, create machine-readable rules with MAXIMUM COMPREHENSIVENESS including decision support.
        Extract EVERY possible rule, obligation, condition, requirement, and decision scenario from the legislation text.
        Create multiple rules if the text covers different aspects or scenarios.

        EXISTING RULES CONTEXT:
        {existing_context}

        METADATA CONTEXT:
        {metadata_context}{chunk_context}

        COMPREHENSIVE DOCUMENT ANALYSIS:
        {comprehensive_analysis}

        SOURCE LEGISLATION:
        Article: {article_reference}
        Document Level: {document_level}
        Source Files: {source_files}
        Text: {legislation_text}

        ANALYSIS RESULTS:

        Focused Analysis:
        {focused_analysis}

        Expert Verification:
        {verified_analysis}

        Agent Dual Action Analysis:
        {agent_analysis}
        {decision_context}

        CRITICAL REQUIREMENTS FOR OUTPUT:

        1. ACTION TAXONOMY (MANDATORY):
        - ALL actions MUST use standard taxonomy: share, store, process, update, create
        - Map any synonyms to the correct standard action
        - ONLY these five actions are permitted in the output
        - Choose the most specific action for each requirement

        2. LEGAL REFERENCE HANDLING:
        - DO NOT include legal article citations in the machine-readable output
        - Convert all legal references to plain language requirements
        - Express WHAT must be done, not WHERE it's written in law
        - Use substance from referenced articles without citing them

        3. COMMENT REQUIREMENTS (MANDATORY):
        - EVERY rule, action, permission, prohibition must have a detailed comment
        - Comments must be 2-3+ sentences minimum
        - Must be understandable by non-lawyers AND provide legal context
        - Explain: WHAT, WHY, WHEN, and HOW
        - Use plain, clear English

        4. PARTY HANDLING:
        - DO NOT include "assigner" or "assignee" fields
        - Use primary_impacted_role and secondary_impacted_role instead
        - Focus on who performs the action, not who grants permission
        - Valid roles: controller, processor, data_subject, joint_controller

        5. DATAVISA HANDLING:
        - If "DataVisa" is mentioned, understand it's HSBC's internal tool
        - Convert to general data governance requirements
        - Don't assume readers know what DataVisa is

        COMPREHENSIVE EXTRACTION REQUIREMENTS:
        1. Extract EVERY obligation, requirement, prohibition, permission mentioned
        2. Create separate rules for different roles (controller, processor, data_subject, joint_controller)
        3. Create separate rules for different data categories mentioned
        4. Create separate rules for different scenarios or conditions
        5. Create rules for both positive obligations (must do) and negative obligations (must not do)
        6. Extract rules for different timeframes if mentioned (immediate, within X days, etc.)
        7. Create rules for different jurisdictions if multiple countries are mentioned
        8. Extract both explicit and reasonably implied obligations
        9. Focus on practical data operations using standard action taxonomy
        10. Create comprehensive conditions that capture all requirements in plain language
        11. Include decision scenarios with yes/no/maybe outcomes
        12. Link decisions to required actions for compliance
        
        SYNTHESIS REQUIREMENTS:
        1. Create rules in json-rules-engine format
        2. Each condition must reference the document level: "{document_level}"
        3. Each condition must include chunk_reference if applicable: {chunk_reference}
        4. MANDATORY: Each rule MUST have primary_impacted_role and data_category fields populated
        5. Actions MUST use standard taxonomy (share, store, process, update, create) ONLY
        6. Actions must be in simple English without document references or legal citations
        7. Actions must focus on practical data operations
        8. User actions must be practical tasks individuals can perform
        9. Use exact enum values for all structured fields
        10. Timeline is optional - include only if mentioned in legislation
        11. Create rich, detailed conditions that can be programmatically evaluated
        12. Decisions must have clear outcomes and action mappings
        13. Cross-reference between rules, actions, and decisions
        14. ALL rules, actions, permissions, prohibitions MUST have detailed comments (2-3+ sentences)
        15. NO "assigner" or "assignee" fields anywhere in output

        OUTPUT FORMAT:
        Return a JSON array of rule objects. Each rule must have:
        - id: Unique identifier
        - name: Clear, descriptive name in simple English (no legal citations)
        - description: Full description without document references (detailed comment explaining WHAT, WHY, WHEN, HOW)
        - source_article: Article reference (for internal tracking only, not in descriptions)
        - source_file: Source file path
        - conditions: Comprehensive json-rules-engine conditions (plain language, no legal citations)
        - event: Event triggered when conditions met
        - actions: Array of rule actions (organizational level) - MUST use standard taxonomy
        - user_actions: Array of user actions (individual level) - MUST use standard taxonomy
        - decisions: Array of decision objects (if applicable)
        - priority: Priority level
        - primary_impacted_role: Primary role affected (controller/processor/data_subject/joint_controller)
        - secondary_impacted_role: Secondary role (if applicable)
        - data_category: Array of applicable data categories
        - applicable_countries: {applicable_countries}
        - adequacy_countries: {adequacy_countries}
        - comments: Detailed explanation for lawyers and non-lawyers (2-3+ sentences)

        EACH ACTION OBJECT MUST HAVE:
        - action_type: One of: share, store, process, update, create (ONLY these five)
        - title: Clear title in plain English
        - description: Detailed description (2-3+ sentences explaining WHAT, WHY, HOW)
        - NO "assigner" or "assignee" fields

        CRITICAL: Return ONLY valid JSON. No additional text or explanations outside the JSON structure.
        Ensure EVERY action uses standard taxonomy and EVERY element has detailed comments.
        """

    @staticmethod
    def role_inference_prompt(legislation_text: str) -> str:
        """Prompt for inferring primary impacted role from legislation text."""
        return f"""
        Analyze this legislation text and determine the primary role that is impacted or has obligations.

        TEXT:
        {legislation_text}

        INSTRUCTIONS:
        - Determine if the primary obligation falls on: controller, processor, joint_controller, or data_subject
        - Consider who has the main responsibility or obligation in this text
        - Focus on the party that must take action
        - DO NOT consider "assigner" or "assignee" - these are not relevant

        ROLE DEFINITIONS:
        - controller: Determines the purposes and means of data processing
        - processor: Processes data on behalf of the controller
        - joint_controller: Shares determination of purposes and means with another party
        - data_subject: The individual whose personal data is being processed

        Return ONLY one word: controller, processor, joint_controller, or data_subject
        """

    @staticmethod
    def decision_inference_prompt(legislation_text: str, existing_context: str = "") -> str:
        """Prompt for inferring decision scenarios with yes/no/maybe outcomes."""
        context_section = f"\n\nEXISTING CONTEXT:\n{existing_context}\n" if existing_context else ""

        return f"""
        Analyze this legislation to identify decision points and their outcomes.
        {context_section}

        LEGISLATION TEXT:
        {legislation_text}

        LEGAL REFERENCE HANDLING:
        - Use your knowledge to understand any legal article references
        - Extract decision requirements without citing the articles
        - Focus on WHAT decision must be made, not WHERE it's written in law

        DECISION ANALYSIS TASKS:

        1. IDENTIFY DECISION POINTS:
        - Where does the legislation require a yes/no decision?
        - What questions must be answered?
        - What triggers the need for a decision?
        - Express decision criteria in plain language

        2. POSSIBLE OUTCOMES:
        - YES: What conditions lead to affirmative outcome?
        - NO: What conditions lead to negative outcome?
        - MAYBE/CONDITIONAL: What creates conditional outcomes?
        - Use concrete, testable conditions

        3. REQUIRED ACTIONS:
        - What actions must be taken for YES outcome?
        - What actions must be taken for NO outcome?
        - What actions must be taken for CONDITIONAL outcome?
        - Use standard action taxonomy (share, store, process, update, create)

        4. CONDITIONS AND CRITERIA:
        - What specific conditions determine outcomes?
        - How do multiple conditions combine?
        - What data points must be evaluated?
        - Make criteria testable and measurable

        OUTPUT FORMAT:
        Provide structured decision analysis with:
        - Decision question (plain language, no legal citations)
        - Conditions for each outcome
        - Required actions for each outcome (using standard taxonomy)
        - Any additional context needed
        - Detailed comments explaining the decision process (2-3+ sentences)

        Make decision logic clear and implementable in code.
        """

    @staticmethod
    def odrl_comprehensive_guidance_analysis(
        guidance_text: str,
        rule_name: str,
        framework_type: str,
        restriction_condition: str
    ) -> str:
        """
        Comprehensive analysis of guidance text for ODRL extraction.
        Enhanced with action taxonomy and detailed comment requirements.
        """
        return f"""
        Analyze this guidance text comprehensively to extract all policy-relevant information.
        
        GUIDANCE TEXT:
        {guidance_text}
        
        RULE: {rule_name}
        FRAMEWORK: {framework_type} 
        TYPE: {restriction_condition}

        IMPORTANT HANDLING INSTRUCTIONS:

        1. LEGAL REFERENCES:
        - If you encounter references to legal articles, regulations, or documents, use your knowledge to understand them
        - DO NOT include article numbers or legal citations in your analysis
        - Convert legal requirements into plain, actionable language
        - Focus on WHAT is required, not WHERE it's written

        2. ACTION TAXONOMY (CRITICAL):
        ALL actions must be mapped to this standard taxonomy:
        - SHARE: transfer, distribute, disclose, transmit to third parties
        - STORE: retain, archive, maintain, keep data
        - PROCESS: use, analyze, transform, handle, execute operations on data
        - UPDATE: change, amend, correct, revise data
        - CREATE: collect, generate, obtain, derive new data

        When identifying actions, you MUST:
        - Identify what action is described
        - Map it to ONE of the five standard actions
        - Use ONLY the standard action name in your analysis

        3. DATAVISA REFERENCES:
        - If "DataVisa" is mentioned, note it's HSBC's internal data privacy governance tool
        - Convert DataVisa-specific requirements into general data governance principles
        - Don't assume familiarity with DataVisa in your output

        4. PARTIES AND ROLES:
        - DO NOT extract or reference "assigner" or "assignee"
        - Focus on who performs actions (controller, processor, data subject)
        - Ignore permission-granting party concepts

        COMPREHENSIVE ANALYSIS REQUIREMENTS:

        1. IDENTIFY ALL ACTIONS:
        - What actions/operations are mentioned in the guidance?
        - Map EACH action to standard taxonomy (share, store, process, update, create)
        - What is being acted upon (target/asset)?
        - Be comprehensive but use ONLY standard action names

        2. DETERMINE PERMISSIONS (what is ALLOWED):
        - What actions are explicitly permitted?
        - Under what conditions?
        - What duties must be fulfilled to exercise permission?
        - Use standard action taxonomy
        - NO assigner/assignee fields

        3. DETERMINE PROHIBITIONS (what is FORBIDDEN):
        - What actions are explicitly prohibited?
        - Under what circumstances?
        - Use standard action taxonomy
        - NO assigner/assignee fields

        4. EXTRACT CONDITIONS:
        - What conditions determine whether actions are allowed/forbidden?
        - What must be true for permissions to apply?
        - What triggers prohibitions?
        - Express in plain, testable language

        5. IDENTIFY DATA CONTEXT:
        - What data categories are involved?
        - Who are the data subjects?
        - What is the purpose of processing?
        - What is the legal basis (in plain language, no article citations)?

        6. IDENTIFY GEOGRAPHIC SCOPE:
        - What jurisdictions are mentioned?
        - Are there cross-border implications?
        - Use plain language, not legal references

        7. IDENTIFY EVIDENCE REQUIREMENTS:
        - What evidence is needed for compliance?
        - What documentation must be maintained?
        - What records are required?

        OUTPUT REQUIREMENTS:
        - Comprehensive analysis in clear, plain English
        - ALL actions using standard taxonomy (share, store, process, update, create) ONLY
        - NO legal citations or article references
        - NO assigner/assignee fields
        - Convert DataVisa references to general principles
        - Clear distinction between permissions and prohibitions
        - Detailed, specific conditions
        - Language accessible to non-lawyers
        
        Provide thorough analysis that enables precise ODRL policy creation.
        """

    @staticmethod
    def odrl_component_extraction(
        guidance_text: str,
        rule_name: str,
        initial_analysis: str
    ) -> str:
        """
        Extract ODRL-specific components with action taxonomy and enhanced comments.
        """
        return f"""
        Based on the guidance text and comprehensive analysis, extract ODRL policy components.
        
        RULE: {rule_name}
        
        INITIAL COMPREHENSIVE ANALYSIS:
        {initial_analysis}
        
        ORIGINAL GUIDANCE TEXT (reference as needed):
        {guidance_text}
        
        CRITICAL REQUIREMENTS:

        1. ACTION TAXONOMY (MANDATORY):
        Use ONLY these standard actions:
        - share: for any transfer, distribution, disclosure, transmission
        - store: for retention, archiving, maintaining data
        - process: for using, analyzing, transforming data
        - update: for changing, amending, correcting data
        - create: for collecting, generating, obtaining data
        
        Map all actions in the guidance to these five categories.

        2. LEGAL REFERENCES:
        - DO NOT include article numbers or legal citations
        - Convert legal requirements to plain language
        - Focus on actionable requirements

        3. NO ASSIGNER/ASSIGNEE:
        - Do NOT extract assigner or assignee information
        - Focus on the party performing the action
        - Use controller/processor/data_subject roles

        4. DETAILED COMMENTS:
        - Every permission, prohibition, duty needs a detailed comment
        - Minimum 2-3 sentences per comment
        - Explain WHAT, WHY, WHEN, and HOW
        - Make it understandable to non-lawyers

        ODRL COMPONENT EXTRACTION:
        
        1. ACTIONS (use standard taxonomy ONLY):
           List all actions identified from guidance:
           - Map each action to: share, store, process, update, or create
           - Use ONLY the standard action names
           - No synonyms or variations
        
        2. PERMISSIONS (what is ALLOWED):
           For each permission, extract:
           - action: Use standard taxonomy (share/store/process/update/create)
           - target: What the action applies to (data/asset description)
           - constraints: Conditions that must be met (plain language, no legal citations)
           - duties: Obligations to fulfill to exercise the permission
           - description: Detailed comment (2-3+ sentences) explaining WHAT is permitted, 
             WHY it's allowed, WHEN it applies, and HOW to comply
           
           DO NOT include:
           - assigner field
           - assignee field
           - legal article references in descriptions
        
        3. PROHIBITIONS (what is FORBIDDEN):
           For each prohibition, extract:
           - action: Use standard taxonomy (share/store/process/update/create)
           - target: What the action applies to
           - constraints: Conditions under which prohibition applies (plain language)
           - description: Detailed comment (2-3+ sentences) explaining WHAT is forbidden,
             WHY it's prohibited, WHEN it applies, and consequences
           
           DO NOT include:
           - assigner field
           - assignee field
           - legal citations
        
        4. DUTIES (what MUST be done):
           For each duty, extract:
           - action: Use standard taxonomy
           - target: What the action applies to
           - constraints: Conditions and timing (plain language)
           - description: Detailed comment (2-3+ sentences) explaining the obligation,
             why it's required, when it must be fulfilled, and how to comply
           
           DO NOT include:
           - assigner field
           - assignee field
        
        5. CONSTRAINTS (conditions and limitations):
           For each constraint, identify:
           - leftOperand: What is being constrained
           - operator: Comparison operator (eq, isAnyOf, gt, lt, etc.)
           - rightOperand: Constraint value
           - description: Plain English explanation (no legal citations)
           - scope: permission|prohibition|duty
        
        6. DATA CONTEXT:
           - data_categories: All data categories from guidance
           - data_subjects: Who the data is about
           - purpose: Purpose of processing (plain language)
           - legal_basis: Legal basis without article citations
        
        7. PARTIES AND ROLES:
           - Identify: controller, processor, data_subject, joint_controller
           - DO NOT use: assigner, assignee
           - Focus on who performs the action
        
        8. GEOGRAPHIC AND EVIDENCE:
           - geographic_scope: Jurisdictions involved
           - evidence_requirements: What evidence is needed
           - verification_methods: How to verify compliance
        
        OUTPUT FORMAT:
        Provide structured extraction with:
        - All actions using standard taxonomy only
        - Detailed comments (2-3+ sentences) for all rules
        - No assigner/assignee fields
        - No legal citations
        - Plain language throughout
        - Clear, testable conditions
        
        Extract comprehensively and precisely using ONLY the standard action taxonomy.
        """

    @staticmethod
    def odrl_constraint_analysis(
        guidance_text: str,
        rule_name: str,
        odrl_extraction: str
    ) -> str:
        """
        Detailed constraint analysis for ODRL with plain language requirements.
        """
        return f"""
        Perform detailed constraint analysis for ODRL policy creation.
        
        RULE: {rule_name}
        
        ODRL COMPONENT EXTRACTION:
        {odrl_extraction}
        
        ORIGINAL GUIDANCE TEXT (verify against):
        {guidance_text}
        
        CONSTRAINT ANALYSIS REQUIREMENTS:

        For EACH constraint identified, create precise, machine-readable structure:
        
        1. CONSTRAINT IDENTIFICATION:
           - leftOperand: What is being constrained (use ODRL terms)
           - operator: Comparison/test (eq, isAnyOf, gt, lt, etc.)
           - rightOperand: Constraint value
           - description: Plain English explanation (NO legal citations)
        
        2. CONSTRAINT CATEGORIES:
           Identify and structure by type:
           - Temporal: Time-based restrictions (dates, durations)
           - Spatial: Location/jurisdiction restrictions  
           - Purpose: Purpose-based limitations
           - Party: Recipient/controller restrictions
           - Quantitative: Count/amount limits
           - Qualitative: Type/quality restrictions
        
        3. LOGICAL CONSISTENCY:
           - Ensure no duplicate constraints
           - Avoid inverse operator pairs (e.g., "eq X" and "neq X")
           - Each constraint should appear once
           - Use appropriate positive/negative operators
        
        4. PLAIN LANGUAGE DESCRIPTIONS:
           For each constraint, provide detailed description that explains:
           - WHAT is being constrained
           - WHY the constraint exists
           - WHEN it applies
           - HOW to evaluate it
           - Understandable by non-lawyers
           - No legal article references
        
        5. SCOPE CLASSIFICATION:
           Mark each constraint with:
           - permission: Applies to what's allowed
           - prohibition: Applies to what's forbidden
           - duty: Applies to obligations
        
        OUTPUT:
        Provide comprehensive constraint analysis with:
        - Precise ODRL-compliant structure
        - Plain language descriptions
        - Logical consistency verified
        - No legal citations
        - Clear scope classifications
        
        Make constraints testable and implementable in code.
        """

    @staticmethod
    def odrl_synthesis_prompt(
        guidance_text: str,
        rule_name: str,
        framework_type: str,
        restriction_condition: str,
        initial_analysis: str,
        odrl_extraction: str,
        constraint_analysis: str,
        data_categories: str
    ) -> str:
        """
        Final synthesis of ODRL components with supervisor validation requirements.
        """
        return f"""
        Synthesize all analyses into final ODRL components for the policy.
        This is the FINAL OUTPUT that will be used to generate machine-readable policies.
        
        RULE: {rule_name}
        FRAMEWORK: {framework_type}
        TYPE: {restriction_condition}
        
        ALL ANALYSIS INPUTS:
        
        Initial Analysis:
        {initial_analysis}
        
        ODRL Extraction:
        {odrl_extraction}
        
        Constraint Analysis:
        {constraint_analysis}
        
        Data Categories:
        {data_categories}
        
        Original Guidance:
        {guidance_text}
        
        FINAL OUTPUT REQUIREMENTS (CRITICAL):

        1. ACTION TAXONOMY (MANDATORY):
        - ALL actions MUST use: share, store, process, update, create
        - NO other action names permitted
        - Verify all synonyms have been mapped correctly
        
        2. NO ASSIGNER/ASSIGNEE:
        - Completely remove assigner and assignee fields
        - Do NOT include them in any output structure
        - Focus only on the performing party
        
        3. DETAILED COMMENTS (MANDATORY):
        - EVERY permission must have detailed description (2-3+ sentences)
        - EVERY prohibition must have detailed description (2-3+ sentences)
        - EVERY duty must have detailed description (2-3+ sentences)
        - Comments must explain: WHAT, WHY, WHEN, HOW
        - Must be understandable by both lawyers and non-lawyers
        
        4. NO LEGAL CITATIONS:
        - Remove all article numbers and legal references
        - Use plain, actionable language
        - Focus on requirements, not legal sources
        
        5. SUPERVISOR VALIDATION:
        The output will be reviewed by a supervisor agent to ensure:
        - Correct action taxonomy usage
        - No assigner/assignee fields present
        - All comments are sufficiently detailed
        - All conditions are clear and testable
        - Logical consistency is maintained
        
        SYNTHESIS STRUCTURE:
        
        Return a JSON object with this exact structure:
        {{
          "analysis_reasoning": "Brief explanation of the synthesis process",
          "confidence_score": 0.0-1.0,
          
          "actions": [
            "List of standard actions: share, store, process, update, create"
          ],
          
          "permissions": [
            {{
              "action": "standard action (share/store/process/update/create)",
              "target": "what the action applies to",
              "constraints": [
                {{
                  "leftOperand": "constraint type",
                  "operator": "comparison operator",
                  "rightOperand": "value",
                  "description": "Detailed plain language explanation (2-3+ sentences)"
                }}
              ],
              "duties": ["obligations to fulfill"],
              "description": "DETAILED explanation (2-3+ sentences): what is permitted, why it's allowed, when it applies, how to comply"
            }}
          ],
          
          "prohibitions": [
            {{
              "action": "standard action (share/store/process/update/create)",
              "target": "what the action applies to",
              "constraints": [
                {{
                  "leftOperand": "constraint type",
                  "operator": "operator",
                  "rightOperand": "value",
                  "description": "Detailed plain language explanation (2-3+ sentences)"
                }}
              ],
              "description": "DETAILED explanation (2-3+ sentences): what is prohibited, why, when, and consequences"
            }}
          ],
          
          "duties": [
            {{
              "action": "standard action (share/store/process/update/create)",
              "target": "what the action applies to",
              "constraints": [],
              "description": "DETAILED explanation (2-3+ sentences): what must be done, why, when, how"
            }}
          ],
          
          "constraints": [
            {{
              "leftOperand": "what is constrained",
              "operator": "operator",
              "rightOperand": "value",
              "description": "detailed explanation",
              "scope": "permission|prohibition|duty"
            }}
          ],
          
          "data_categories": ["all identified data categories"],
          "data_subjects": ["who data is about"],
          "parties": {{
            "controller": ["controllers"],
            "processor": ["processors"],
            "data_subject": ["data subjects"]
          }},
          
          "purpose": "purpose in plain language",
          "legal_basis": "legal basis without article citations",
          "geographic_scope": ["jurisdictions"],
          "evidence_requirements": ["evidence needed"],
          "verification_methods": ["how to verify"]
        }}
        
        CRITICAL VALIDATION BEFORE OUTPUT:
        ✓ All actions use standard taxonomy (share/store/process/update/create)
        ✓ NO assigner or assignee fields anywhere
        ✓ ALL permissions/prohibitions/duties have detailed descriptions (2-3+ sentences)
        ✓ NO legal article citations
        ✓ All conditions in plain, testable language
        ✓ Comments understandable by non-lawyers
        ✓ DataVisa references converted to general principles if present
        
        Return ONLY valid JSON. The supervisor agent will verify all requirements are met.
        """

    @staticmethod
    def supervisor_review_prompt(
        extracted_components: str,
        original_guidance: str,
        rule_name: str
    ) -> str:
        """
        Supervisor agent review to validate and correct extracted ODRL components.
        Ensures action taxonomy compliance, detailed comments, and no assigner/assignee.
        """
        return f"""
        You are a SUPERVISOR AGENT reviewing extracted ODRL components for correctness and completeness.
        Your role is to validate and correct the extraction to ensure it meets all requirements.
        
        RULE: {rule_name}
        
        ORIGINAL GUIDANCE:
        {original_guidance}
        
        EXTRACTED COMPONENTS TO REVIEW:
        {extracted_components}
        
        MANDATORY VALIDATION CHECKLIST:

        1. ACTION TAXONOMY COMPLIANCE:
        ✓ ALL actions must be EXACTLY one of: share, store, process, update, create
        ✓ NO synonyms or variations (transfer→share, use→process, collect→create, etc.)
        ✓ Check permissions, prohibitions, and duties
        ✓ If incorrect actions found, map them to correct standard action
        
        CORRECTIONS NEEDED:
        - List any incorrect actions found
        - Provide correct mappings
        - Update all instances
        
        2. ASSIGNER/ASSIGNEE REMOVAL:
        ✓ NO "assigner" fields anywhere
        ✓ NO "assignee" fields anywhere
        ✓ Check all permissions, prohibitions, duties
        ✓ If found, remove completely
        
        CORRECTIONS NEEDED:
        - List where assigner/assignee fields were found
        - Confirm removal
        
        3. DETAILED COMMENTS VALIDATION:
        ✓ Every permission has 2-3+ sentence description
        ✓ Every prohibition has 2-3+ sentence description
        ✓ Every duty has 2-3+ sentence description
        ✓ Comments explain: WHAT, WHY, WHEN, HOW
        ✓ Language accessible to non-lawyers
        
        CORRECTIONS NEEDED:
        - List any insufficient comments
        - Provide enhanced versions (2-3+ sentences each)
        - Ensure clarity for both lawyers and non-lawyers
        
        4. LEGAL CITATION REMOVAL:
        ✓ NO article numbers (Article X, Section Y, etc.)
        ✓ NO legal document references
        ✓ All requirements in plain language
        ✓ Check descriptions, comments, conditions
        
        CORRECTIONS NEEDED:
        - List any legal citations found
        - Provide plain language alternatives
        
        5. CONDITION CLARITY:
        ✓ All constraints have clear descriptions
        ✓ Conditions are testable and concrete
        ✓ No ambiguous or vague conditions
        ✓ Plain language explanations present
        
        CORRECTIONS NEEDED:
        - List any unclear conditions
        - Provide clarified versions
        
        6. LOGICAL CONSISTENCY:
        ✓ No duplicate constraints
        ✓ No inverse operator pairs
        ✓ Each constraint appears exactly once
        ✓ Operators are semantically correct
        
        CORRECTIONS NEEDED:
        - List any logical inconsistencies
        - Provide corrections
        
        SUPERVISOR OUTPUT STRUCTURE:
        {{
          "validation_summary": {{
            "action_taxonomy_compliant": true/false,
            "assigner_assignee_removed": true/false,
            "comments_detailed": true/false,
            "legal_citations_removed": true/false,
            "conditions_clear": true/false,
            "logically_consistent": true/false
          }},
          
          "corrections_made": {{
            "action_corrections": ["list of action mappings corrected"],
            "fields_removed": ["assigner", "assignee"] or [],
            "comments_enhanced": ["list of elements where comments were improved"],
            "citations_removed": ["list of legal references converted to plain language"],
            "conditions_clarified": ["list of conditions improved"],
            "logical_fixes": ["list of logical inconsistencies resolved"]
          }},
          
          "corrected_components": {{
            // Full corrected ODRL components structure
            // With ALL corrections applied
            // Same structure as input but validated and corrected
          }},
          
          "supervisor_notes": "Summary of all changes made and why"
        }}
        
        VALIDATION RULES:
        - Be thorough and strict in validation
        - Make all necessary corrections
        - Enhance insufficient comments to 2-3+ sentences
        - Ensure action taxonomy compliance
        - Remove all assigner/assignee references
        - Convert all legal citations to plain language
        - Make all conditions clear and testable
        
        Return ONLY valid JSON with complete validation results and corrected components.
        The corrected components will be used as the final ODRL policy.
        """
