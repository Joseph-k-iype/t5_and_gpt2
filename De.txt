"""
Global configuration for the legislation rules converter
Updated with HSBC API support and FalkorDB settings
"""
import os
from openai import OpenAI
from typing import Optional


class Config:
    """Global configuration with HSBC support"""
    
    # Mode Selection
    USE_HSBC_API = os.getenv("USE_HSBC_API", "false").lower() == "true"
    
    # OpenAI API Configuration (Standard)
    BASE_URL = "https://api.openai.com/v1"
    API_KEY = os.getenv("OPENAI_API_KEY")
    CHAT_MODEL = "o3-mini-2025-01-31"
    EMBEDDING_MODEL = "text-embedding-3-large"
    
    # HSBC API Configuration
    HSBC_TOKEN_API_URL = os.getenv(
        "HSBC_TOKEN_API_URL",
        "https://cmb-ib2b-dsp-pprod-eu.systems.uk.hsbc:8443/dsp/rest-sts/DSP_iB2B/iB2B_tokenTranslator?_action=translate"
    )
    HSBC_CHAT_API_URL = os.getenv(
        "HSBC_CHAT_API_URL",
        "https://gaip-api-uat.hsbc-12152296-gaipuat-dev.dev.gcp.cloud.hk.hsbc/etiv-ssvc-aigateway-ea-chatcompletion-uat-internal-proxy/v1/api/v1/chat/completions"
    )
    HSBC_USERNAME = os.getenv("HSBC_USERNAME", "GB-RulesEng-Dev")
    HSBC_PASSWORD = os.getenv("HSBC_PASSWORD")
    HSBC_USER_ID = os.getenv("HSBC_USER_ID", "UC0002731")
    HSBC_MODEL = "o3-mini"  # HSBC's model name
    
    # FalkorDB Configuration
    FALKORDB_HOST = os.getenv("FALKORDB_HOST", "localhost")
    FALKORDB_PORT = int(os.getenv("FALKORDB_PORT", "6379"))
    FALKORDB_GRAPH_NAME = "legal_knowledge_graph"
    
    # Paths
    LEGISLATION_PDF_PATH = "./legislation_pdfs/"
    RULES_OUTPUT_PATH = "./extracted_rules/"
    EMBEDDINGS_PATH = "./embeddings/"
    LOGS_PATH = "./logs/"
    EXISTING_RULES_FILE = "./extracted_rules/all_rules.json"
    METADATA_CONFIG_FILE = "./config/legislation_metadata.json"
    STANDARDS_OUTPUT_PATH = "./standards_output/"
    
    # DPV Namespaces
    DPV_NAMESPACE = "https://w3id.org/dpv#"
    DPV_PD_NAMESPACE = "https://w3id.org/dpv/dpv-pd#"
    DPV_TECH_NAMESPACE = "https://w3id.org/dpv/tech#"
    DPV_LEGAL_NAMESPACE = "https://w3id.org/dpv/legal/"
    ODRL_NAMESPACE = "http://www.w3.org/ns/odrl/2/"
    DPVCG_NAMESPACE = "https://w3id.org/dpv/"
    ACTION_NAMESPACE = "https://w3id.org/dpv/actions#"
    
    # PDF Processing Configuration
    CHUNK_SIZE = 4000
    OVERLAP_SIZE = 300
    MAX_FILE_SIZE = 5 * 1024 * 1024  # 5MB
    
    # Enterprise Tool Recognition
    ENTERPRISE_TOOLS = [
        "DataVisa",
        "DataHub", 
        "PrivacyHub",
        "PrivacyPortal",
        "ComplianceManager"
    ]
    
    # Document Classification Markers (to ignore)
    CLASSIFICATION_MARKERS = [
        "INTERNAL",
        "CONFIDENTIAL",
        "RESTRICTED",
        "PRIVATE",
        "SENSITIVE"
    ]
    
    @classmethod
    def get_effective_model(cls) -> str:
        """Get the effective model name based on mode."""
        return cls.HSBC_MODEL if cls.USE_HSBC_API else cls.CHAT_MODEL
    
    @classmethod
    def get_effective_base_url(cls) -> str:
        """Get the effective base URL based on mode."""
        return cls.HSBC_CHAT_API_URL if cls.USE_HSBC_API else cls.BASE_URL


# Export for backward compatibility
OPENAI_MODEL = Config.CHAT_MODEL
API_KEY = Config.API_KEY
BASE_URL = Config.BASE_URL
EMBEDDING_MODEL = Config.EMBEDDING_MODEL


def get_openai_client() -> OpenAI:
    """
    Get OpenAI client instance (HSBC-aware).
    
    Returns:
        OpenAI: Configured client (HSBC or standard OpenAI)
        
    Raises:
        ValueError: If required credentials not set
    """
    if Config.USE_HSBC_API:
        # Import here to avoid circular dependencies
        from .hsbc_openai_client import create_hsbc_client
        
        if not Config.HSBC_PASSWORD:
            raise ValueError(
                "HSBC_PASSWORD environment variable required when USE_HSBC_API=true. "
                "Set it using: export HSBC_PASSWORD='your-password'"
            )
        
        hsbc_client = create_hsbc_client(
            token_api_url=Config.HSBC_TOKEN_API_URL,
            chat_api_url=Config.HSBC_CHAT_API_URL,
            username=Config.HSBC_USERNAME,
            password=Config.HSBC_PASSWORD,
            user_id=Config.HSBC_USER_ID,
            default_model=Config.HSBC_MODEL
        )
        
        return hsbc_client.get_client()
    
    else:
        # Standard OpenAI
        if not Config.API_KEY:
            raise ValueError(
                "OPENAI_API_KEY environment variable required. "
                "Set it using: export OPENAI_API_KEY='your-api-key'"
            )
        
        return OpenAI(
            api_key=Config.API_KEY,
            base_url=Config.BASE_URL
        )


def get_hsbc_credentials() -> dict:
    """
    Get HSBC credentials as a dictionary (useful for direct API calls).
    
    Returns:
        Dictionary with HSBC credentials and URLs
    """
    if Config.USE_HSBC_API:
        from .hsbc_openai_client import create_hsbc_client
        
        hsbc_client = create_hsbc_client(
            token_api_url=Config.HSBC_TOKEN_API_URL,
            chat_api_url=Config.HSBC_CHAT_API_URL,
            username=Config.HSBC_USERNAME,
            password=Config.HSBC_PASSWORD,
            user_id=Config.HSBC_USER_ID,
            default_model=Config.HSBC_MODEL
        )
        
        return {
            "api_key": hsbc_client.get_api_key(),
            "base_url": hsbc_client.get_base_url(),
            "model": Config.HSBC_MODEL,
            "headers": {
                "X-HSBC-E2E-Trust-Token": hsbc_client.get_api_key(),
                "Token_Type": "SESSION_TOKEN"
            }
        }
    else:
        return {
            "api_key": Config.API_KEY,
            "base_url": Config.BASE_URL,
            "model": Config.CHAT_MODEL,
            "headers": {}
        }
