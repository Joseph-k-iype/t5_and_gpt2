"""
Anti-hallucination prompting strategies focused on standard action taxonomy.
Enhanced with decision inference capabilities for yes/no/maybe outcomes.

ABSOLUTELY COMPLETE VERSION - ALL 15 METHODS INCLUDED

CRITICAL: ALL actions must use ONLY the 5 standard actions:
- share, store, process, update, create

UPDATED: 
- STRICT enforcement of 5-action taxonomy
- Handle legal article references (reason but don't include in output)
- Remove assigner/assignee fields
- Enhanced detailed comments for lawyers and non-lawyers
- Handle DataVisa references (HSBC internal tool)

Location: src/prompting/strategies.py
"""

import json


class PromptingStrategies:
    """Anti-hallucination prompting strategies with STRICT 5-action taxonomy enforcement."""

    # ============================================================================
    # STANDARD ACTION TAXONOMY - THE ONLY 5 ACTIONS PERMITTED
    # ============================================================================
    STANDARD_ACTIONS = {
        "share": ["transfer", "distribute", "disclose", "transmit", "send", "communicate", "provide", "give", "forward", "reveal"],
        "store": ["retain", "keep", "archive", "maintain", "hold", "save", "preserve", "backup"],
        "process": ["use", "analyze", "transform", "modify", "manipulate", "handle", "execute", "apply", "implement", "perform", "read", "access", "view"],
        "update": ["change", "amend", "revise", "alter", "edit", "correct", "rectify", "fix"],
        "create": ["collect", "generate", "produce", "derive", "obtain", "gather", "acquire", "compile"]
    }

    # ============================================================================
    # DOCUMENT ANALYSIS PROMPTS
    # ============================================================================

    @staticmethod
    def comprehensive_document_analysis_prompt(legislation_text: str, existing_context: str = "", level: str = "level_1", chunk_info: str = "") -> str:
        """Comprehensive document analysis prompt that ensures the entire document is understood."""
        context_section = f"\n\nEXISTING RULES CONTEXT:\n{existing_context}\n" if existing_context else ""
        chunk_section = f"\n\nCHUNK INFORMATION:\n{chunk_info}\n" if chunk_info else ""

        return f"""
        Perform a comprehensive analysis of this legislation text with strict adherence to what is stated.
        Read and understand the ENTIRE document before extracting any rules, conditions, or decisions.
        {context_section}{chunk_section}

        LEGISLATION TEXT (Level: {level}):
        {legislation_text}

        ═══════════════════════════════════════════════════════════════════════
        CRITICAL: STANDARD ACTION TAXONOMY - THESE ARE THE ONLY 5 ACTIONS
        ═══════════════════════════════════════════════════════════════════════
        
        ALL actions MUST be mapped to ONE of these 5 standard actions:
        
        1. SHARE   - any transfer, distribution, disclosure, transmission to others
        2. STORE   - any retention, archiving, keeping, maintaining of data
        3. PROCESS - any use, analysis, transformation, handling of data
        4. UPDATE  - any change, amendment, correction, modification of data
        5. CREATE  - any collection, generation, acquisition, derivation of data
        
        When you identify an action, you MUST:
        1. Identify what the legislation describes
        2. Map it to ONE of the five standard actions above
        3. Use ONLY the standard action name in your output
        4. If unclear, choose the most specific standard action
        
        EXAMPLES OF MAPPING:
        - "transfer data to third party" → SHARE
        - "disclose information to authorities" → SHARE
        - "retain records for 7 years" → STORE
        - "archive customer data" → STORE
        - "analyze customer behavior" → PROCESS
        - "use data for marketing" → PROCESS
        - "correct inaccurate data" → UPDATE
        - "amend personal details" → UPDATE
        - "collect personal information" → CREATE
        - "derive insights from data" → CREATE
        
        ═══════════════════════════════════════════════════════════════════════

        HANDLING LEGAL REFERENCES:
        - If you encounter legal article references (Article X, Section Y), use them to understand context
        - Extract the SUBSTANCE and requirements, not the citation numbers
        - Convert legal language into plain, actionable requirements
        - Do NOT include article numbers, section references in your output

        COMPREHENSIVE ANALYSIS TASKS:

        1. DOCUMENT STRUCTURE:
           - Identify the overall organization and hierarchy
           - Note any parent-child relationships between sections
           - Understand how different parts relate to each other

        2. DATA OPERATIONS - MAP TO STANDARD TAXONOMY:
           - Identify ALL data operations mentioned in the text
           - For EACH operation, map it to ONE standard action: share, store, process, update, create
           - Use ONLY these 5 standard action names
           - What data categories are involved?
           - What are the conditions for each operation?

        3. PERMISSIONS (what is ALLOWED):
           - What actions are explicitly permitted?
           - Map each to standard taxonomy
           - Under what conditions are they permitted?
           - What data categories do they apply to?

        4. PROHIBITIONS (what is FORBIDDEN):
           - What actions are explicitly prohibited?
           - Map each to standard taxonomy
           - Under what conditions are they prohibited?
           - What are the consequences of violation?

        5. CONDITIONAL LOGIC:
           - What conditions must be evaluated?
           - What are the logical operators (AND, OR, NOT)?
           - What data points are checked?
           - How do conditions combine?

        6. DECISION SCENARIOS:
           - What decisions need to be made?
           - What are possible outcomes (yes/no/conditional)?
           - What triggers each decision?
           - What actions follow each outcome?

        7. PARTIES AND ROLES:
           - Who are the key parties? (controller, processor, data subject, third party)
           - What are their responsibilities?
           - What must each party do or not do?
           - Do NOT use "assigner" or "assignee" terminology

        8. TEMPORAL ASPECTS:
           - Are there time limits or deadlines?
           - Are there sequence requirements?
           - What triggers timing requirements?

        9. DATA CATEGORIES:
           - What types of data are mentioned?
           - Are there special categories of data?
           - What specific data elements are referenced?

        10. PURPOSE AND LEGAL BASIS:
            - What is the stated purpose of data processing?
            - What legal basis is mentioned or implied?
            - Are there purpose limitations?

        OUTPUT REQUIREMENTS:
        - Provide comprehensive analysis in plain, clear English
        - ALL actions must use ONLY standard taxonomy (share, store, process, update, create)
        - NO legal jargon or citations (Article X, Section Y, etc.)
        - NO references to external documents unless essential
        - Convert all legal requirements into actionable, testable statements
        - Make the analysis understandable to both lawyers and non-lawyers
        - Focus on WHAT must be done, not WHERE it's written in law
        
        Your analysis should enable precise policy creation without requiring legal expertise to understand.
        """

    @staticmethod
    def focused_analysis_prompt(legislation_text: str, existing_context: str = "", level: str = "level_1") -> str:
        """Focused analysis on specific data operations, conditions, and decision points."""
        context_section = f"\n\nEXISTING RULES CONTEXT:\n{existing_context}\n" if existing_context else ""

        return f"""
        Analyze this legislation text focusing on specific data operations, conditions, and decision scenarios.
        {context_section}

        LEGISLATION TEXT:
        {legislation_text}

        ═══════════════════════════════════════════════════════════════════════
        ACTION TAXONOMY - CRITICAL REQUIREMENT
        ═══════════════════════════════════════════════════════════════════════
        
        All actions MUST be mapped to this standard taxonomy:
        1. SHARE - any form of transfer, distribution, disclosure, transmission
        2. STORE - retention, archiving, keeping, maintaining data
        3. PROCESS - using, analyzing, transforming, handling data
        4. UPDATE - changing, amending, correcting data
        5. CREATE - collecting, generating, obtaining, deriving new data

        When you identify actions, you MUST:
        - Identify the action described in the text
        - Map it to ONE of the five standard actions above
        - Use ONLY the standard action name (share, store, process, update, create)
        - If an action could fit multiple categories, choose the most specific one

        EXAMPLE ACTION MAPPING:
        - "transfer data to third party" → SHARE
        - "retain records for 7 years" → STORE
        - "analyze customer behavior" → PROCESS
        - "correct inaccurate data" → UPDATE
        - "collect personal information" → CREATE

        ═══════════════════════════════════════════════════════════════════════

        HANDLING LEGAL REFERENCES:
        - If you encounter legal article references, use your knowledge to understand them
        - Extract the SUBSTANCE, not the citation
        - Convert legal language into plain, actionable requirements
        - Ignore article numbers, section references, and legal citations in your output

        FOCUSED ANALYSIS TASKS:

        1. DATA OPERATIONS:
        - What specific data operations are mentioned?
        - Map each operation to standard taxonomy: share, store, process, update, create
        - What data categories are involved?
        - What are the conditions for each operation?
        - Express in plain language without legal references

        2. CONDITIONAL LOGIC:
        - What conditions must be evaluated?
        - What are the logical operators (AND, OR, NOT)?
        - What data points are checked?
        - How do conditions combine?
        - Make conditions testable and concrete

        3. DECISION SCENARIOS:
        - What decisions need to be made?
        - What are possible outcomes (yes/no/conditional)?
        - What triggers each decision?
        - What actions follow each outcome?
        - Use plain language for decision criteria

        4. ROLE-SPECIFIC REQUIREMENTS:
        - What must the controller do?
        - What must the processor do?
        - What must the data subject do?
        - What must joint controllers do?
        - Express requirements without "assigner" or "assignee" concepts

        5. TEMPORAL ASPECTS:
        - Are there time limits or deadlines?
        - Are there sequence requirements?
        - What triggers timing requirements?
        - Express timing in concrete, measurable terms

        OUTPUT REQUIREMENTS:
        - Use ONLY standard action taxonomy (share, store, process, update, create)
        - NO legal citations or article references
        - Plain language understandable by non-lawyers
        - Concrete, testable conditions
        - Clear decision criteria
        - NO "assigner" or "assignee" fields

        Provide specific, focused analysis that can be directly converted to machine-readable rules.
        """

    @staticmethod
    def expert_verification_prompt(legislation_text: str, focused_analysis: str) -> str:
        """Expert verification with enhanced comment requirements and strict action taxonomy."""
        return f"""
        Verify and enhance the focused analysis with expert review.
        Ensure all comments are detailed enough for both lawyers and non-lawyers to understand.

        ORIGINAL LEGISLATION:
        {legislation_text}

        FOCUSED ANALYSIS TO VERIFY:
        {focused_analysis}

        ═══════════════════════════════════════════════════════════════════════
        VERIFICATION CRITICAL REQUIREMENTS
        ═══════════════════════════════════════════════════════════════════════

        1. ACTION TAXONOMY VERIFICATION:
        - Confirm ALL actions use standard taxonomy: share, store, process, update, create
        - If any action uses different terminology, map it to the correct standard action
        - Ensure NO actions outside the standard taxonomy remain
        - Verify action choice is the most specific and accurate
        
        ONLY these 5 actions are permitted:
        - share (not: distribute, transfer, disclose, etc.)
        - store (not: archive, retain, keep, etc.)
        - process (not: use, analyze, handle, etc.)
        - update (not: modify, change, amend, etc.)
        - create (not: collect, derive, generate, etc.)

        2. LEGAL REFERENCE REMOVAL:
        - Check for any remaining legal citations (Article X, Section Y, etc.)
        - If found, convert to plain language requirements
        - Ensure all requirements are expressed without legal references
        - Verify substance is preserved when removing citations

        3. COMMENT QUALITY VERIFICATION:
        - Every permission, prohibition, duty MUST have a detailed comment
        - Comments must be at least 2-3 sentences minimum
        - Comments must explain: WHAT, WHY, WHEN, and HOW
        - Comments must be understandable by non-lawyers
        - If comments are too short or unclear, enhance them

        4. STRUCTURAL VERIFICATION:
        - Verify NO "assigner" or "assignee" fields exist
        - Confirm conditions are concrete and testable
        - Check that decision criteria are clear
        - Ensure data categories are specific

        5. LOGICAL CONSISTENCY:
        - Verify permissions and prohibitions don't contradict
        - Check that conditions make logical sense
        - Ensure temporal requirements are clear
        - Confirm party responsibilities are well-defined

        OUTPUT ENHANCED ANALYSIS:
        Provide corrected and enhanced analysis with:
        - ALL actions using ONLY standard taxonomy
        - NO legal citations
        - Enhanced detailed comments (2-3+ sentences each)
        - Clear, testable conditions
        - Plain language accessible to non-lawyers
        """

    # ============================================================================
    # ODRL-SPECIFIC PROMPTS
    # ============================================================================

    @staticmethod
    def odrl_comprehensive_guidance_analysis(
        guidance_text: str,
        rule_name: str,
        framework_type: str,
        restriction_condition: str
    ) -> str:
        """
        Comprehensive guidance analysis that combines document analysis with ODRL focus.
        This is essentially the comprehensive_document_analysis_prompt tailored for guidance analysis.
        """
        return f"""
        Perform comprehensive analysis of this regulatory guidance text.
        
        RULE: {rule_name}
        FRAMEWORK: {framework_type}
        TYPE: {restriction_condition}
        
        GUIDANCE TEXT:
        {guidance_text}
        
        ═══════════════════════════════════════════════════════════════════════
        CRITICAL: STANDARD ACTION TAXONOMY - THESE ARE THE ONLY 5 ACTIONS
        ═══════════════════════════════════════════════════════════════════════
        
        ALL actions MUST be mapped to ONE of these 5 standard actions:
        
        1. SHARE   - any transfer, distribution, disclosure, transmission to others
        2. STORE   - any retention, archiving, keeping, maintaining of data
        3. PROCESS - any use, analysis, transformation, handling of data
        4. UPDATE  - any change, amendment, correction, modification of data
        5. CREATE  - any collection, generation, acquisition, derivation of data
        
        ═══════════════════════════════════════════════════════════════════════

        COMPREHENSIVE ANALYSIS TASKS:

        1. DATA OPERATIONS:
           - Identify all data operations mentioned
           - Map each to standard taxonomy (share/store/process/update/create)
           - Determine conditions for each operation
           - Identify data categories involved

        2. PERMISSIONS AND PROHIBITIONS:
           - What is explicitly permitted? (map actions to standard taxonomy)
           - What is explicitly prohibited? (map actions to standard taxonomy)
           - Under what conditions?
           - What are the consequences?

        3. CONDITIONAL LOGIC:
           - What conditions must be evaluated?
           - What are the logical operators?
           - How do conditions combine?

        4. PARTIES AND ROLES:
           - Who are the key parties?
           - What are their responsibilities?
           - Use: controller, processor, data_subject
           - Do NOT use: assigner, assignee

        5. TEMPORAL ASPECTS:
           - Time limits or deadlines?
           - Sequence requirements?
           - Timing triggers?

        6. DATA CATEGORIES:
           - What types of data are mentioned?
           - Any special categories?
           - Specific data elements?

        7. PURPOSE AND LEGAL BASIS:
           - What is the stated purpose?
           - What legal basis is mentioned?
           - Any purpose limitations?

        OUTPUT:
        - Comprehensive analysis in plain English
        - ALL actions using ONLY standard taxonomy
        - NO legal citations
        - Clear, testable conditions
        - Understandable by non-lawyers
        
        Provide thorough analysis enabling precise ODRL policy creation.
        """

    @staticmethod
    def odrl_component_extraction(
        guidance_text: str,
        rule_name: str,
        initial_analysis: str
    ) -> str:
        """
        Extract ODRL-specific components with STRICT action taxonomy enforcement.
        """
        return f"""
        Based on the guidance text and comprehensive analysis, extract ODRL policy components.
        
        RULE: {rule_name}
        
        INITIAL COMPREHENSIVE ANALYSIS:
        {initial_analysis}
        
        ORIGINAL GUIDANCE TEXT (reference as needed):
        {guidance_text}
        
        ═══════════════════════════════════════════════════════════════════════
        CRITICAL REQUIREMENTS - MUST BE FOLLOWED EXACTLY
        ═══════════════════════════════════════════════════════════════════════

        1. ACTION TAXONOMY (MANDATORY):
        Use ONLY these standard actions - NO EXCEPTIONS:
        - share: for ANY transfer, distribution, disclosure, transmission to others
        - store: for ANY retention, archiving, maintaining, keeping of data
        - process: for ANY use, analysis, transformation, handling of data
        - update: for ANY change, amendment, correction, modification of data
        - create: for ANY collection, generation, acquisition, derivation of data
        
        CRITICAL: When you identify an action in the guidance:
        1. Determine what the action does
        2. Map it to ONE of the five standard actions
        3. Use ONLY the standard action name (share/store/process/update/create)
        4. NEVER use synonyms like: distribute, archive, use, modify, derive, transfer, etc.

        2. NO LEGAL REFERENCES:
        - DO NOT include article numbers or legal citations
        - Convert legal requirements to plain language
        - Focus on actionable requirements

        3. NO ASSIGNER/ASSIGNEE:
        - Do NOT extract assigner or assignee information
        - Focus on the party performing the action
        - Use controller/processor/data_subject roles instead

        4. DETAILED COMMENTS:
        - Every permission, prohibition, duty needs a detailed comment
        - Minimum 2-3 sentences per comment
        - Explain WHAT, WHY, WHEN, and HOW
        - Make it understandable to non-lawyers

        ═══════════════════════════════════════════════════════════════════════

        ODRL COMPONENT EXTRACTION:
        
        Return a JSON object with the following structure:
        
        {{
          "permissions": [
            {{
              "action": "ONE OF: share, store, process, update, create",
              "target": "what the action applies to",
              "constraints": [
                {{
                  "leftOperand": "constraint type",
                  "operator": "eq|isAnyOf|gt|lt|etc",
                  "rightOperand": "value",
                  "description": "Detailed plain language explanation (2-3+ sentences)"
                }}
              ],
              "description": "DETAILED explanation (2-3+ sentences): what is permitted, why it's allowed, when it applies, how to comply"
            }}
          ],
          
          "prohibitions": [
            {{
              "action": "ONE OF: share, store, process, update, create",
              "target": "what the action applies to",
              "constraints": [
                {{
                  "leftOperand": "constraint type",
                  "operator": "operator",
                  "rightOperand": "value",
                  "description": "Detailed plain language explanation (2-3+ sentences)"
                }}
              ],
              "description": "DETAILED explanation (2-3+ sentences): what is prohibited, why, when, and consequences"
            }}
          ],
          
          "duties": [
            {{
              "action": "ONE OF: share, store, process, update, create",
              "target": "what the action applies to",
              "constraints": [],
              "description": "DETAILED explanation (2-3+ sentences): what must be done, why, when, how"
            }}
          ],
          
          "constraints": [
            {{
              "leftOperand": "what is constrained",
              "operator": "operator",
              "rightOperand": "value",
              "description": "detailed explanation",
              "scope": "permission|prohibition|duty"
            }}
          ],
          
          "data_categories": ["all identified data categories"],
          "data_subjects": ["who data is about"],
          "parties": {{
            "controller": ["controllers"],
            "processor": ["processors"],
            "data_subject": ["data subjects"]
          }},
          
          "purpose": "purpose in plain language",
          "legal_basis": "legal basis without article citations",
          "geographic_scope": ["jurisdictions"],
          "evidence_requirements": ["evidence needed"],
          "verification_methods": ["how to verify"]
        }}
        
        ═══════════════════════════════════════════════════════════════════════
        CRITICAL VALIDATION BEFORE OUTPUT - CHECK EVERY ITEM
        ═══════════════════════════════════════════════════════════════════════
        
        ✓ All actions use ONLY standard taxonomy (share/store/process/update/create)
        ✓ NO other action names like: distribute, archive, use, modify, derive, transfer, etc.
        ✓ NO assigner or assignee fields anywhere
        ✓ ALL permissions/prohibitions/duties have detailed descriptions (2-3+ sentences)
        ✓ NO legal article citations
        ✓ All conditions in plain, testable language
        ✓ Comments understandable by non-lawyers
        ✓ DataVisa references converted to general principles if present
        
        Return ONLY valid JSON. The supervisor agent will verify all requirements are met.
        """

    @staticmethod
    def odrl_constraint_analysis(
        guidance_text: str,
        rule_name: str,
        odrl_extraction: str
    ) -> str:
        """
        Detailed constraint analysis for ODRL with plain language requirements.
        """
        return f"""
        Perform detailed constraint analysis for ODRL policy creation.
        
        RULE: {rule_name}
        
        ODRL COMPONENT EXTRACTION:
        {odrl_extraction}
        
        ORIGINAL GUIDANCE TEXT (verify against):
        {guidance_text}
        
        CONSTRAINT ANALYSIS REQUIREMENTS:

        For EACH constraint identified, create precise, machine-readable structure:
        
        1. CONSTRAINT IDENTIFICATION:
           - leftOperand: What is being constrained (use ODRL terms)
           - operator: Comparison/test (eq, isAnyOf, gt, lt, etc.)
           - rightOperand: Constraint value
           - description: Plain English explanation (NO legal citations)
        
        2. CONSTRAINT CATEGORIES:
           Identify and structure by type:
           - Temporal: Time-based restrictions (dates, durations)
           - Spatial: Location/jurisdiction restrictions  
           - Purpose: Purpose-based limitations
           - Party: Recipient/controller restrictions
           - Quantitative: Count/amount limits
           - Qualitative: Type/quality restrictions
        
        3. LOGICAL CONSISTENCY:
           - Ensure no duplicate constraints
           - Avoid inverse operator pairs (e.g., "eq X" and "neq X")
           - Each constraint should appear once
           - Use appropriate positive/negative operators
        
        4. PLAIN LANGUAGE DESCRIPTIONS:
           For each constraint, provide detailed description that explains:
           - WHAT is being constrained
           - WHY the constraint exists
           - WHEN it applies
           - HOW to evaluate it
           - Understandable by non-lawyers
           - No legal article references
        
        5. SCOPE CLASSIFICATION:
           Mark each constraint with:
           - permission: Applies to what's allowed
           - prohibition: Applies to what's forbidden
           - duty: Applies to obligations
        
        OUTPUT:
        Provide comprehensive constraint analysis with:
        - Precise ODRL-compliant structure
        - Plain language descriptions
        - Logical consistency verified
        - No legal citations
        - Clear scope classifications
        
        Make constraints testable and implementable in code.
        """

    @staticmethod
    def odrl_data_category_identification(
        guidance_text: str,
        rule_name: str,
        constraint_analysis: str
    ) -> str:
        """
        Stage 4: Comprehensive data category identification.
        """
        return f"""
        Identify ALL data categories mentioned or reasonably implied in the guidance.
        
        RULE: {rule_name}
        
        CONSTRAINT ANALYSIS:
        {constraint_analysis}
        
        ORIGINAL GUIDANCE TEXT:
        {guidance_text}
        
        COMPREHENSIVE DATA CATEGORY IDENTIFICATION:
        
        Identify all types of data with precision and completeness:
        
        1. STANDARD DATA CATEGORIES:
           - Personal Data: any information relating to identified/identifiable person
           - Sensitive Data: special categories (racial origin, political opinions, etc.)
           - Biometric Data: unique biological characteristics
           - Genetic Data: inherited or acquired genetic characteristics
           - Health Data: physical or mental health information
           - Financial Data: payment, banking, financial information
           - Location Data: geographic position data
           - Behavioral Data: behavioral patterns, profiling data
           - Identification Data: identity documents, credentials
           - Contact Data: email, phone, address
           - Demographic Data: age, gender, nationality
           - Professional Data: employment, education, qualifications
           - Transactional Data: purchase history, service usage
           - Communication Data: emails, messages, call logs
           - Device Data: IP address, device ID, cookies
           - Biographic Data: life events, relationships
        
        2. DOMAIN-SPECIFIC DATA:
           - Medical Records (health domain)
           - Patient Data (health domain)
           - Student Records (education domain)
           - Employee Data (employment domain)
           - Customer Data (commercial domain)
           - Research Data (research domain)
        
        3. DATA CATEGORIZED BY SENSITIVITY:
           - Public Data (publicly available)
           - Internal Data (organizational use)
           - Confidential Data (restricted access)
           - Restricted Data (highly sensitive)
        
        4. DATA CATEGORIZED BY PURPOSE/USE:
           - Marketing Data (data used for marketing/advertising)
           - Research Data (data used for research purposes)
           - Statistical Data (data used for statistics)
           - Operational Data (data for service operation)
           - Archival Data (historical/archived data)
           - Training Data (data for ML/AI training)
        
        5. DATA CATEGORIZED BY STATE:
           - Active Data (currently in use)
           - Archived Data (stored for retention)
           - Backup Data (copies for recovery)
           - Temporary Data (session/cache data)
        
        IDENTIFICATION METHODOLOGY:
        
        For EACH data category identified:
        
        {{
          "category_name": "Precise category name",
          "description": "Brief description based on guidance context",
          "sensitivity_level": "normal|sensitive|highly_sensitive",
          "evidence": "Exact text from guidance that indicates this category",
          "reasoning": "Why this category was identified",
          "confidence": "high|medium|low"
        }}
        
        IDENTIFICATION RULES:
        
        - EXPLICIT: Category directly mentioned in text
        - IMPLICIT: Category reasonably implied by context
        - DERIVATIVE: Category derived from described operations
        
        Examples:
        - "patient records" → Health Data (EXPLICIT)
        - "processing for medical research" → Health Data (IMPLICIT)
        - "DNA analysis" → Genetic Data, Health Data (EXPLICIT + DERIVATIVE)
        - "location tracking for delivery" → Location Data (EXPLICIT)
        - "IP address logging" → Device Data, Location Data (EXPLICIT + IMPLICIT)
        
        CRITICAL REQUIREMENTS:
        - Be COMPREHENSIVE - identify ALL categories mentioned or implied
        - Be PRECISE - use correct category names
        - Be JUSTIFIED - explain why each category was identified
        - Be CONSERVATIVE - don't over-infer categories not supported by text
        - PRIORITIZE explicit mentions over implicit ones
        - NOTE when multiple categories overlap
        
        Provide a complete list of ALL data categories with supporting evidence.
        """

    @staticmethod
    def odrl_synthesis_prompt(
        guidance_text: str,
        rule_name: str,
        framework_type: str,
        restriction_condition: str,
        initial_analysis: str,
        odrl_extraction: str,
        constraint_analysis: str,
        data_categories: str
    ) -> str:
        """
        Final synthesis of ODRL components with supervisor validation requirements.
        """
        return f"""
        Synthesize all analyses into final ODRL components for the policy.
        This is the FINAL OUTPUT that will be used to generate machine-readable policies.
        
        RULE: {rule_name}
        FRAMEWORK: {framework_type}
        TYPE: {restriction_condition}
        
        ALL ANALYSIS INPUTS:
        
        Initial Analysis:
        {initial_analysis}
        
        ODRL Extraction:
        {odrl_extraction}
        
        Constraint Analysis:
        {constraint_analysis}
        
        Data Categories:
        {data_categories}
        
        Original Guidance:
        {guidance_text}
        
        FINAL OUTPUT REQUIREMENTS (CRITICAL):

        1. ACTION TAXONOMY (ABSOLUTE REQUIREMENT):
           ALL actions MUST be ONE OF: share, store, process, update, create
           NO other action names permitted
        
        2. NO ASSIGNER/ASSIGNEE:
           Do NOT include assigner or assignee fields anywhere
        
        3. DETAILED COMMENTS:
           EVERY permission, prohibition, duty needs 2-3+ sentence comment
           Explain WHAT, WHY, WHEN, HOW
        
        4. LOGICAL CONSISTENCY:
           Avoid duplicate constraints in permissions and prohibitions
           Each constraint should appear only once
           Use positive framing when possible
        
        5. NO LEGAL CITATIONS:
           All requirements in plain language
           No article numbers or legal references
        
        Return JSON with this EXACT structure:
        {{
          "actions": ["list of standard actions only"],
          "permissions": [/* permission objects */],
          "prohibitions": [/* prohibition objects */],
          "constraints": [/* constraint objects */],
          "data_categories": [/* data category names */],
          "data_subjects": [/* who data is about */],
          "parties": {{
            "controller": [],
            "processor": [],
            "data_subject": []
          }},
          "purpose": "plain language purpose",
          "legal_basis": "plain language legal basis",
          "geographic_scope": [],
          "evidence_requirements": [],
          "verification_methods": [],
          "confidence_score": 0.8,
          "extraction_reasoning": "brief reasoning"
        }}
        
        CRITICAL VALIDATION:
        ✓ All actions from standard taxonomy
        ✓ NO assigner/assignee
        ✓ All comments detailed
        ✓ NO legal citations
        ✓ Logical consistency
        
        Return ONLY valid JSON.
        """

    @staticmethod
    def supervisor_review_prompt(
        extracted_components: str,
        original_guidance: str,
        rule_name: str
    ) -> str:
        """
        Supervisor agent review to validate and correct extracted ODRL components.
        Ensures STRICT action taxonomy compliance, detailed comments, and no assigner/assignee.
        """
        return f"""
        As the supervisor agent, review and validate the extracted ODRL components.
        Ensure STRICT compliance with action taxonomy and all requirements.

        RULE: {rule_name}

        ORIGINAL GUIDANCE:
        {original_guidance}

        EXTRACTED COMPONENTS:
        {extracted_components}

        ═══════════════════════════════════════════════════════════════════════
        SUPERVISOR VALIDATION CHECKLIST - EVERY ITEM MUST PASS
        ═══════════════════════════════════════════════════════════════════════

        1. ACTION TAXONOMY COMPLIANCE (CRITICAL):
        ✓ Check EVERY action in permissions, prohibitions, and duties
        ✓ Verify each action is EXACTLY one of: share, store, process, update, create
        ✓ If you find ANY other actions (distribute, archive, use, modify, derive, etc.), FIX them immediately:
           - "distribute" → "share"
           - "archive" → "store"
           - "use" → "process"
           - "modify" → "update"
           - "derive" → "create"
           - "transfer" → "share"
           - ANY other synonym → map to standard action
        
        2. ASSIGNER/ASSIGNEE REMOVAL:
        ✓ Verify NO "assigner" fields exist anywhere
        ✓ Verify NO "assignee" fields exist anywhere
        ✓ If found, REMOVE them completely

        3. COMMENT QUALITY:
        ✓ Every permission must have comment with 2-3+ sentences
        ✓ Every prohibition must have comment with 2-3+ sentences
        ✓ Every duty must have comment with 2-3+ sentences
        ✓ Each comment must explain: WHAT, WHY, WHEN, HOW
        ✓ If any comment is too short, ENHANCE it now

        4. LEGAL REFERENCE CHECK:
        ✓ Verify NO article citations (Article X, Section Y, etc.)
        ✓ Verify NO legal jargon or citations
        ✓ If found, convert to plain language

        5. LOGICAL CONSISTENCY:
        ✓ Permissions and prohibitions don't contradict
        ✓ Conditions are concrete and testable
        ✓ Data categories are specific
        ✓ Party roles are clear

        ═══════════════════════════════════════════════════════════════════════
        SUPERVISOR CORRECTIVE ACTION
        ═══════════════════════════════════════════════════════════════════════

        If you find ANY violations:
        1. FIX them immediately
        2. Document what was corrected
        3. Return the CORRECTED version

        Return a JSON object:
        {{
          "validation_passed": true/false,
          "corrections_made": [
            "list of corrections applied"
          ],
          "corrected_components": {{
            // Full corrected ODRL components
          }}
        }}

        The corrected components MUST have:
        - ALL actions as standard taxonomy (share/store/process/update/create)
        - NO assigner/assignee fields
        - ALL detailed comments (2-3+ sentences)
        - NO legal citations
        - Plain, testable language throughout
        """

    @staticmethod
    def final_synthesis_prompt(
        guidance_text: str,
        rule_name: str,
        framework_type: str,
        restriction_condition: str,
        initial_analysis: str,
        odrl_extraction: str,
        constraint_analysis: str,
        data_categories: str
    ) -> str:
        """
        Final synthesis with STRICT action taxonomy enforcement and logical consistency.
        This is an alias for odrl_synthesis_prompt for backward compatibility.
        """
        return PromptingStrategies.odrl_synthesis_prompt(
            guidance_text=guidance_text,
            rule_name=rule_name,
            framework_type=framework_type,
            restriction_condition=restriction_condition,
            initial_analysis=initial_analysis,
            odrl_extraction=odrl_extraction,
            constraint_analysis=constraint_analysis,
            data_categories=data_categories
        )

    # ============================================================================
    # INFERENCE PROMPTS (FOR PDF PROCESSING)
    # ============================================================================

    @staticmethod
    def role_inference_prompt(legislation_text: str) -> str:
        """Prompt for inferring primary impacted role from legislation text."""
        return f"""
        Analyze this legislation text and determine the primary role that is impacted or has obligations.

        TEXT:
        {legislation_text}

        INSTRUCTIONS:
        - Determine if the primary obligation falls on: controller, processor, joint_controller, or data_subject
        - Consider who has the main responsibility or obligation in this text
        - Focus on the party that must take action
        - DO NOT consider "assigner" or "assignee" - these are not relevant

        ROLE DEFINITIONS:
        - controller: Determines the purposes and means of data processing
        - processor: Processes data on behalf of the controller
        - joint_controller: Shares determination of purposes and means with another party
        - data_subject: The individual whose personal data is being processed

        Return ONLY one word: controller, processor, joint_controller, or data_subject
        """

    @staticmethod
    def data_role_inference_prompt(legislation_text: str) -> str:
        """Prompt for inferring primary data role from legislation text (alias for role_inference_prompt)."""
        return PromptingStrategies.role_inference_prompt(legislation_text)

    @staticmethod
    def data_category_inference_prompt(legislation_text: str) -> str:
        """Prompt for inferring data categories from legislation text."""
        return f"""
        Based on the following legislation text, identify which data categories are mentioned or implied:

        Text: {legislation_text}

        Identify any of these data categories that are mentioned or clearly implied in the text:
        - personal_data: General personal data
        - sensitive_data: Special categories of personal data
        - biometric_data: Biometric identifiers
        - health_data: Health and medical data
        - financial_data: Financial and payment data
        - location_data: Location and tracking data
        - behavioral_data: Behavioral profiling data
        - identification_data: Identity verification data
        - contact_data: Contact information
        - demographic_data: Age, gender, nationality
        - professional_data: Employment, education
        - transactional_data: Purchase history
        - communication_data: Emails, messages
        - device_data: IP addresses, device IDs

        Return a JSON array with the categories that are mentioned in the text.
        If no specific categories are mentioned but the text refers to "personal data" generally, return ["personal_data"].
        If no data categories can be identified, return ["personal_data"] as the default.

        Example response: ["personal_data", "sensitive_data"]
        
        Return ONLY the JSON array, no additional text.
        """

    @staticmethod
    def decision_inference_prompt(legislation_text: str, focused_analysis: str = "", agent_analysis: str = "") -> str:
        """Prompt for inferring decision scenarios with yes/no/maybe outcomes."""
        analyses_section = ""
        if focused_analysis:
            analyses_section += f"\n\nFOCUSED ANALYSIS:\n{focused_analysis}\n"
        if agent_analysis:
            analyses_section += f"\nAGENT ANALYSIS:\n{agent_analysis}\n"

        return f"""
        Analyze this legislation to identify decision points and their outcomes.
        {analyses_section}

        LEGISLATION TEXT:
        {legislation_text}

        LEGAL REFERENCE HANDLING:
        - Use your knowledge to understand any legal article references
        - Extract decision requirements without citing the articles
        - Focus on WHAT decision must be made, not WHERE it's written in law

        DECISION ANALYSIS TASKS:

        1. IDENTIFY DECISION POINTS:
        - Where does the legislation require a yes/no decision?
        - What questions must be answered?
        - What triggers the need for a decision?
        - Express decision criteria in plain language

        2. POSSIBLE OUTCOMES:
        - YES: What conditions lead to affirmative outcome?
        - NO: What conditions lead to negative outcome?
        - MAYBE/CONDITIONAL: What creates conditional outcomes?
        - Use concrete, testable conditions

        3. REQUIRED ACTIONS:
        - What actions must be taken for YES outcome?
        - What actions must be taken for NO outcome?
        - What actions must be taken for CONDITIONAL outcome?
        - Use standard action taxonomy (share, store, process, update, create)

        4. CONDITIONS AND CRITERIA:
        - What specific conditions determine outcomes?
        - How do multiple conditions combine?
        - What data points must be evaluated?
        - Make conditions testable and implementable

        OUTPUT:
        Return analysis in plain English identifying:
        - All decision points
        - Conditions for each outcome
        - Actions required for each outcome
        - Using standard action taxonomy only
        """

    @staticmethod
    def synthesis_prompt_template(
        legislation_text: str,
        article_reference: str,
        source_files: str,
        document_level: str,
        chunk_reference: str,
        existing_context: str,
        metadata_context: str,
        applicable_countries: str,
        adequacy_countries: str,
        focused_analysis: str,
        verified_analysis: str,
        agent_analysis: str,
        comprehensive_analysis: str,
        decision_analysis: str = ""
    ) -> str:
        """Template for synthesis prompt with all analyses including decisions (for PDF processing)."""
        chunk_context = f"\nCHUNK REFERENCE: {chunk_reference}\n" if chunk_reference else ""
        decision_context = f"\nDECISION ANALYSIS:\n{decision_analysis}\n" if decision_analysis else ""

        return f"""
        Based on the analyses below, create machine-readable rules with MAXIMUM COMPREHENSIVENESS including decision support.
        Extract EVERY possible rule, obligation, condition, requirement, and decision scenario from the legislation text.
        Create multiple rules if the text covers different aspects or scenarios.

        EXISTING RULES CONTEXT:
        {existing_context}

        METADATA CONTEXT:
        {metadata_context}{chunk_context}

        COMPREHENSIVE DOCUMENT ANALYSIS:
        {comprehensive_analysis}

        SOURCE LEGISLATION:
        Article: {article_reference}
        Document Level: {document_level}
        Source Files: {source_files}
        Text: {legislation_text}

        ANALYSIS RESULTS:

        Focused Analysis:
        {focused_analysis}

        Expert Verification:
        {verified_analysis}

        Agent Dual Action Analysis:
        {agent_analysis}
        {decision_context}

        ═══════════════════════════════════════════════════════════════════════
        CRITICAL ACTION TAXONOMY REQUIREMENT
        ═══════════════════════════════════════════════════════════════════════
        
        ALL actions in the output MUST use standard taxonomy:
        - share (for any transfer, distribution, disclosure)
        - store (for any retention, archiving, keeping)
        - process (for any use, analysis, transformation)
        - update (for any change, amendment, correction)
        - create (for any collection, generation, derivation)
        
        DO NOT use: distribute, archive, use, modify, derive, transfer, etc.
        
        ═══════════════════════════════════════════════════════════════════════

        COMPREHENSIVE EXTRACTION REQUIREMENTS:
        1. Extract EVERY obligation, requirement, prohibition, permission mentioned
        2. Create separate rules for different roles (controller, processor, data_subject, joint_controller)
        3. Create separate rules for different data categories mentioned
        4. Create separate rules for different scenarios or conditions
        5. Create rules for both positive obligations (must do) and negative obligations (must not do)
        6. Extract rules for different timeframes if mentioned (immediate, within X days, etc.)
        7. Create rules for different jurisdictions if multiple countries are mentioned
        8. Extract both explicit and reasonably implied obligations
        9. Focus on practical data operations and create actionable rules
        10. Create comprehensive conditions that capture all requirements
        11. Include decision scenarios with yes/no/maybe outcomes
        12. Link decisions to required actions for compliance
        13. Use ONLY standard action taxonomy for all actions

        SYNTHESIS REQUIREMENTS:
        1. Create rules in json-rules-engine format
        2. Each condition must reference the document level: "{document_level}"
        3. Each condition must include chunk_reference if applicable: {chunk_reference}
        4. MANDATORY: Each rule MUST have primary_impacted_role and data_category fields populated
        5. Actions must reference specific articles and be in simple English without document references
        6. Actions must focus on practical data operations (encryption, masking, access controls, etc.)
        7. User actions must be practical tasks individuals can perform
        8. Use exact enum values for all structured fields
        9. Timeline is optional - include only if mentioned in legislation
        10. Create rich, detailed conditions that can be programmatically evaluated
        11. Decisions must have clear outcomes and action mappings
        12. Cross-reference between rules, actions, and decisions
        13. ALL actions must use standard taxonomy (share, store, process, update, create)

        OUTPUT FORMAT:
        Return a JSON array of rule objects. Each rule must have:
        - id: Unique identifier
        - name: Clear, descriptive name in simple English
        - description: Full description without document references
        - source_article: Article reference
        - source_file: Source file path
        - conditions: Comprehensive json-rules-engine conditions
        - event: Event triggered when conditions met
        - actions: Array of rule actions (organizational level) - use standard taxonomy
        - user_actions: Array of user actions (individual level) - use standard taxonomy
        - decisions: Array of decision objects (if applicable)
        - priority: Priority level
        - primary_impacted_role: Primary role affected
        - secondary_impacted_role: Secondary role (if applicable)
        - data_category: Array of applicable data categories
        - applicable_countries: {applicable_countries}
        - adequacy_countries: {adequacy_countries}

        CRITICAL: Return ONLY valid JSON. No additional text or explanations outside the JSON structure.
        Ensure EVERY action uses standard taxonomy (share/store/process/update/create) and EVERY element has detailed comments.
        """
