# FalkorDB Analysis Queries - Data Transfer Reports

## üéØ Core Analysis Queries

### 1. Data Transfers with Personal Data (Originating ‚Üí Receiving)

```cypher
// Basic transfer list with personal data
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
RETURN DISTINCT
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    count(DISTINCT c) AS NumberOfCases
ORDER BY NumberOfCases DESC
```

### 2. Detailed Transfer View with All Personal Data

```cypher
// Comprehensive view with all personal data per transfer
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
RETURN 
    c.case_id AS CaseID,
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    c.eim_id AS EimID,
    c.business_app_id AS BusinessAppID
ORDER BY origin.name, dest.name
```

### 3. Transfer Matrix (Country ‚Üí Jurisdiction with Personal Data Count)

```cypher
// Create a transfer matrix showing volumes
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WITH origin, dest, count(DISTINCT c) AS cases, count(DISTINCT pd) AS unique_personal_data_types
RETURN 
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    cases AS NumberOfCases,
    unique_personal_data_types AS PersonalDataTypeCount
ORDER BY cases DESC
LIMIT 100
```

---

## üìã Module-Specific Queries (CM Value)

### 4. PIA Module = 'CM' Transfers

```cypher
// Cases where PIA module is CM
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE c.pia_module = 'CM'
RETURN 
    c.case_id AS CaseID,
    origin.name AS OriginatingCountry,
    collect(DISTINCT dest.name) AS ReceivingJurisdictions,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    c.pia_module AS PIA_Module,
    c.tia_module AS TIA_Module,
    c.hrpr_module AS HRPR_Module,
    c.eim_id AS EimID,
    c.business_app_id AS BusinessAppID
ORDER BY origin.name
```

#### Aggregated PIA CM Summary:
```cypher
// Summary statistics for PIA = CM
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE c.pia_module = 'CM'
RETURN 
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    count(DISTINCT c) AS Cases_PIA_CM,
    collect(DISTINCT pd.name) AS PersonalDataTypes
ORDER BY Cases_PIA_CM DESC
```

### 5. TIA Module = 'CM' Transfers

```cypher
// Cases where TIA module is CM
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE c.tia_module = 'CM'
RETURN 
    c.case_id AS CaseID,
    origin.name AS OriginatingCountry,
    collect(DISTINCT dest.name) AS ReceivingJurisdictions,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    c.pia_module AS PIA_Module,
    c.tia_module AS TIA_Module,
    c.hrpr_module AS HRPR_Module,
    c.eim_id AS EimID,
    c.business_app_id AS BusinessAppID
ORDER BY origin.name
```

#### Aggregated TIA CM Summary:
```cypher
// Summary statistics for TIA = CM
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE c.tia_module = 'CM'
RETURN 
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    count(DISTINCT c) AS Cases_TIA_CM,
    collect(DISTINCT pd.name) AS PersonalDataTypes
ORDER BY Cases_TIA_CM DESC
```

### 6. HRPR Module = 'CM' Transfers

```cypher
// Cases where HRPR module is CM
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE c.hrpr_module = 'CM'
RETURN 
    c.case_id AS CaseID,
    origin.name AS OriginatingCountry,
    collect(DISTINCT dest.name) AS ReceivingJurisdictions,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    c.pia_module AS PIA_Module,
    c.tia_module AS TIA_Module,
    c.hrpr_module AS HRPR_Module,
    c.eim_id AS EimID,
    c.business_app_id AS BusinessAppID
ORDER BY origin.name
```

#### Aggregated HRPR CM Summary:
```cypher
// Summary statistics for HRPR = CM
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE c.hrpr_module = 'CM'
RETURN 
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    count(DISTINCT c) AS Cases_HRPR_CM,
    collect(DISTINCT pd.name) AS PersonalDataTypes
ORDER BY Cases_HRPR_CM DESC
```

---

## üîç Combined Module Analysis

### 7. All Modules = 'CM' (Intersection)

```cypher
// Cases where ALL three modules are CM
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE c.pia_module = 'CM' 
  AND c.tia_module = 'CM' 
  AND c.hrpr_module = 'CM'
RETURN 
    c.case_id AS CaseID,
    origin.name AS OriginatingCountry,
    collect(DISTINCT dest.name) AS ReceivingJurisdictions,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    c.eim_id AS EimID,
    c.business_app_id AS BusinessAppID
ORDER BY origin.name
```

### 8. Any Module = 'CM' (Union)

```cypher
// Cases where ANY module is CM
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE c.pia_module = 'CM' 
   OR c.tia_module = 'CM' 
   OR c.hrpr_module = 'CM'
RETURN 
    c.case_id AS CaseID,
    origin.name AS OriginatingCountry,
    collect(DISTINCT dest.name) AS ReceivingJurisdictions,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    c.pia_module AS PIA_Module,
    c.tia_module AS TIA_Module,
    c.hrpr_module AS HRPR_Module
ORDER BY origin.name
```

### 9. Module Comparison Matrix

```cypher
// Compare CM counts across all three modules
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
RETURN 
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    count(DISTINCT CASE WHEN c.pia_module = 'CM' THEN c END) AS PIA_CM_Count,
    count(DISTINCT CASE WHEN c.tia_module = 'CM' THEN c END) AS TIA_CM_Count,
    count(DISTINCT CASE WHEN c.hrpr_module = 'CM' THEN c END) AS HRPR_CM_Count,
    count(DISTINCT c) AS Total_Cases
ORDER BY Total_Cases DESC
```

---

## üìä Advanced Analysis Queries

### 10. High-Risk Transfers (Multiple Personal Data Types)

```cypher
// Transfers with 5+ types of personal data
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WITH c, origin, dest, collect(DISTINCT pd.name) AS personal_data_list
WHERE size(personal_data_list) >= 5
RETURN 
    c.case_id AS CaseID,
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    personal_data_list AS PersonalDataNames,
    size(personal_data_list) AS PersonalDataCount,
    c.pia_module AS PIA_Module,
    c.tia_module AS TIA_Module,
    c.hrpr_module AS HRPR_Module
ORDER BY PersonalDataCount DESC
```

### 11. Transfers by Personal Data Category

```cypher
// Group by personal data category
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA_CATEGORY]->(pdc:PersonalDataCategory)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
RETURN 
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    pdc.name AS PersonalDataCategory,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    count(DISTINCT c) AS NumberOfCases
ORDER BY NumberOfCases DESC
```

### 12. Cross-Border Transfers Only

```cypher
// Only show transfers where origin != destination
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE origin.name <> dest.name
RETURN 
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    count(DISTINCT c) AS CrossBorderCases
ORDER BY CrossBorderCases DESC
```

### 13. Module Status Distribution

```cypher
// Distribution of module statuses for transfers with personal data
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
RETURN 
    c.pia_module AS PIA_Status,
    c.tia_module AS TIA_Status,
    c.hrpr_module AS HRPR_Status,
    count(DISTINCT c) AS CaseCount,
    collect(DISTINCT origin.name)[0..5] AS SampleOrigins,
    collect(DISTINCT dest.name)[0..5] AS SampleDestinations
ORDER BY CaseCount DESC
```

### 14. Purpose-based Transfer Analysis

```cypher
// Transfers grouped by legal processing purpose
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PURPOSE]->(p:Purpose)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
RETURN 
    origin.name AS OriginatingCountry,
    dest.name AS ReceivingJurisdiction,
    p.name AS ProcessingPurpose,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    count(DISTINCT c) AS NumberOfCases
ORDER BY NumberOfCases DESC
```

---

## üé® Visualization Queries

### 15. Top 10 Transfer Routes

```cypher
// Most common transfer routes
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WITH origin.name AS Origin, 
     dest.name AS Destination, 
     count(DISTINCT c) AS Transfers,
     collect(DISTINCT pd.name) AS PersonalData
ORDER BY Transfers DESC
LIMIT 10
RETURN Origin, Destination, Transfers, PersonalData
```

### 16. Network Graph of Transfers

```cypher
// Get full transfer network for visualization
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
RETURN origin, dest, c, pd
LIMIT 500
```

---

## üìà Statistical Queries

### 17. Overall Statistics

```cypher
// High-level statistics
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
RETURN 
    count(DISTINCT c) AS TotalCases,
    count(DISTINCT origin) AS UniqueOriginCountries,
    count(DISTINCT dest) AS UniqueDestinationJurisdictions,
    count(DISTINCT pd) AS UniquePersonalDataTypes,
    count(*) AS TotalTransferRelationships
```

### 18. Personal Data Frequency

```cypher
// Most commonly transferred personal data
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
RETURN 
    pd.name AS PersonalDataType,
    count(DISTINCT c) AS CaseCount,
    count(DISTINCT origin) AS OriginCountryCount,
    count(DISTINCT dest) AS DestinationCount
ORDER BY CaseCount DESC
```

---

## üîê Compliance Queries

### 19. Cases Missing Module Assessments

```cypher
// Cases with personal data but missing CM assessments
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE c.pia_module IS NULL 
   OR c.tia_module IS NULL 
   OR c.hrpr_module IS NULL
RETURN 
    c.case_id AS CaseID,
    origin.name AS OriginatingCountry,
    collect(DISTINCT dest.name) AS ReceivingJurisdictions,
    collect(DISTINCT pd.name) AS PersonalDataNames,
    c.pia_module AS PIA_Module,
    c.tia_module AS TIA_Module,
    c.hrpr_module AS HRPR_Module
ORDER BY c.case_id
```

### 20. EU/EEA Specific Transfers

```cypher
// Transfers involving EU/EEA jurisdictions
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
WHERE dest.name IN ['EU', 'EEA', 'UK', 'Switzerland']
RETURN 
    origin.name AS OriginatingCountry,
    dest.name AS EU_Jurisdiction,
    count(DISTINCT c) AS TransferCount,
    collect(DISTINCT pd.name) AS PersonalDataTypes,
    count(DISTINCT CASE WHEN c.pia_module = 'CM' THEN c END) AS PIA_CM_Count,
    count(DISTINCT CASE WHEN c.tia_module = 'CM' THEN c END) AS TIA_CM_Count
ORDER BY TransferCount DESC
```

---

## üíæ Export Queries (For CSV/Excel)

### 21. Complete Transfer Export

```cypher
// Export all transfer details (use with LIMIT for large datasets)
MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country)
MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction)
OPTIONAL MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData)
OPTIONAL MATCH (c)-[:HAS_PURPOSE]->(p:Purpose)
OPTIONAL MATCH (c)-[:HAS_CATEGORY]->(cat:Category)
RETURN 
    c.case_id,
    c.eim_id,
    c.business_app_id,
    origin.name AS originating_country,
    collect(DISTINCT dest.name) AS receiving_jurisdictions,
    collect(DISTINCT pd.name) AS personal_data_names,
    collect(DISTINCT p.name) AS purposes,
    collect(DISTINCT cat.name) AS categories,
    c.pia_module,
    c.tia_module,
    c.hrpr_module
ORDER BY c.case_id
LIMIT 10000
```

---

## üöÄ Quick Access Commands

### Run from Command Line:

```bash
# Basic transfer list
redis-cli GRAPH.QUERY DataTransferGraph "MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country) MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction) MATCH (c)-[:HAS_PERSONAL_DATA]->(pd:PersonalData) RETURN origin.name, dest.name, count(c) LIMIT 10"

# PIA CM cases
redis-cli GRAPH.QUERY DataTransferGraph "MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country) MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction) WHERE c.pia_module = 'CM' RETURN origin.name, dest.name, count(c) ORDER BY count(c) DESC LIMIT 20"

# TIA CM cases
redis-cli GRAPH.QUERY DataTransferGraph "MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country) MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction) WHERE c.tia_module = 'CM' RETURN origin.name, dest.name, count(c) ORDER BY count(c) DESC LIMIT 20"

# HRPR CM cases
redis-cli GRAPH.QUERY DataTransferGraph "MATCH (c:Case)-[:ORIGINATES_FROM]->(origin:Country) MATCH (c)-[:TRANSFERS_TO]->(dest:Jurisdiction) WHERE c.hrpr_module = 'CM' RETURN origin.name, dest.name, count(c) ORDER BY count(c) DESC LIMIT 20"
```

---

## üìù Notes

1. **Performance**: For large datasets, use `LIMIT` to test queries first
2. **NULL handling**: Personal data should not be NULL based on your schema, but use `OPTIONAL MATCH` if needed
3. **Aggregations**: Use `collect(DISTINCT ...)` to avoid duplicates in arrays
4. **Module values**: Queries assume 'CM' is the exact string. Adjust if it's different (e.g., 'cm', 'CM ', etc.)
5. **Export**: For large exports, run queries in batches using `SKIP` and `LIMIT`

### Example Batched Export:
```cypher
// Batch 1 (first 10K)
... LIMIT 10000

// Batch 2 (next 10K)
... SKIP 10000 LIMIT 10000

// Batch 3 (next 10K)
... SKIP 20000 LIMIT 10000
```
