// dashboard.js - Compliance Dashboard JavaScript

// Get API base URL - works for both local and deployed
const API_BASE = window.location.origin + '/api';
console.log('API Base URL:', API_BASE);

let allTransfers = [];
let filteredTransfers = [];
let charts = {};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => {
    console.log('Dashboard initializing...');
    testConnection();
    loadDashboardData();
    setupEventListeners();
});

// Test connection to backend
async function testConnection() {
    try {
        console.log('Testing connection to:', `${API_BASE}/health`);
        const response = await fetch(`${API_BASE}/health`);
        const data = await response.json();
        console.log('Health check response:', data);
        
        if (data.status === 'healthy') {
            console.log('✅ Backend connected successfully');
            console.log(`   Database has ${data.total_cases} cases`);
        } else {
            console.error('❌ Backend unhealthy:', data);
        }
    } catch (error) {
        console.error('❌ Connection test failed:', error);
        showError('Cannot connect to backend. Please ensure Flask is running on http://localhost:5000');
    }
}

// Setup event listeners
function setupEventListeners() {
    document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);
    document.getElementById('complianceFilter').addEventListener('change', applyFilters);
    document.getElementById('ruleFilter').addEventListener('change', applyFilters);
    document.getElementById('searchBox').addEventListener('input', applyFilters);
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
    document.getElementById('exportBtn').addEventListener('click', exportToCSV);
    
    // Compliance checker event listeners
    document.getElementById('checkComplianceBtn').addEventListener('click', checkCompliance);
    document.getElementById('findSimilarBtn').addEventListener('click', findSimilarCases);
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);
}

// Load all dashboard data
async function loadDashboardData() {
    showLoading(true);
    console.log('Loading dashboard data...');
    
    try {
        // Fetch data from API
        console.log('Fetching from:', `${API_BASE}/transfers`);
        const [transfersRes, summaryRes, ruleComplianceRes] = await Promise.all([
            fetch(`${API_BASE}/transfers`),
            fetch(`${API_BASE}/summary`),
            fetch(`${API_BASE}/compliance-by-rule`)
        ]);
        
        console.log('Responses received:', {
            transfers: transfersRes.status,
            summary: summaryRes.status,
            ruleCompliance: ruleComplianceRes.status
        });
        
        const transfersData = await transfersRes.json();
        const summaryData = await summaryRes.json();
        const ruleComplianceData = await ruleComplianceRes.json();
        
        console.log('Data parsed:', {
            transfersSuccess: transfersData.success,
            summarySuccess: summaryData.success,
            ruleComplianceSuccess: ruleComplianceData.success
        });
        
        if (transfersData.success) {
            allTransfers = transfersData.data;
            filteredTransfers = [...allTransfers];
            
            console.log(`✅ Loaded ${allTransfers.length} transfers`);
            
            // Update UI
            updateSummaryCards(summaryData.data);
            renderCharts(summaryData.data, ruleComplianceData.data);
            renderTable(filteredTransfers);
            updateLastUpdated();
        } else {
            console.error('Failed to load transfers:', transfersData.error);
            showError('Failed to load transfers data: ' + (transfersData.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showError('Error connecting to server. Please ensure the backend is running at ' + API_BASE);
    } finally {
        showLoading(false);
    }
}

// Compliance Checker Functions
async function checkCompliance() {
    const origin = document.getElementById('originCountry').value.trim();
    const destination = document.getElementById('destinationCountry').value.trim();
    const purpose = document.getElementById('purposeSelect').value;
    const hasPII = document.querySelector('input[name="hasPII"]:checked').value === 'true';
    
    if (!origin || !destination || !purpose) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/check-scenario`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                origin_country: origin,
                destination_country: destination,
                purpose: purpose,
                has_pii: hasPII
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayCheckerResults(data.data);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error checking compliance:', error);
        alert('Error checking compliance. Please try again.');
    }
}

function displayCheckerResults(result) {
    const resultsDiv = document.getElementById('checkerResults');
    const contentDiv = document.getElementById('resultsContent');
    
    const required = result.required_modules;
    
    let html = `
        <div class="result-item">
            <div class="result-label">Transfer Route</div>
            <div class="result-value">${result.origin_country} → ${result.destination_country}</div>
        </div>
        
        <div class="result-item">
            <div class="result-label">Processing Purpose</div>
            <div class="result-value">${result.purpose}</div>
        </div>
        
        <div class="result-item">
            <div class="result-label">Contains PII?</div>
            <div class="result-value">${result.has_pii ? 'Yes' : 'No'}</div>
        </div>
        
        <div class="result-item">
            <div class="result-label">Rule Matched</div>
            <div class="result-value"><strong>${result.rule_matched || 'None'}</strong></div>
        </div>
        
        <div class="result-item">
            <div class="rule-explanation">${result.explanation}</div>
        </div>
        
        <div class="result-item">
            <div class="result-label">Required Modules</div>
            <div class="required-modules">
                <span class="module-required ${required.PIA ? 'required-yes' : 'required-no'}">
                    PIA: ${required.PIA ? 'REQUIRED' : 'Not Required'}
                </span>
                <span class="module-required ${required.TIA ? 'required-yes' : 'required-no'}">
                    TIA: ${required.TIA ? 'REQUIRED' : 'Not Required'}
                </span>
                <span class="module-required ${required.HRPR ? 'required-yes' : 'required-no'}">
                    HRPR: ${required.HRPR ? 'REQUIRED' : 'Not Required'}
                </span>
            </div>
        </div>
    `;
    
    contentDiv.innerHTML = html;
    resultsDiv.classList.remove('hidden');
}

async function findSimilarCases() {
    const origin = document.getElementById('originCountry').value.trim();
    const destination = document.getElementById('destinationCountry').value.trim();
    const purpose = document.getElementById('purposeSelect').value;
    const hasPII = document.querySelector('input[name="hasPII"]:checked').value === 'true';
    
    if (!origin || !destination || !purpose) {
        alert('Please fill in all required fields to find similar cases');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/search-similar-cases`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                origin_country: origin,
                destination_country: destination,
                purpose: purpose,
                has_pii: hasPII
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displaySimilarCases(data);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error finding similar cases:', error);
        alert('Error finding similar cases. Please try again.');
    }
}

function displaySimilarCases(data) {
    const similarDiv = document.getElementById('similarCases');
    const contentDiv = document.getElementById('similarCasesContent');
    
    const cases = data.data;
    const scenarioRule = data.scenario_rule;
    const scenarioExplanation = data.scenario_explanation;
    const requiredModules = data.required_modules;
    
    if (cases.length === 0) {
        contentDiv.innerHTML = `
            <div style="background: #fffbeb; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <h4 style="margin-top: 0; color: #92400e;">No Similar Compliant Cases Found</h4>
                <p style="margin-bottom: 0; color: #78350f;">
                    Your scenario matches <strong>${scenarioRule}</strong> but no similar compliant cases 
                    with the same purpose exist in the database yet.
                </p>
            </div>
        `;
    } else {
        // Build header with scenario context
        let headerHtml = `
            <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
                <h4 style="margin-top: 0; color: #1e40af;">
                    Found ${cases.length} Compliant Case${cases.length !== 1 ? 's' : ''} Matching Your Scenario
                </h4>
                <p style="margin: 10px 0 5px 0; color: #1e40af;">
                    <strong>Scenario Rule:</strong> ${scenarioRule}
                </p>
                <p style="margin: 5px 0; color: #1e40af;">
                    <strong>Explanation:</strong> ${scenarioExplanation}
                </p>
                <div style="margin-top: 10px;">
                    <strong style="color: #1e40af;">Required Modules:</strong>
                    <span class="module-required ${requiredModules.PIA ? 'required-yes' : 'required-no'}" style="margin-left: 10px;">
                        PIA: ${requiredModules.PIA ? 'REQUIRED' : 'Not Required'}
                    </span>
                    <span class="module-required ${requiredModules.TIA ? 'required-yes' : 'required-no'}">
                        TIA: ${requiredModules.TIA ? 'REQUIRED' : 'Not Required'}
                    </span>
                    <span class="module-required ${requiredModules.HRPR ? 'required-yes' : 'required-no'}">
                        HRPR: ${requiredModules.HRPR ? 'REQUIRED' : 'Not Required'}
                    </span>
                </div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #3730a3;">
                    ℹ️ These are examples of <strong>compliant</strong> transfers with the same purpose that follow the same rule.
                </p>
            </div>
        `;
        
        // Build cases list
        let casesHtml = cases.map(c => `
            <div class="similar-case-item">
                <div class="similar-case-header">
                    <span style="color: #059669; margin-right: 10px;">✓</span>
                    Case: ${c.case_id}
                </div>
                <div class="similar-case-details">
                    <span><strong>Route:</strong> ${c.origin} → ${c.destination}</span>
                    <span><strong>Purpose:</strong> ${c.purpose}</span>
                </div>
                <div class="similar-case-details" style="margin-top: 8px;">
                    <span class="module-badge ${c.pia_module === 'CM' ? 'module-cm' : 'module-not-cm'}">
                        PIA: ${c.pia_module || 'N/A'}
                    </span>
                    <span class="module-badge ${c.tia_module === 'CM' ? 'module-cm' : 'module-not-cm'}">
                        TIA: ${c.tia_module || 'N/A'}
                    </span>
                    <span class="module-badge ${c.hrpr_module === 'CM' ? 'module-cm' : 'module-not-cm'}">
                        HRPR: ${c.hrpr_module || 'N/A'}
                    </span>
                </div>
            </div>
        `).join('');
        
        contentDiv.innerHTML = headerHtml + '<div style="max-height: 500px; overflow-y: auto;">' + casesHtml + '</div>';
    }
    
    similarDiv.classList.remove('hidden');
}

function clearForm() {
    document.getElementById('originCountry').value = '';
    document.getElementById('destinationCountry').value = '';
    document.getElementById('purposeSelect').value = '';
    document.querySelector('input[name="hasPII"][value="true"]').checked = true;
    
    document.getElementById('checkerResults').classList.add('hidden');
    document.getElementById('similarCases').classList.add('hidden');
}

// Update summary cards
function updateSummaryCards(summary) {
    document.getElementById('totalTransfers').textContent = summary.total_transfers.toLocaleString();
    document.getElementById('compliantCount').textContent = summary.compliant.toLocaleString();
    document.getElementById('nonCompliantCount').textContent = summary.non_compliant.toLocaleString();
    document.getElementById('complianceRate').textContent = `${summary.compliance_rate}%`;
}

// Render charts
function renderCharts(summary, ruleCompliance) {
    renderComplianceChart(summary);
    renderMissingModulesChart(summary);
    renderRuleComplianceChart(ruleCompliance);
}

// Compliance Overview Chart
function renderComplianceChart(summary) {
    const ctx = document.getElementById('complianceChart').getContext('2d');
    
    if (charts.compliance) {
        charts.compliance.destroy();
    }
    
    charts.compliance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Compliant', 'Non-Compliant'],
            datasets: [{
                data: [summary.compliant, summary.non_compliant],
                backgroundColor: ['#10b981', '#ef4444'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Missing Modules Chart
function renderMissingModulesChart(summary) {
    const ctx = document.getElementById('missingModulesChart').getContext('2d');
    
    if (charts.missingModules) {
        charts.missingModules.destroy();
    }
    
    charts.missingModules = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['PIA', 'TIA', 'HRPR'],
            datasets: [{
                label: 'Missing CM Assessments',
                data: [
                    summary.missing_modules.PIA,
                    summary.missing_modules.TIA,
                    summary.missing_modules.HRPR
                ],
                backgroundColor: ['#ef4444', '#f59e0b', '#ec4899'],
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.parsed.y.toLocaleString()} cases missing`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });
}

// Rule Compliance Chart
function renderRuleComplianceChart(ruleCompliance) {
    const ctx = document.getElementById('ruleComplianceChart').getContext('2d');
    
    if (charts.ruleCompliance) {
        charts.ruleCompliance.destroy();
    }
    
    const rules = Object.keys(ruleCompliance).sort();
    const compliantData = rules.map(rule => ruleCompliance[rule].compliant);
    const nonCompliantData = rules.map(rule => ruleCompliance[rule].non_compliant);
    
    charts.ruleCompliance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: rules,
            datasets: [
                {
                    label: 'Compliant',
                    data: compliantData,
                    backgroundColor: '#10b981',
                    borderRadius: 6
                },
                {
                    label: 'Non-Compliant',
                    data: nonCompliantData,
                    backgroundColor: '#ef4444',
                    borderRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { padding: 15 }
                },
                tooltip: {
                    callbacks: {
                        title: (context) => {
                            const rule = context[0].label;
                            return ruleCompliance[rule].explanation;
                        },
                        label: (context) => {
                            return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });
}

// Render data table
function renderTable(transfers) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    if (transfers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 30px;">No transfers found</td></tr>';
        document.getElementById('filteredCount').textContent = '0';
        return;
    }
    
    transfers.forEach(transfer => {
        const row = document.createElement('tr');
        
        const compliance = transfer.compliance;
        const statusClass = compliance.compliant ? 'status-compliant' : 'status-non-compliant';
        const statusText = compliance.compliant ? '✓ Compliant' : '✗ Non-Compliant';
        
        const personalDataText = transfer.personal_data.length > 0 
            ? transfer.personal_data.slice(0, 3).join(', ') + (transfer.personal_data.length > 3 ? '...' : '')
            : 'None';
        
        const missingText = compliance.missing_modules.length > 0
            ? compliance.missing_modules.join(', ')
            : '-';
        
        row.innerHTML = `
            <td><strong>${transfer.case_id}</strong></td>
            <td>${transfer.origin_country}</td>
            <td>${transfer.destination_country}</td>
            <td class="personal-data-list" title="${transfer.personal_data.join(', ')}">${personalDataText}</td>
            <td><span class="module-badge ${transfer.pia_module === 'CM' ? 'module-cm' : 'module-not-cm'}">${transfer.pia_module || 'N/A'}</span></td>
            <td><span class="module-badge ${transfer.tia_module === 'CM' ? 'module-cm' : 'module-not-cm'}">${transfer.tia_module || 'N/A'}</span></td>
            <td><span class="module-badge ${transfer.hrpr_module === 'CM' ? 'module-cm' : 'module-not-cm'}">${transfer.hrpr_module || 'N/A'}</span></td>
            <td><small>${compliance.rule_matched || 'N/A'}</small></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td><small>${missingText}</small></td>
        `;
        
        // Highlight non-compliant rows
        if (!compliance.compliant) {
            row.style.backgroundColor = '#fef2f2';
        }
        
        tbody.appendChild(row);
    });
    
    document.getElementById('filteredCount').textContent = transfers.length.toLocaleString();
}

// Apply filters
function applyFilters() {
    const complianceFilter = document.getElementById('complianceFilter').value;
    const ruleFilter = document.getElementById('ruleFilter').value;
    const searchText = document.getElementById('searchBox').value.toLowerCase();
    
    filteredTransfers = allTransfers.filter(transfer => {
        // Compliance filter
        if (complianceFilter === 'compliant' && !transfer.compliance.compliant) return false;
        if (complianceFilter === 'non-compliant' && transfer.compliance.compliant) return false;
        
        // Rule filter
        if (ruleFilter !== 'all' && transfer.compliance.rule_matched !== ruleFilter) return false;
        
        // Search filter
        if (searchText) {
            const searchableText = [
                transfer.case_id,
                transfer.origin_country,
                transfer.destination_country,
                transfer.eim_id,
                transfer.business_app_id,
                ...transfer.personal_data
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(searchText)) return false;
        }
        
        return true;
    });
    
    renderTable(filteredTransfers);
}

// Clear filters
function clearFilters() {
    document.getElementById('complianceFilter').value = 'all';
    document.getElementById('ruleFilter').value = 'all';
    document.getElementById('searchBox').value = '';
    filteredTransfers = [...allTransfers];
    renderTable(filteredTransfers);
}

// Export to CSV
function exportToCSV() {
    const headers = [
        'Case ID', 'Origin Country', 'Destination Country', 'Personal Data',
        'PIA Module', 'TIA Module', 'HRPR Module', 'EIM ID', 'Business App ID',
        'Rule Matched', 'Compliant', 'Missing Modules', 'Explanation'
    ];
    
    const rows = filteredTransfers.map(t => [
        t.case_id,
        t.origin_country,
        t.destination_country,
        t.personal_data.join('; '),
        t.pia_module || '',
        t.tia_module || '',
        t.hrpr_module || '',
        t.eim_id || '',
        t.business_app_id || '',
        t.compliance.rule_matched || '',
        t.compliance.compliant ? 'Yes' : 'No',
        t.compliance.missing_modules.join('; '),
        t.compliance.explanation
    ]);
    
    let csvContent = headers.join(',') + '\n';
    rows.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `compliance_report_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Show/hide loading indicator
function showLoading(show) {
    const loading = document.getElementById('loadingIndicator');
    if (show) {
        loading.classList.add('active');
    } else {
        loading.classList.remove('active');
    }
}

// Show error message
function showError(message) {
    alert('ERROR: ' + message);
    console.error('Dashboard Error:', message);
}

// Update last updated timestamp
function updateLastUpdated() {
    const now = new Date();
    const formatted = now.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('lastUpdated').textContent = formatted;
}
