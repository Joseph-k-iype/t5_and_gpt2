import json
import csv
import os

def convert_json_to_csv(data: dict, output_dir: str):
    """
    Converts the unified legal JSON output into four separate CSV files
    within a specified output directory.

    Args:
        data (dict): The dictionary loaded from the JSON file.
        output_dir (str): The path to the folder for output files.
    """
    # --- 1. Process 'unified_simplified_rules' ---
    simplified_rules = data.get("unified_simplified_rules", [])
    if simplified_rules:
        # Define output path using os.path.join for compatibility
        output_path = os.path.join(output_dir, 'simplified_rules.csv')
        with open(output_path, 'w', newline='', encoding='utf-8') as f:
            fieldnames = list(simplified_rules[0].keys())
            writer = csv.DictWriter(f, fieldnames=fieldnames)
            writer.writeheader()
            
            for rule in simplified_rules:
                if isinstance(rule.get('conditions'), list):
                    rule['conditions'] = "; ".join(rule['conditions'])
                if isinstance(rule.get('key_phrases'), list):
                    rule['key_phrases'] = "; ".join(map(str, rule['key_phrases']))
                writer.writerow(rule)
        print(f"‚úÖ Successfully created {output_path}")

    # --- 2, 3, & 4. Process 'unified_decision_tables' ---
    decision_tables_data = data.get("unified_decision_tables", {}).get("decision_tables", [])
    if decision_tables_data:
        tables_metadata_rows, table_rules_rows, table_references_rows = [], [], []

        for table in decision_tables_data:
            table_id = table.get("table_id")
            
            tables_metadata_rows.append({
                "table_id": table_id,
                "name": table.get("name"),
                "description": table.get("description"),
                "conditions_definitions": json.dumps(table.get("conditions", {}))
            })

            for rule in table.get("rules", []):
                rule_id = rule.get("rule_id")
                
                table_rules_rows.append({
                    "table_id": table_id,
                    "rule_id": rule_id,
                    "priority": rule.get("priority"),
                    "source_rule": rule.get("source_rule"),
                    "rule_conditions": "; ".join([f"{k}:{v}" for k, v in rule.get("conditions", {}).items()]),
                    "actions": "; ".join(rule.get("actions", []))
                })

                for reference in rule.get("references", []):
                    reference['table_id'] = table_id
                    reference['rule_id'] = rule_id
                    table_references_rows.append(reference)

        # Write decision_tables.csv
        if tables_metadata_rows:
            output_path = os.path.join(output_dir, 'decision_tables.csv')
            with open(output_path, 'w', newline='', encoding='utf-8') as f:
                writer = csv.DictWriter(f, fieldnames=tables_metadata_rows[0].keys())
                writer.writeheader()
                writer.writerows(tables_metadata_rows)
            print(f"‚úÖ Successfully created {output_path}")

        # Write decision_table_rules.csv
        if table_rules_rows:
            output_path = os.path.join(output_dir, 'decision_table_rules.csv')
            with open(output_path, 'w', newline='', encoding='utf-8') as f:
                writer = csv.DictWriter(f, fieldnames=table_rules_rows[0].keys())
                writer.writeheader()
                writer.writerows(table_rules_rows)
            print(f"‚úÖ Successfully created {output_path}")
            
        # Write decision_table_references.csv
        if table_references_rows:
            output_path = os.path.join(output_dir, 'decision_table_references.csv')
            all_headers = set().union(*(d.keys() for d in table_references_rows))
            fieldnames = ['table_id', 'rule_id'] + sorted([h for h in all_headers if h not in ['table_id', 'rule_id']])
            
            with open(output_path, 'w', newline='', encoding='utf-8') as f:
                writer = csv.DictWriter(f, fieldnames=fieldnames, extrasaction='ignore')
                writer.writeheader()
                writer.writerows(table_references_rows)
            print(f"‚úÖ Successfully created {output_path}")

# --- Main Execution ---
if __name__ == "__main__":
    # Define the directory for input and output
    io_directory = 'output'
    
    # Create the directory if it doesn't exist
    os.makedirs(io_directory, exist_ok=True)
    
    # Define the full path to the input file
    input_filename = os.path.join(io_directory, 'input.json')

    try:
        with open(input_filename, 'r', encoding='utf-8') as f:
            json_data = json.load(f)
        
        # Pass the directory to the conversion function
        convert_json_to_csv(json_data, io_directory)

    except FileNotFoundError:
        print(f"‚ùå Error: The file '{input_filename}' was not found.")
        print(f"üëâ Please place your JSON file inside the '{io_directory}' folder and name it 'input.json'.")
    except json.JSONDecodeError:
        print(f"‚ùå Error: The file '{input_filename}' is not a valid JSON file.")
    except Exception as e:
        print(f"An unexpected error occurred: {e}")
