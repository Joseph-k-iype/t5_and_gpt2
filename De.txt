import json
import csv

def convert_json_to_csv(json_data):
    """
    Converts a complex legal JSON structure into three separate CSV files.

    Args:
        json_data (dict): The dictionary loaded from the JSON data.
    """
    # --- 1. Process 'simplified_rules' ---
    simplified_rules = json_data.get("simplified_rules", [])
    if simplified_rules:
        with open('simplified_rules.csv', 'w', newline='', encoding='utf-8') as f:
            # The 'conditions' key is a list, so we'll get all other keys first.
            fieldnames = [key for key in simplified_rules[0].keys() if key != 'conditions']
            # Add the 'conditions' key back for the header.
            fieldnames.append('conditions')
            
            writer = csv.DictWriter(f, fieldnames=fieldnames)
            writer.writeheader()
            for rule in simplified_rules:
                # Join the list of conditions into a single string
                rule['conditions'] = "; ".join(rule.get('conditions', []))
                writer.writerow(rule)
        print("✅ Successfully created simplified_rules.csv")

    # --- 2. & 3. Process 'decision_tables' and their nested rules ---
    decision_tables_data = json_data.get("decision_tables", {}).get("decision_tables", [])
    if decision_tables_data:
        tables_metadata_rows = []
        table_rules_rows = []

        for table in decision_tables_data:
            tables_metadata_rows.append({
                "table_id": table.get("table_id"),
                "name": table.get("name"),
                "description": table.get("description"),
            })

            for rule in table.get("rules", []):
                conditions_str = "; ".join([f"{k}:{v}" for k, v in rule.get("conditions", {}).items()])
                actions_str = "; ".join(rule.get("actions", []))
                reference = rule.get("references", [{}])[0]

                table_rules_rows.append({
                    "table_id": table.get("table_id"),
                    "rule_id": rule.get("rule_id"),
                    "priority": rule.get("priority"),
                    "source_rule": rule.get("source_rule"),
                    "conditions": conditions_str,
                    "actions": actions_str,
                    "ref_document": reference.get("document"),
                    "ref_section": reference.get("section"),
                    "ref_document_title": reference.get("document_title"),
                    "ref_jurisdiction": reference.get("jurisdiction"),
                    "ref_confidence": reference.get("confidence"),
                })
        
        with open('decision_tables.csv', 'w', newline='', encoding='utf-8') as f:
            fieldnames = ["table_id", "name", "description"]
            writer = csv.DictWriter(f, fieldnames=fieldnames)
            writer.writeheader()
            writer.writerows(tables_metadata_rows)
        print("✅ Successfully created decision_tables.csv")
        
        with open('decision_table_rules.csv', 'w', newline='', encoding='utf-8') as f:
            if table_rules_rows:
                fieldnames = table_rules_rows[0].keys()
                writer = csv.DictWriter(f, fieldnames=fieldnames)
                writer.writeheader()
                writer.writerows(table_rules_rows)
        print("✅ Successfully created decision_table_rules.csv")


# --- Main Execution ---
if __name__ == "__main__":
    input_filename = 'input.json'
    try:
        # Open and load the JSON file from disk
        with open(input_filename, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # Call the conversion function with the loaded data
        convert_json_to_csv(data)

    except FileNotFoundError:
        print(f"❌ Error: The file '{input_filename}' was not found.")
    except json.JSONDecodeError:
        print(f"❌ Error: The file '{input_filename}' is not a valid JSON file.")
