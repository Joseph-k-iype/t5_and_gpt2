prefix collibra: <http://collibra.com/>
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>

construct {
  # All triples in the subgraph
  ?s ?p ?o .
  
  # All type assertions
  ?s a ?type .
  ?o a ?otype .
  
  # Include schema information if available
  ?type rdfs:label ?typeLabel .
  ?p rdfs:label ?propLabel .
} where {
  # Define the starting set: all Reports
  {
    SELECT DISTINCT ?start WHERE {
      ?start a collibra:Report .
    }
  }
  
  # Get all connected resources
  {
    # Forward traversal from Reports
    ?start ?p1 ?connected1 .
    OPTIONAL {
      FILTER(isIRI(?connected1))
      ?connected1 ?p2 ?connected2 .
      OPTIONAL {
        FILTER(isIRI(?connected2))
        ?connected2 ?p3 ?connected3 .
      }
    }
    
    # Bind subjects
    BIND(COALESCE(?connected3, ?connected2, ?connected1, ?start) as ?s)
  }
  
  # Get all properties of discovered subjects
  ?s ?p ?o .
  
  # Get all type information
  OPTIONAL { ?s a ?type }
  OPTIONAL { ?o a ?otype }
  
  # Get schema labels if available
  OPTIONAL { ?type rdfs:label ?typeLabel }
  OPTIONAL { ?p rdfs:label ?propLabel }
}
