"""
HSBC OpenAI Client Wrapper
Creates OpenAI-compatible client that works with HSBC's internal API
Compatible with OpenAI SDK, LangChain, and LangGraph
Uses error-driven token refresh
"""
import logging
from typing import Optional
from openai import OpenAI, AuthenticationError, APIError
import httpx

from hsbc_auth import HSBCTokenManager

logger = logging.getLogger(__name__)


class HSBCOpenAIClient:
    """
    OpenAI-compatible client for HSBC internal APIs.
    
    This wrapper handles:
    - Token translation via HSBC API
    - Automatic token refresh on authentication errors
    - Custom header injection (X-HSBC-E2E-Trust-Token, Token_Type)
    - Base URL configuration for HSBC endpoints
    """
    
    def __init__(
        self,
        token_api_url: str,
        base_url: str,
        username: str,
        password: str,
        user_id: str = "UC0002731",
        default_model: str = "o3-mini",
        timeout: int = 120,
        max_retries: int = 2
    ):
        """
        Initialize HSBC OpenAI Client
        
        Args:
            token_api_url: HSBC token translation endpoint
            base_url: HSBC base URL for OpenAI-compatible API
            username: HSBC username
            password: HSBC password
            user_id: HSBC user ID for chat completions
            default_model: Default model name
            timeout: Request timeout in seconds
            max_retries: Max retries on auth errors (with token refresh)
        """
        self.token_manager = HSBCTokenManager(
            token_api_url=token_api_url,
            username=username,
            password=password
        )
        
        self.base_url = base_url
        self.user_id = user_id
        self.default_model = default_model
        self.timeout = timeout
        self.max_retries = max_retries
        
        # Get initial token
        self.token_manager.get_token()
        
        logger.info("HSBC OpenAI Client initialized")
        logger.info(f"  Base URL: {base_url}")
        logger.info(f"  User ID: {user_id}")
        logger.info(f"  Default Model: {default_model}")
        logger.info(f"  Auto-retry on auth errors: {max_retries} attempts")
    
    def get_client(self) -> OpenAI:
        """
        Get OpenAI client configured for HSBC APIs.
        Returns a standard OpenAI client - token refresh happens automatically on errors.
        
        Returns:
            OpenAI client instance with HSBC configuration
        """
        # Get current token
        issued_token = self.token_manager.get_token()
        
        # Create custom HTTP client with HSBC headers
        http_client = httpx.Client(
            headers={
                "X-HSBC-E2E-Trust-Token": issued_token,
                "Token_Type": "SESSION_TOKEN",
                "Content-Type": "application/json"
            },
            timeout=self.timeout,
            verify=False  # Adjust based on HSBC cert requirements
        )
        
        # Create OpenAI client with custom base URL and headers
        client = OpenAI(
            api_key=issued_token,  # Token also goes here for compatibility
            base_url=self.base_url,
            http_client=http_client,
            default_headers={
                "X-HSBC-E2E-Trust-Token": issued_token,
                "Token_Type": "SESSION_TOKEN"
            }
        )
        
        logger.debug("OpenAI client created with HSBC configuration")
        return client
    
    def chat_completion_with_retry(self, **kwargs):
        """
        Make chat completion call with automatic token refresh on auth errors.
        
        Args:
            **kwargs: Arguments to pass to client.chat.completions.create()
            
        Returns:
            Chat completion response
            
        Raises:
            Exception: If all retry attempts fail
        """
        attempt = 0
        last_error = None
        
        while attempt <= self.max_retries:
            try:
                attempt += 1
                
                # Get fresh client (will use current token)
                client = self.get_client()
                
                # Make the API call
                response = client.chat.completions.create(**kwargs)
                
                if attempt > 1:
                    logger.info(f"✓ Request succeeded after token refresh (attempt {attempt})")
                
                return response
                
            except AuthenticationError as e:
                last_error = e
                logger.warning(f"Authentication error on attempt {attempt}: {e}")
                
                if attempt <= self.max_retries:
                    logger.info("Refreshing token and retrying...")
                    # Refresh token for next attempt
                    self.token_manager.handle_auth_error(str(e))
                else:
                    logger.error(f"Authentication failed after {self.max_retries + 1} attempts")
                    
            except APIError as e:
                # Check if it's an auth-related API error
                if e.status_code in [401, 403]:
                    last_error = e
                    logger.warning(f"API auth error (status {e.status_code}) on attempt {attempt}")
                    
                    if attempt <= self.max_retries:
                        logger.info("Refreshing token and retrying...")
                        self.token_manager.handle_auth_error(str(e))
                    else:
                        logger.error(f"API auth error persists after {self.max_retries + 1} attempts")
                else:
                    # Non-auth API error - don't retry
                    logger.error(f"API error (non-auth): {e}")
                    raise
                    
            except Exception as e:
                # Unexpected error - don't retry
                logger.error(f"Unexpected error: {e}")
                raise
        
        # All retries exhausted
        raise Exception(f"Request failed after {self.max_retries + 1} attempts: {last_error}")
    
    def get_api_key(self) -> str:
        """
        Get current issued token (for use as API key).
        
        Returns:
            Current issued token
        """
        return self.token_manager.get_token()
    
    def get_base_url(self) -> str:
        """
        Get base URL for chat completions.
        
        Returns:
            Base URL string
        """
        return self.base_url
    
    def refresh_token(self) -> None:
        """Force token refresh."""
        self.token_manager.get_token(force_refresh=True)
        logger.info("Token manually refreshed")
    
    def invalidate_token(self) -> None:
        """Invalidate current token (will refresh on next request)."""
        self.token_manager.invalidate_token()


def create_hsbc_client(
    token_api_url: str,
    base_url: str,
    username: str,
    password: str,
    **kwargs
) -> HSBCOpenAIClient:
    """
    Factory function to create HSBC OpenAI client.
    
    Args:
        token_api_url: HSBC token translation endpoint
        base_url: HSBC base URL for OpenAI-compatible API
        username: HSBC username
        password: HSBC password
        **kwargs: Additional arguments for HSBCOpenAIClient
        
    Returns:
        Configured HSBCOpenAIClient instance
    """
    return HSBCOpenAIClient(
        token_api_url=token_api_url,
        base_url=base_url,
        username=username,
        password=password,
        **kwargs
    )


class HSBCOpenAIClient:
    """
    OpenAI-compatible client for HSBC internal APIs.
    
    This wrapper handles:
    - Token translation via HSBC API
    - Automatic token refresh on authentication errors
    - Custom header injection (X-HSBC-E2E-Trust-Token, Token_Type)
    - Base URL configuration for HSBC endpoints
    """
    
    def __init__(
        self,
        token_api_url: str,
        base_url: str,
        username: str,
        password: str,
        user_id: str = "UC0002731",
        default_model: str = "o3-mini",
        timeout: int = 120,
        max_retries: int = 2
    ):
        """
        Initialize HSBC OpenAI Client
        
        Args:
            token_api_url: HSBC token translation endpoint
            base_url: HSBC base URL for OpenAI-compatible API
            username: HSBC username
            password: HSBC password
            user_id: HSBC user ID for chat completions
            default_model: Default model name
            timeout: Request timeout in seconds
            max_retries: Max retries on auth errors (with token refresh)
        """
        self.token_manager = HSBCTokenManager(
            token_api_url=token_api_url,
            username=username,
            password=password
        )
        
        self.base_url = base_url
        self.user_id = user_id
        self.default_model = default_model
        self.timeout = timeout
        self.max_retries = max_retries
        
        # Get initial token
        self.token_manager.get_token()
        
        logger.info("HSBC OpenAI Client initialized")
        logger.info(f"  Base URL: {base_url}")
        logger.info(f"  User ID: {user_id}")
        logger.info(f"  Default Model: {default_model}")
        logger.info(f"  Auto-retry on auth errors: {max_retries} attempts")
    
    def get_client(self) -> OpenAI:
        """
        Get OpenAI client configured for HSBC APIs.
        Returns a standard OpenAI client - token refresh happens automatically on errors.
        
        Returns:
            OpenAI client instance with HSBC configuration
        """
        # Get current token
        issued_token = self.token_manager.get_token()
        
        # Create custom HTTP client with HSBC headers
        http_client = httpx.Client(
            headers={
                "X-HSBC-E2E-Trust-Token": issued_token,
                "Token_Type": "SESSION_TOKEN",
                "Content-Type": "application/json"
            },
            timeout=self.timeout,
            verify=False  # Adjust based on HSBC cert requirements
        )
        
        # Create OpenAI client with custom base URL and headers
        client = OpenAI(
            api_key=issued_token,  # Token also goes here for compatibility
            base_url=self.base_url,
            http_client=http_client,
            default_headers={
                "X-HSBC-E2E-Trust-Token": issued_token,
                "Token_Type": "SESSION_TOKEN"
            }
        )
        
        logger.debug("OpenAI client created with HSBC configuration")
        return client
    
    def chat_completion_with_retry(self, **kwargs):
        """
        Make chat completion call with automatic token refresh on auth errors.
        
        Args:
            **kwargs: Arguments to pass to client.chat.completions.create()
            
        Returns:
            Chat completion response
            
        Raises:
            Exception: If all retry attempts fail
        """
        attempt = 0
        last_error = None
        
        while attempt <= self.max_retries:
            try:
                attempt += 1
                
                # Get fresh client (will use current token)
                client = self.get_client()
                
                # Make the API call
                response = client.chat.completions.create(**kwargs)
                
                if attempt > 1:
                    logger.info(f"✓ Request succeeded after token refresh (attempt {attempt})")
                
                return response
                
            except AuthenticationError as e:
                last_error = e
                logger.warning(f"Authentication error on attempt {attempt}: {e}")
                
                if attempt <= self.max_retries:
                    logger.info("Refreshing token and retrying...")
                    # Refresh token for next attempt
                    self.token_manager.handle_auth_error(str(e))
                else:
                    logger.error(f"Authentication failed after {self.max_retries + 1} attempts")
                    
            except APIError as e:
                # Check if it's an auth-related API error
                if e.status_code in [401, 403]:
                    last_error = e
                    logger.warning(f"API auth error (status {e.status_code}) on attempt {attempt}")
                    
                    if attempt <= self.max_retries:
                        logger.info("Refreshing token and retrying...")
                        self.token_manager.handle_auth_error(str(e))
                    else:
                        logger.error(f"API auth error persists after {self.max_retries + 1} attempts")
                else:
                    # Non-auth API error - don't retry
                    logger.error(f"API error (non-auth): {e}")
                    raise
                    
            except Exception as e:
                # Unexpected error - don't retry
                logger.error(f"Unexpected error: {e}")
                raise
        
        # All retries exhausted
        raise Exception(f"Request failed after {self.max_retries + 1} attempts: {last_error}")
    
    def get_api_key(self) -> str:
        """
        Get current issued token (for use as API key).
        
        Returns:
            Current issued token
        """
        return self.token_manager.get_token()
    
    def get_base_url(self) -> str:
        """
        Get base URL for chat completions.
        
        Returns:
            Base URL string
        """
        return self.base_url
    
    def refresh_token(self) -> None:
        """Force token refresh."""
        self.token_manager.get_token(force_refresh=True)
        logger.info("Token manually refreshed")
    
    def invalidate_token(self) -> None:
        """Invalidate current token (will refresh on next request)."""
        self.token_manager.invalidate_token()


def create_hsbc_client(
    token_api_url: str,
    base_url: str,
    username: str,
    password: str,
    **kwargs
) -> HSBCOpenAIClient:
    """
    Factory function to create HSBC OpenAI client.
    
    Args:
        token_api_url: HSBC token translation endpoint
        base_url: HSBC base URL for OpenAI-compatible API
        username: HSBC username
        password: HSBC password
        **kwargs: Additional arguments for HSBCOpenAIClient
        
    Returns:
        Configured HSBCOpenAIClient instance
    """
    return HSBCOpenAIClient(
        token_api_url=token_api_url,
        base_url=base_url,
        username=username,
        password=password,
        **kwargs
    )
