"""
HSBC OpenAI Client wrapper
Wraps OpenAI client with HSBC authentication
Location: src/services/hsbc_openai_client.py
"""
import logging
from typing import Optional, Any, Dict, List
from openai import OpenAI, APIError, AuthenticationError

from .hsbc_token_service import HSBCTokenService
from ..config import Config

logger = logging.getLogger(__name__)


class HSBCOpenAIClient:
    """
    Custom OpenAI client wrapper with HSBC JWT authentication.
    Automatically handles token refresh on auth errors.
    """
    
    def __init__(
        self,
        token_service: HSBCTokenService,
        user_id: str,
        base_url: str,
        **kwargs
    ):
        """
        Initialize HSBC OpenAI Client
        
        Args:
            token_service: HSBCTokenService instance for token management
            user_id: HSBC user ID to include in requests
            base_url: Base URL for OpenAI-compatible API
            **kwargs: Additional arguments for OpenAI client
        """
        self.token_service = token_service
        self.user_id = user_id
        self.base_url = base_url
        
        # Get initial token
        initial_token = token_service.get_token()
        
        # Initialize OpenAI client
        self._client = OpenAI(
            api_key=initial_token,
            base_url=base_url,
            **kwargs
        )
        
        # For compatibility
        self.api_key = initial_token
        
        logger.info(f"HSBC OpenAI Client initialized with base URL: {base_url}")
    
    def _get_custom_headers(self) -> Dict[str, str]:
        """
        Get custom headers for HSBC API
        
        Returns:
            dict: Headers including authentication token
        """
        token = self.token_service.get_token()
        return {
            "X-HSBC-E2E-Trust-Token": token,
            "Token_Type": "SESSION_TOKEN",
            "Content-Type": "application/json"
        }
    
    def _update_client_token(self):
        """Update the internal OpenAI client with fresh token"""
        fresh_token = self.token_service.get_token()
        self._client.api_key = fresh_token
        self.api_key = fresh_token
    
    @property
    def chat(self):
        """Return chat completions wrapper"""
        return self._ChatWrapper(self)
    
    @property
    def embeddings(self):
        """Return embeddings wrapper"""
        return self._EmbeddingsWrapper(self)
    
    class _ChatWrapper:
        """Wrapper for chat completions with HSBC auth"""
        
        def __init__(self, parent_client):
            self.parent = parent_client
        
        @property
        def completions(self):
            """Return completions wrapper"""
            return self._CompletionsWrapper(self.parent)
        
        class _CompletionsWrapper:
            """Wrapper for chat.completions.create"""
            
            def __init__(self, parent_client):
                self.parent = parent_client
            
            def create(self, *args, **kwargs):
                """
                Create chat completion with HSBC auth and automatic retry
                
                Args:
                    *args: Positional arguments for chat completion
                    **kwargs: Keyword arguments for chat completion
                    
                Returns:
                    Chat completion response
                """
                # Add user field if not present
                if 'user' not in kwargs:
                    kwargs['user'] = self.parent.user_id
                
                # Update token
                self.parent._update_client_token()
                
                # Add custom headers
                if 'extra_headers' not in kwargs:
                    kwargs['extra_headers'] = {}
                kwargs['extra_headers'].update(self.parent._get_custom_headers())
                
                try:
                    # Make the request
                    return self.parent._client.chat.completions.create(*args, **kwargs)
                    
                except (AuthenticationError, APIError) as e:
                    error_message = str(e).lower()
                    
                    # Check if it's an auth error
                    if any(keyword in error_message for keyword in ['auth', 'unauthorized', '401', '403', 'token', 'invalid']):
                        logger.warning(f"Authentication error detected: {e}")
                        logger.info("Invalidating token and retrying...")
                        
                        # Invalidate and refresh token
                        self.parent.token_service.invalidate_token()
                        self.parent._update_client_token()
                        
                        # Update headers with new token
                        kwargs['extra_headers'].update(self.parent._get_custom_headers())
                        
                        # Retry with fresh token
                        logger.info("Retrying with fresh token...")
                        return self.parent._client.chat.completions.create(*args, **kwargs)
                    else:
                        # Not an auth error, re-raise
                        raise
                
                except Exception as e:
                    logger.error(f"Unexpected error in chat completion: {e}")
                    raise
    
    class _EmbeddingsWrapper:
        """Wrapper for embeddings with HSBC auth"""
        
        def __init__(self, parent_client):
            self.parent = parent_client
        
        def create(self, *args, **kwargs):
            """
            Create embeddings with HSBC auth and automatic retry
            
            Args:
                *args: Positional arguments for embeddings
                **kwargs: Keyword arguments for embeddings
                
            Returns:
                Embeddings response
            """
            # Update token
            self.parent._update_client_token()
            
            # Add custom headers
            if 'extra_headers' not in kwargs:
                kwargs['extra_headers'] = {}
            kwargs['extra_headers'].update(self.parent._get_custom_headers())
            
            try:
                # Make the request
                return self.parent._client.embeddings.create(*args, **kwargs)
                
            except (AuthenticationError, APIError) as e:
                error_message = str(e).lower()
                
                # Check if it's an auth error
                if any(keyword in error_message for keyword in ['auth', 'unauthorized', '401', '403', 'token', 'invalid']):
                    logger.warning(f"Authentication error detected: {e}")
                    logger.info("Invalidating token and retrying...")
                    
                    # Invalidate and refresh token
                    self.parent.token_service.invalidate_token()
                    self.parent._update_client_token()
                    
                    # Update headers with new token
                    kwargs['extra_headers'].update(self.parent._get_custom_headers())
                    
                    # Retry with fresh token
                    logger.info("Retrying with fresh token...")
                    return self.parent._client.embeddings.create(*args, **kwargs)
                else:
                    # Not an auth error, re-raise
                    raise
            
            except Exception as e:
                logger.error(f"Unexpected error in embeddings: {e}")
                raise


def create_hsbc_client() -> HSBCOpenAIClient:
    """
    Factory function to create HSBC OpenAI client
    
    Returns:
        HSBCOpenAIClient: Configured client instance
        
    Raises:
        ValueError: If HSBC_PASSWORD not set
    """
    if not Config.HSBC_PASSWORD:
        raise ValueError(
            "HSBC_PASSWORD environment variable required for HSBC authentication. "
            "Set it using: export HSBC_PASSWORD='your-password'"
        )
    
    logger.info("Creating HSBC token service...")
    
    # Create token service
    token_service = HSBCTokenService(
        token_endpoint=Config.HSBC_TOKEN_ENDPOINT,
        username=Config.HSBC_USERNAME,
        password=Config.HSBC_PASSWORD
    )
    
    logger.info("Creating HSBC OpenAI client...")
    
    # Create and return HSBC client
    return HSBCOpenAIClient(
        token_service=token_service,
        user_id=Config.HSBC_USER_ID,
        base_url=Config.BASE_URL
    )
