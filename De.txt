"""
Legal Summary Word Document Generator (UPDATED)
Generates formatted Word documents with citations, evidence, and proper classification

Location: src/generators/legal_summary_generator.py
"""

from typing import Dict, List, Any, Optional
from docx import Document
from docx.shared import Pt, RGBColor, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.enum.style import WD_STYLE_TYPE
from datetime import datetime
import os


class LegalSummaryGenerator:
    """
    Generates professional Word documents from legal document analysis
    with citations, evidence, and proper classification
    """
    
    def __init__(self, output_dir: str = "output/legal_summaries"):
        self.output_dir = output_dir
        os.makedirs(output_dir, exist_ok=True)
    
    def create_document(self, analysis: Dict[str, Any]) -> Document:
        """Create a formatted Word document from analysis"""
        doc = Document()
        
        # Set up styles
        self._setup_styles(doc)
        
        # Add content sections
        self._add_title(doc, analysis)
        self._add_metadata(doc, analysis)
        self._add_classification(doc, analysis)  # NEW
        self._add_description(doc, analysis)
        self._add_citations_section(doc, analysis)  # NEW
        self._add_data_actions_section(doc, analysis)  # UPDATED
        self._add_evidence_section(doc, analysis)  # NEW
        self._add_constraints_section(doc, analysis)
        self._add_enterprise_policies_section(doc, analysis)  # NEW
        self._add_footer(doc, analysis)
        
        return doc
    
    def _setup_styles(self, doc: Document):
        """Set up custom styles for the document"""
        styles = doc.styles
        
        # Main Title style
        if 'CustomTitle' not in styles:
            title_style = styles.add_style('CustomTitle', WD_STYLE_TYPE.PARAGRAPH)
            title_style.font.name = 'Calibri'
            title_style.font.size = Pt(24)
            title_style.font.bold = True
            title_style.font.color.rgb = RGBColor(0, 51, 102)  # Dark blue
        
        # Heading styles
        heading1 = styles['Heading 1']
        heading1.font.name = 'Calibri'
        heading1.font.size = Pt(16)
        heading1.font.color.rgb = RGBColor(0, 51, 102)
        
        heading2 = styles['Heading 2']
        heading2.font.name = 'Calibri'
        heading2.font.size = Pt(14)
        heading2.font.color.rgb = RGBColor(0, 102, 204)
        
        heading3 = styles['Heading 3']
        heading3.font.name = 'Calibri'
        heading3.font.size = Pt(12)
        heading3.font.color.rgb = RGBColor(0, 102, 204)
        
        # Normal text
        normal = styles['Normal']
        normal.font.name = 'Calibri'
        normal.font.size = Pt(11)
    
    def _add_title(self, doc: Document, analysis: Dict[str, Any]):
        """Add document title"""
        metadata = analysis.get("metadata", {})
        rule_name = metadata.get("rule_name", "Legal Rule Analysis")
        
        title = doc.add_paragraph(rule_name, style='CustomTitle')
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        # Add subtitle with jurisdiction
        jurisdiction = metadata.get("jurisdiction", "General")
        subtitle = doc.add_paragraph(f"Jurisdiction: {jurisdiction}")
        subtitle.alignment = WD_ALIGN_PARAGRAPH.CENTER
        subtitle.runs[0].font.size = Pt(12)
        subtitle.runs[0].font.italic = True
        subtitle.runs[0].font.color.rgb = RGBColor(80, 80, 80)
        
        doc.add_paragraph()  # Spacing
    
    def _add_metadata(self, doc: Document, analysis: Dict[str, Any]):
        """Add metadata section"""
        metadata = analysis.get("metadata", {})
        
        # Create a table for metadata
        table = doc.add_table(rows=0, cols=2)
        table.style = 'Light Grid Accent 1'
        
        def add_metadata_row(label: str, value: str):
            row = table.add_row()
            label_cell = row.cells[0]
            value_cell = row.cells[1]
            
            label_cell.text = label
            value_cell.text = value
            
            # Make label bold
            label_cell.paragraphs[0].runs[0].font.bold = True
        
        add_metadata_row("Rule Name", metadata.get("rule_name", "N/A"))
        add_metadata_row("Jurisdiction", metadata.get("jurisdiction", "N/A"))
        add_metadata_row("Analysis Date", datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
        add_metadata_row("Document Levels", f"Level 1, Level 2, Level 3")
        add_metadata_row("Total Chunks Processed", 
                        str(metadata.get("level_1_chunks", 0) + 
                            metadata.get("level_2_chunks", 0) + 
                            metadata.get("level_3_chunks", 0)))
        
        if metadata.get("enterprise_context"):
            ent_ctx = metadata["enterprise_context"]
            if ent_ctx.get("organization"):
                add_metadata_row("Organization", ent_ctx["organization"])
            if ent_ctx.get("internal_tools"):
                add_metadata_row("Internal Tools", ", ".join(ent_ctx["internal_tools"]))
        
        doc.add_paragraph()  # Spacing
    
    def _add_classification(self, doc: Document, analysis: Dict[str, Any]):
        """Add rule classification section (NEW)"""
        doc.add_heading("Rule Classification", level=1)
        
        classification = analysis.get("classification", "condition")
        
        # Add classification with color coding
        para = doc.add_paragraph()
        para.add_run("Classification: ").bold = True
        
        class_run = para.add_run(classification.upper())
        class_run.bold = True
        class_run.font.size = Pt(14)
        
        if classification == "condition":
            class_run.font.color.rgb = RGBColor(0, 128, 0)  # Green
            doc.add_paragraph("This rule allows certain actions under specific conditions.")
        elif classification == "restriction":
            class_run.font.color.rgb = RGBColor(178, 34, 34)  # Red
            doc.add_paragraph("This rule prohibits or restricts certain actions.")
        
        # Add reasoning
        reasoning = analysis.get("classification_reasoning", "")
        if reasoning:
            doc.add_paragraph()
            para = doc.add_paragraph()
            para.add_run("Reasoning: ").bold = True
            para.add_run(reasoning).italic = True
        
        doc.add_paragraph()  # Spacing
    
    def _add_description(self, doc: Document, analysis: Dict[str, Any]):
        """Add description section"""
        doc.add_heading("Description of the Rule", level=1)
        
        description = analysis.get("description", "No description provided.")
        para = doc.add_paragraph(description)
        para.style = 'Normal'
        
        doc.add_paragraph()  # Spacing
    
    def _add_citations_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add citations section showing references (NEW)"""
        doc.add_heading("Citations and References", level=1)
        
        citations = analysis.get("citations", [])
        
        if not citations:
            doc.add_paragraph("No specific citations extracted.")
            doc.add_paragraph()
            return
        
        # Group citations by level
        level_citations = {1: [], 2: [], 3: []}
        for cite in citations:
            level = cite.get("level", 1)
            level_citations[level].append(cite)
        
        # Display citations by level
        for level in [1, 2, 3]:
            level_cites = level_citations[level]
            if not level_cites:
                continue
            
            level_name = "Legislation" if level == 1 else "Guidance" if level == 2 else "Enterprise Policies"
            doc.add_heading(f"Level {level}: {level_name}", level=2)
            
            for i, cite in enumerate(level_cites, 1):
                para = doc.add_paragraph()
                
                # Citation number
                para.add_run(f"[{i}] ").bold = True
                
                # Text excerpt
                text_excerpt = cite.get("text", "")[:200]
                if len(cite.get("text", "")) > 200:
                    text_excerpt += "..."
                para.add_run(f'"{text_excerpt}"')
                
                # Reasoning (if available)
                reasoning = cite.get("reasoning", "")
                if reasoning:
                    para.add_run(f" - {reasoning}").italic = True
                
                # Source info
                para.add_run(f" (Chunk {cite.get('chunk_id', 'N/A')} + 1)").font.size = Pt(9)
        
        doc.add_paragraph()  # Spacing
    
    def _add_data_actions_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add data actions section with simplified taxonomy (UPDATED)"""
        doc.add_heading("Data Actions", level=1)
        
        doc.add_paragraph(
            "Actions are categorized using a simplified taxonomy focused on data operations:"
        ).italic = True
        
        data_actions = analysis.get("data_actions", [])
        
        if not data_actions:
            doc.add_paragraph("No specific data actions identified.")
            doc.add_paragraph()
            return
        
        # Group by action type
        actions_by_type = {
            "data_sharing_and_access": [],
            "data_storage_and_hosting": [],
            "data_usage": []
        }
        
        for action in data_actions:
            action_type = action.get("type", "data_usage")
            actions_by_type[action_type].append(action)
        
        # Display by category
        categories = {
            "data_sharing_and_access": "Data Sharing & Data Access",
            "data_storage_and_hosting": "Data Storage & Data Hosting",
            "data_usage": "Data Usage"
        }
        
        for action_type, category_name in categories.items():
            actions = actions_by_type[action_type]
            if not actions:
                continue
            
            doc.add_heading(category_name, level=2)
            
            for action in actions:
                para = doc.add_paragraph(style='List Bullet')
                
                # Action description
                desc = action.get("description", "")
                para.add_run(desc)
                
                # Citations (if available)
                citations = action.get("citations", [])
                if citations:
                    para.add_run(f" [Citations: {len(citations)}]").font.size = Pt(9)
        
        doc.add_paragraph()  # Spacing
    
    def _add_evidence_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add evidence section showing user and system perspectives (NEW)"""
        doc.add_heading("Evidence and Requirements", level=1)
        
        # User Evidence
        doc.add_heading("User Perspective", level=2)
        doc.add_paragraph(
            "Requirements and actions from the user's perspective (what users must/can/cannot do):"
        ).italic = True
        
        user_evidence = analysis.get("user_evidence", [])
        if user_evidence:
            for i, evidence in enumerate(user_evidence, 1):
                para = doc.add_paragraph(style='List Number')
                
                # Evidence description
                desc = evidence.get("description", "")
                para.add_run(desc)
                
                # Citations
                citations = evidence.get("citations", [])
                if citations:
                    para.add_run(f" [Supported by {len(citations)} citation(s)]").font.size = Pt(9)
                    
                    # Show first citation as example
                    if citations:
                        first_cite = citations[0]
                        text = first_cite.get("text", "")[:100]
                        sub_para = doc.add_paragraph(style='List Bullet 2')
                        sub_para.add_run(f'Example: "{text}..."').italic = True
                        sub_para.runs[0].font.size = Pt(9)
        else:
            doc.add_paragraph("No user-specific evidence identified.")
        
        doc.add_paragraph()  # Spacing
        
        # System Evidence
        doc.add_heading("System Perspective", level=2)
        doc.add_paragraph(
            "Requirements from the system's perspective (what systems must implement):"
        ).italic = True
        
        system_evidence = analysis.get("system_evidence", [])
        if system_evidence:
            for i, evidence in enumerate(system_evidence, 1):
                para = doc.add_paragraph(style='List Number')
                
                # Evidence description
                desc = evidence.get("description", "")
                para.add_run(desc)
                
                # Citations
                citations = evidence.get("citations", [])
                if citations:
                    para.add_run(f" [Supported by {len(citations)} citation(s)]").font.size = Pt(9)
                    
                    # Show first citation as example
                    if citations:
                        first_cite = citations[0]
                        text = first_cite.get("text", "")[:100]
                        sub_para = doc.add_paragraph(style='List Bullet 2')
                        sub_para.add_run(f'Example: "{text}..."').italic = True
                        sub_para.runs[0].font.size = Pt(9)
        else:
            doc.add_paragraph("No system-specific evidence identified.")
        
        doc.add_paragraph()  # Spacing
    
    def _add_constraints_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add constraints section"""
        doc.add_heading("Constraints and Conditions", level=1)
        
        constraints = analysis.get("constraints", [])
        
        if not constraints:
            doc.add_paragraph("No specific constraints identified.")
            doc.add_paragraph()
            return
        
        # Group by type if available
        constraints_by_type = {}
        for constraint in constraints:
            if isinstance(constraint, dict):
                constraint_type = constraint.get("type", "general")
                if constraint_type not in constraints_by_type:
                    constraints_by_type[constraint_type] = []
                constraints_by_type[constraint_type].append(constraint)
            else:
                if "general" not in constraints_by_type:
                    constraints_by_type["general"] = []
                constraints_by_type["general"].append({"description": str(constraint)})
        
        for constraint_type, constraints_list in constraints_by_type.items():
            doc.add_heading(constraint_type.replace("_", " ").title(), level=2)
            
            for constraint in constraints_list:
                if isinstance(constraint, dict):
                    desc = constraint.get("description", str(constraint))
                else:
                    desc = str(constraint)
                
                para = doc.add_paragraph(desc, style='List Bullet')
        
        doc.add_paragraph()  # Spacing
    
    def _add_enterprise_policies_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add enterprise-specific policies section (NEW)"""
        metadata = analysis.get("metadata", {})
        
        # Check if Level 3 was processed
        if not metadata.get("level_3_enterprise_specific"):
            return
        
        doc.add_heading("Enterprise-Specific Policies", level=1)
        
        doc.add_paragraph(
            "The following information is derived from Level 3 enterprise-specific policy documents:"
        ).italic = True
        
        doc.add_paragraph()
        
        # Show enterprise context
        enterprise_context = metadata.get("enterprise_context", {})
        if enterprise_context:
            if enterprise_context.get("organization"):
                para = doc.add_paragraph()
                para.add_run("Organization: ").bold = True
                para.add_run(enterprise_context["organization"])
            
            if enterprise_context.get("internal_tools"):
                para = doc.add_paragraph()
                para.add_run("Internal Tools Referenced: ").bold = True
                para.add_run(", ".join(enterprise_context["internal_tools"]))
        
        # Show Level 3 specific actions and evidence
        data_actions = analysis.get("data_actions", [])
        level_3_actions = [a for a in data_actions if any(
            c.get("level") == 3 for c in a.get("citations", [])
        )]
        
        if level_3_actions:
            doc.add_paragraph()
            doc.add_heading("Enterprise-Specific Data Actions", level=2)
            
            for action in level_3_actions:
                para = doc.add_paragraph(style='List Bullet')
                para.add_run(f"{action.get('type', 'N/A').replace('_', ' ').title()}: ")
                para.add_run(action.get('description', ''))
        
        doc.add_paragraph()  # Spacing
    
    def _add_footer(self, doc: Document, analysis: Dict[str, Any]):
        """Add footer with disclaimer and timestamp"""
        doc.add_paragraph()
        doc.add_paragraph()
        
        # Add disclaimer
        disclaimer = doc.add_paragraph(
            "Disclaimer: This analysis is generated automatically from legal documents. "
            "It should be reviewed by qualified legal professionals before implementation. "
            "The analysis is based on the documents provided and may require updates "
            "as regulations evolve."
        )
        disclaimer.runs[-1].font.italic = True
        disclaimer.runs[-1].font.size = Pt(9)
        disclaimer.runs[-1].font.color.rgb = RGBColor(100, 100, 100)
        
        # Add generation timestamp
        doc.add_paragraph()
        timestamp = doc.add_paragraph(
            f"Document generated on {datetime.now().strftime('%Y-%m-%d at %H:%M:%S')}"
        )
        timestamp.alignment = WD_ALIGN_PARAGRAPH.CENTER
        timestamp.runs[0].font.size = Pt(9)
        timestamp.runs[0].font.color.rgb = RGBColor(150, 150, 150)
    
    def save_document(
        self,
        doc: Document,
        rule_name: str,
        jurisdiction: str,
        filename: Optional[str] = None
    ) -> str:
        """Save the document to file"""
        if filename is None:
            # Generate filename from rule name and jurisdiction
            safe_rule_name = "".join(c if c.isalnum() or c in (' ', '_') else '_' for c in rule_name)
            safe_rule_name = safe_rule_name.replace(' ', '_')
            safe_jurisdiction = jurisdiction.replace(' ', '_')
            
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"{safe_rule_name}_{safe_jurisdiction}_{timestamp}.docx"
        
        filepath = os.path.join(self.output_dir, filename)
        doc.save(filepath)
        
        return filepath
    
    def generate_legal_summary(
        self,
        analysis: Dict[str, Any],
        filename: Optional[str] = None
    ) -> str:
        """
        Main method to generate a complete legal summary document
        
        Args:
            analysis: Dictionary containing the legal analysis
            filename: Optional custom filename
            
        Returns:
            Path to the saved document
        """
        doc = self.create_document(analysis)
        
        metadata = analysis.get("metadata", {})
        rule_name = metadata.get("rule_name", "Legal_Rule")
        jurisdiction = metadata.get("jurisdiction", "General")
        
        filepath = self.save_document(doc, rule_name, jurisdiction, filename)
        
        return filepath
    
    def create_index_document(
        self,
        analyses: Dict[str, Dict[str, Any]],
        output_filename: str = "Legal_Summaries_Index.docx"
    ) -> str:
        """Create an index document listing all analyzed rules"""
        doc = Document()
        self._setup_styles(doc)
        
        # Title
        title = doc.add_paragraph("Legal Rules Summary Index", style='CustomTitle')
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        subtitle = doc.add_paragraph(f"Generated on {datetime.now().strftime('%Y-%m-%d')}")
        subtitle.alignment = WD_ALIGN_PARAGRAPH.CENTER
        subtitle.runs[0].font.size = Pt(12)
        subtitle.runs[0].font.italic = True
        
        doc.add_paragraph()
        
        # Summary statistics
        doc.add_heading("Summary Statistics", level=1)
        doc.add_paragraph(f"Total Rules Analyzed: {len(analyses)}")
        
        # Count by classification
        classification_counts = {}
        for analysis in analyses.values():
            classification = analysis.get("classification", "unknown")
            classification_counts[classification] = classification_counts.get(classification, 0) + 1
        
        if classification_counts:
            doc.add_paragraph("Rules by Classification:")
            for classification, count in classification_counts.items():
                para = doc.add_paragraph(style='List Bullet')
                para.add_run(f"{classification.title()}: {count}")
                if classification == "condition":
                    para.runs[-1].font.color.rgb = RGBColor(0, 128, 0)
                elif classification == "restriction":
                    para.runs[-1].font.color.rgb = RGBColor(178, 34, 34)
        
        doc.add_paragraph()
        
        # Rules list
        doc.add_heading("Rules Analyzed", level=1)
        
        # Create table
        table = doc.add_table(rows=1, cols=4)
        table.style = 'Light Grid Accent 1'
        
        # Header row
        header_cells = table.rows[0].cells
        header_cells[0].text = "Rule Name"
        header_cells[1].text = "Jurisdiction"
        header_cells[2].text = "Classification"
        header_cells[3].text = "Actions"
        
        for cell in header_cells:
            cell.paragraphs[0].runs[0].font.bold = True
        
        # Data rows
        for rule_name, analysis in analyses.items():
            metadata = analysis.get("metadata", {})
            row = table.add_row()
            
            row.cells[0].text = rule_name
            row.cells[1].text = metadata.get("jurisdiction", "N/A")
            
            classification = analysis.get("classification", "N/A")
            row.cells[2].text = classification.title()
            
            num_actions = len(analysis.get("data_actions", []))
            row.cells[3].text = str(num_actions)
        
        # Save
        filepath = os.path.join(self.output_dir, output_filename)
        doc.save(filepath)
        
        return filepath
