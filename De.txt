from pptx.util import Inches
from pptx.oxml import parse_xml
from pptx.oxml.ns import nsdecls

# Helper function to trim the URL to show only the part after "ISO"
def trim_url(url):
    # Find the part of the URL after "ISO" and return it; if not found, return the full URL
    iso_index = url.find("ISO")
    return url[iso_index:] if iso_index != -1 else url

# Function to add a hyperlink to a cell by manipulating XML
def add_hyperlink_to_cell(cell, url):
    # Set the trimmed text
    trimmed_text = trim_url(url)
    cell.text = trimmed_text

    # Create the hyperlink XML structure
    hyperlink_xml = (
        f'<a:hlinkClick {nsdecls("a")}'
        f' r:id="{cell._tc.getparent().getparent().add_relationship("http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink", url, is_external=True)}"/>'
    )

    # Inject the hyperlink XML into the cell's XML structure
    cell._tc.get_or_add_p()._element.append(parse_xml(hyperlink_xml))

# Updated populate_slide_10 function with the clickable URL column
def populate_slide_10(slide, df_slide10):
    delete_existing_tables(slide)
    headers = ["Issue", "Summary", "Issues (URL)"]
    table = create_table(slide, headers, num_rows=1 + len(df_slide10), top_position=Inches(1))

    # Populate the table with data, adding hyperlinks to the "Issues (URL)" column
    for row_idx, row_data in enumerate(df_slide10.itertuples(index=False), start=1):
        # Set Issue and Summary cells
        table.cell(row_idx, 0).text = str(row_data.Issue)
        table.cell(row_idx, 1).text = str(row_data.Summary)
        
        # Set Issues (URL) cell with hyperlink
        add_hyperlink_to_cell(table.cell(row_idx, 2), str(row_data.Issue))

# Example usage within create_report function
def create_report(template_path, output_folder, report_value):
    try:
        prs = Presentation(template_path)
        # Generate data for Slide 10
        df_slide10 = generate_slide10_data(report_value)
        
        # Create folder for report
        report_name = "example_report"  # Replace with actual logic to get report name
        report_folder = os.path.join(output_folder, report_name)
        os.makedirs(report_folder, exist_ok=True)

        # Populate Slide 10 with trimmed URL as clickable hyperlinks
        if len(prs.slides) > 9:
            populate_slide_10(prs.slides[9], df_slide10)

        # Save the PowerPoint
        pptx_path = os.path.join(report_folder, f"{report_name}.pptx")
        prs.save(pptx_path)
        print(f"PowerPoint saved as {pptx_path}")

    except Exception as e:
        print(f"Error processing report URL {report_value}: {e}")
