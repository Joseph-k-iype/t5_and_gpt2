"""
Seed script to populate FalkorDB with sample data lineage
Represents cross-border data transfers across multiple countries and databases
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from falkordb import FalkorDB
from app.config import settings
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def clear_graph(graph):
    """Clear existing graph data"""
    try:
        graph.query("MATCH (n) DETACH DELETE n")
        logger.info("Cleared existing graph data")
    except Exception as e:
        logger.warning(f"Could not clear graph (might be empty): {e}")


def create_countries(graph):
    """Create country nodes"""
    countries = [
        {"code": "US", "name": "United States", "region": "North America"},
        {"code": "UK", "name": "United Kingdom", "region": "Europe"},
        {"code": "DE", "name": "Germany", "region": "Europe"},
        {"code": "IN", "name": "India", "region": "Asia"},
        {"code": "SG", "name": "Singapore", "region": "Asia"},
        {"code": "AU", "name": "Australia", "region": "Oceania"},
    ]
    
    for country in countries:
        query = """
        CREATE (c:Country {
            code: $code,
            name: $name,
            region: $region
        })
        """
        graph.query(query, country)
    
    logger.info(f"Created {len(countries)} country nodes")


def create_databases(graph):
    """Create database nodes and link to countries"""
    databases = [
        # US databases
        {"country": "US", "name": "CustomerDB_US", "type": "PostgreSQL", "purpose": "Customer Management"},
        {"country": "US", "name": "TransactionDB_US", "type": "MongoDB", "purpose": "Transaction Processing"},
        
        # UK databases
        {"country": "UK", "name": "CustomerDB_UK", "type": "PostgreSQL", "purpose": "Customer Management"},
        {"country": "UK", "name": "AnalyticsDB_UK", "type": "Snowflake", "purpose": "Analytics"},
        
        # Germany databases
        {"country": "DE", "name": "HRDB_DE", "type": "MySQL", "purpose": "Human Resources"},
        {"country": "DE", "name": "ComplianceDB_DE", "type": "PostgreSQL", "purpose": "Compliance"},
        
        # India databases
        {"country": "IN", "name": "DataWarehouse_IN", "type": "Redshift", "purpose": "Data Warehouse"},
        {"country": "IN", "name": "BackupDB_IN", "type": "S3", "purpose": "Backup Storage"},
        
        # Singapore databases
        {"country": "SG", "name": "APIGateway_SG", "type": "DynamoDB", "purpose": "API Management"},
        {"country": "SG", "name": "CacheDB_SG", "type": "Redis", "purpose": "Caching"},
        
        # Australia databases
        {"country": "AU", "name": "CustomerDB_AU", "type": "PostgreSQL", "purpose": "Customer Management"},
        {"country": "AU", "name": "ReportingDB_AU", "type": "BigQuery", "purpose": "Reporting"},
    ]
    
    for db in databases:
        query = """
        MATCH (c:Country {code: $country})
        CREATE (d:Database {
            name: $name,
            type: $type,
            purpose: $purpose
        })
        CREATE (c)-[:HOSTS]->(d)
        """
        graph.query(query, db)
    
    logger.info(f"Created {len(databases)} database nodes")


def create_attributes(graph):
    """Create attribute nodes and link to databases"""
    attributes = [
        # US CustomerDB attributes
        {"country": "US", "database": "CustomerDB_US", "name": "customer_id", "data_category": "PII", "sensitivity": "HIGH"},
        {"country": "US", "database": "CustomerDB_US", "name": "customer_name", "data_category": "PII", "sensitivity": "HIGH"},
        {"country": "US", "database": "CustomerDB_US", "name": "customer_email", "data_category": "PII", "sensitivity": "HIGH"},
        {"country": "US", "database": "CustomerDB_US", "name": "customer_address", "data_category": "PII", "sensitivity": "MEDIUM"},
        
        # US TransactionDB attributes
        {"country": "US", "database": "TransactionDB_US", "name": "transaction_id", "data_category": "Financial", "sensitivity": "HIGH"},
        {"country": "US", "database": "TransactionDB_US", "name": "transaction_amount", "data_category": "Financial", "sensitivity": "MEDIUM"},
        
        # UK CustomerDB attributes
        {"country": "UK", "database": "CustomerDB_UK", "name": "customer_id", "data_category": "PII", "sensitivity": "HIGH"},
        {"country": "UK", "database": "CustomerDB_UK", "name": "customer_name", "data_category": "PII", "sensitivity": "HIGH"},
        {"country": "UK", "database": "CustomerDB_UK", "name": "customer_phone", "data_category": "PII", "sensitivity": "MEDIUM"},
        
        # UK AnalyticsDB attributes
        {"country": "UK", "database": "AnalyticsDB_UK", "name": "aggregated_sales", "data_category": "Analytics", "sensitivity": "LOW"},
        {"country": "UK", "database": "AnalyticsDB_UK", "name": "customer_segment", "data_category": "Analytics", "sensitivity": "LOW"},
        
        # Germany HRDB attributes
        {"country": "DE", "database": "HRDB_DE", "name": "employee_id", "data_category": "PII", "sensitivity": "HIGH"},
        {"country": "DE", "database": "HRDB_DE", "name": "employee_salary", "data_category": "Financial", "sensitivity": "HIGH"},
        
        # Germany ComplianceDB attributes
        {"country": "DE", "database": "ComplianceDB_DE", "name": "audit_log", "data_category": "Compliance", "sensitivity": "MEDIUM"},
        {"country": "DE", "database": "ComplianceDB_DE", "name": "gdpr_consent", "data_category": "Compliance", "sensitivity": "HIGH"},
        
        # India DataWarehouse attributes
        {"country": "IN", "database": "DataWarehouse_IN", "name": "customer_analytics", "data_category": "Analytics", "sensitivity": "MEDIUM"},
        {"country": "IN", "database": "DataWarehouse_IN", "name": "transaction_summary", "data_category": "Financial", "sensitivity": "MEDIUM"},
        
        # India BackupDB attributes
        {"country": "IN", "database": "BackupDB_IN", "name": "backup_customer_data", "data_category": "PII", "sensitivity": "HIGH"},
        
        # Singapore APIGateway attributes
        {"country": "SG", "database": "APIGateway_SG", "name": "api_request_log", "data_category": "Technical", "sensitivity": "LOW"},
        {"country": "SG", "database": "APIGateway_SG", "name": "user_session", "data_category": "PII", "sensitivity": "MEDIUM"},
        
        # Singapore CacheDB attributes
        {"country": "SG", "database": "CacheDB_SG", "name": "cached_customer_data", "data_category": "PII", "sensitivity": "MEDIUM"},
        
        # Australia CustomerDB attributes
        {"country": "AU", "database": "CustomerDB_AU", "name": "customer_id", "data_category": "PII", "sensitivity": "HIGH"},
        {"country": "AU", "database": "CustomerDB_AU", "name": "customer_preferences", "data_category": "PII", "sensitivity": "LOW"},
        
        # Australia ReportingDB attributes
        {"country": "AU", "database": "ReportingDB_AU", "name": "monthly_report", "data_category": "Analytics", "sensitivity": "LOW"},
    ]
    
    for attr in attributes:
        query = """
        MATCH (c:Country {code: $country})-[:HOSTS]->(d:Database {name: $database})
        CREATE (a:Attribute {
            name: $name,
            data_category: $data_category,
            sensitivity: $sensitivity
        })
        CREATE (d)-[:CONTAINS]->(a)
        """
        graph.query(query, attr)
    
    logger.info(f"Created {len(attributes)} attribute nodes")


def create_transfers(graph):
    """Create transfer relationships between attributes"""
    transfers = [
        # US -> UK transfers (Hop 1)
        {"source_country": "US", "source_db": "CustomerDB_US", "source_attr": "customer_id",
         "target_country": "UK", "target_db": "CustomerDB_UK", "target_attr": "customer_id",
         "transfer_type": "CROSS_BORDER", "hop": 1, "mechanism": "API", "frequency": "Real-time"},
        
        {"source_country": "US", "source_db": "CustomerDB_US", "source_attr": "customer_name",
         "target_country": "UK", "target_db": "CustomerDB_UK", "target_attr": "customer_name",
         "transfer_type": "CROSS_BORDER", "hop": 1, "mechanism": "Batch", "frequency": "Daily"},
        
        # UK -> Germany transfers (Hop 2)
        {"source_country": "UK", "source_db": "CustomerDB_UK", "source_attr": "customer_id",
         "target_country": "DE", "target_db": "ComplianceDB_DE", "target_attr": "gdpr_consent",
         "transfer_type": "CROSS_BORDER", "hop": 2, "mechanism": "API", "frequency": "Real-time"},
        
        {"source_country": "UK", "source_db": "AnalyticsDB_UK", "source_attr": "aggregated_sales",
         "target_country": "DE", "target_db": "ComplianceDB_DE", "target_attr": "audit_log",
         "transfer_type": "CROSS_BORDER", "hop": 2, "mechanism": "Batch", "frequency": "Weekly"},
        
        # US -> India transfers (Hop 1)
        {"source_country": "US", "source_db": "TransactionDB_US", "source_attr": "transaction_id",
         "target_country": "IN", "target_db": "DataWarehouse_IN", "target_attr": "transaction_summary",
         "transfer_type": "CROSS_BORDER", "hop": 1, "mechanism": "ETL", "frequency": "Daily"},
        
        {"source_country": "US", "source_db": "CustomerDB_US", "source_attr": "customer_email",
         "target_country": "IN", "target_db": "BackupDB_IN", "target_attr": "backup_customer_data",
         "transfer_type": "CROSS_BORDER", "hop": 1, "mechanism": "Replication", "frequency": "Hourly"},
        
        # India -> Singapore transfers (Hop 2)
        {"source_country": "IN", "source_db": "DataWarehouse_IN", "source_attr": "customer_analytics",
         "target_country": "SG", "target_db": "APIGateway_SG", "target_attr": "user_session",
         "transfer_type": "CROSS_BORDER", "hop": 2, "mechanism": "API", "frequency": "Real-time"},
        
        # Singapore -> Australia transfers (Hop 3)
        {"source_country": "SG", "source_db": "APIGateway_SG", "source_attr": "user_session",
         "target_country": "AU", "target_db": "CustomerDB_AU", "target_attr": "customer_preferences",
         "transfer_type": "CROSS_BORDER", "hop": 3, "mechanism": "API", "frequency": "Real-time"},
        
        {"source_country": "SG", "source_db": "CacheDB_SG", "source_attr": "cached_customer_data",
         "target_country": "AU", "target_db": "CustomerDB_AU", "target_attr": "customer_id",
         "transfer_type": "CROSS_BORDER", "hop": 3, "mechanism": "Sync", "frequency": "Continuous"},
        
        # Australia -> US transfers (completing the cycle - Hop 4)
        {"source_country": "AU", "source_db": "ReportingDB_AU", "source_attr": "monthly_report",
         "target_country": "US", "target_db": "CustomerDB_US", "target_attr": "customer_address",
         "transfer_type": "CROSS_BORDER", "hop": 4, "mechanism": "Report", "frequency": "Monthly"},
        
        # Germany -> India (alternative path - Hop 3)
        {"source_country": "DE", "source_db": "ComplianceDB_DE", "source_attr": "audit_log",
         "target_country": "IN", "target_db": "DataWarehouse_IN", "target_attr": "customer_analytics",
         "transfer_type": "CROSS_BORDER", "hop": 3, "mechanism": "ETL", "frequency": "Weekly"},
        
        # UK -> Australia (direct path - Hop 1)
        {"source_country": "UK", "source_db": "CustomerDB_UK", "source_attr": "customer_phone",
         "target_country": "AU", "target_db": "CustomerDB_AU", "target_attr": "customer_id",
         "transfer_type": "CROSS_BORDER", "hop": 1, "mechanism": "API", "frequency": "Real-time"},
    ]
    
    for transfer in transfers:
        query = """
        MATCH (sc:Country {code: $source_country})-[:HOSTS]->(sd:Database {name: $source_db})-[:CONTAINS]->(sa:Attribute {name: $source_attr})
        MATCH (tc:Country {code: $target_country})-[:HOSTS]->(td:Database {name: $target_db})-[:CONTAINS]->(ta:Attribute {name: $target_attr})
        CREATE (sa)-[:TRANSFERS_TO {
            transfer_type: $transfer_type,
            hop_number: $hop,
            mechanism: $mechanism,
            frequency: $frequency
        }]->(ta)
        """
        graph.query(query, transfer)
    
    logger.info(f"Created {len(transfers)} transfer relationships")


def main():
    """Main seeding function"""
    logger.info("Starting data seeding process...")
    
    try:
        # Connect to FalkorDB
        client = FalkorDB(host=settings.FALKORDB_HOST, port=settings.FALKORDB_PORT)
        graph = client.select_graph(settings.FALKORDB_GRAPH_NAME)
        
        # Clear existing data
        clear_graph(graph)
        
        # Create nodes and relationships
        create_countries(graph)
        create_databases(graph)
        create_attributes(graph)
        create_transfers(graph)
        
        # Verify data
        verify_query = """
        MATCH (c:Country) WITH count(c) as countries
        MATCH (d:Database) WITH countries, count(d) as databases
        MATCH (a:Attribute) WITH countries, databases, count(a) as attributes
        MATCH ()-[t:TRANSFERS_TO]->() 
        RETURN countries, databases, attributes, count(t) as transfers
        """
        result = graph.query(verify_query)
        if result.result_set:
            stats = result.result_set[0]
            logger.info(f"\nSeeding completed successfully!")
            logger.info(f"Statistics:")
            logger.info(f"  Countries: {stats[0]}")
            logger.info(f"  Databases: {stats[1]}")
            logger.info(f"  Attributes: {stats[2]}")
            logger.info(f"  Transfers: {stats[3]}")
        
        client.close()
        logger.info("\nDatabase connection closed")
        
    except Exception as e:
        logger.error(f"Error during seeding: {e}")
        raise


if __name__ == "__main__":
    main()
