"""
Legal Summary Generator
Generates Word documents from legal analysis
COMPLETE VERSION - All errors fixed
Location: src/generators/legal_summary_generator.py
"""
import os
from datetime import datetime
from typing import Dict, Any, List, Optional
from docx import Document
from docx.shared import Pt, RGBColor, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.enum.style import WD_STYLE_TYPE


class LegalSummaryGenerator:
    """Generates Word documents from legal analysis"""
    
    def __init__(self, output_dir: str = "output/legal_summaries"):
        self.output_dir = output_dir
        os.makedirs(output_dir, exist_ok=True)
    
    def generate_legal_summary(
        self,
        analysis: Dict[str, Any],
        filename: Optional[str] = None
    ) -> str:
        """
        Generate a complete legal summary Word document
        
        Args:
            analysis: Dictionary containing the legal analysis
            filename: Optional custom filename
            
        Returns:
            Path to the generated document
        """
        # Create document
        doc = Document()
        
        # Setup styles
        self._setup_styles(doc)
        
        # Extract metadata
        metadata = analysis.get("metadata", {})
        rule_name = metadata.get("rule_name", "Unknown Rule")
        jurisdiction = metadata.get("jurisdiction", "Unknown")
        
        # Add title
        title = doc.add_heading(rule_name, level=0)
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        # Add subtitle
        subtitle = doc.add_paragraph(f"Legal Compliance Analysis - {jurisdiction}")
        subtitle.alignment = WD_ALIGN_PARAGRAPH.CENTER
        subtitle.runs[0].font.size = Pt(14)
        subtitle.runs[0].font.italic = True
        
        doc.add_paragraph()  # Spacing
        
        # Add executive summary
        self._add_executive_summary(doc, analysis)
        
        # Add main description
        self._add_description_section(doc, analysis)
        
        # Add citations
        self._add_citations_section(doc, analysis)
        
        # Add data actions
        self._add_data_actions_section(doc, analysis)
        
        # Add constraints
        self._add_constraints_section(doc, analysis)
        
        # Add evidence sections
        self._add_user_evidence_section(doc, analysis)
        self._add_system_evidence_section(doc, analysis)
        
        # Add enterprise policies (if any)
        self._add_enterprise_policies_section(doc, analysis)
        
        # Add classification
        self._add_classification_section(doc, analysis)
        
        # Add level-specific details
        self._add_level_details_section(doc, analysis)
        
        # Add footer
        self._add_document_footer(doc)
        
        # Save document
        filepath = self.save_document(doc, rule_name, jurisdiction, filename)
        
        return filepath
    
    def _setup_styles(self, doc: Document):
        """Setup custom styles for the document"""
        styles = doc.styles
        
        # Heading 1 style
        try:
            heading1 = styles['Heading 1']
            heading1.font.size = Pt(16)
            heading1.font.bold = True
            heading1.font.color.rgb = RGBColor(0, 51, 102)
        except:
            pass
        
        # Heading 2 style
        try:
            heading2 = styles['Heading 2']
            heading2.font.size = Pt(14)
            heading2.font.bold = True
            heading2.font.color.rgb = RGBColor(0, 102, 204)
        except:
            pass
    
    def _add_executive_summary(self, doc: Document, analysis: Dict[str, Any]):
        """Add executive summary section"""
        doc.add_heading("Executive Summary", level=1)
        
        metadata = analysis.get("metadata", {})
        
        summary_items = [
            f"Classification: {analysis.get('classification', 'N/A').upper()}",
            f"Total Citations: {len(analysis.get('citations', []))}",
            f"Total Data Actions: {len(analysis.get('data_actions', []))}",
            f"Total Constraints: {len(analysis.get('constraints', []))}",
            f"User Evidence Items: {len(analysis.get('user_evidence', []))}",
            f"System Evidence Items: {len(analysis.get('system_evidence', []))}",
            f"Enterprise Policies: {len(analysis.get('enterprise_policies', []))}"
        ]
        
        for item in summary_items:
            p = doc.add_paragraph(item, style='List Bullet')
            p.runs[0].font.size = Pt(11)
        
        doc.add_paragraph()
    
    def _add_description_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add rule description section"""
        doc.add_heading("Rule Description", level=1)
        
        description = analysis.get("description", "No description available")
        if description and len(description) > 0:
            p = doc.add_paragraph(description)
            p.runs[0].font.size = Pt(11)
        else:
            p = doc.add_paragraph("No description available")
            p.runs[0].font.italic = True
        
        doc.add_paragraph()
    
    def _add_citations_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add citations section"""
        citations = analysis.get("citations", [])
        
        if not citations:
            return
        
        doc.add_heading("Citations from Source Documents", level=1)
        
        for i, citation in enumerate(citations, 1):
            if isinstance(citation, dict):
                text = citation.get("text", "")
                reasoning = citation.get("reasoning", "")
                level = citation.get("level", "")
                
                doc.add_heading(f"Citation {i} (Level {level})", level=2)
                
                # Citation text
                p = doc.add_paragraph()
                p.add_run("Text: ").bold = True
                p.add_run(f'"{text}"')
                p.runs[-1].font.italic = True
                
                # Reasoning
                if reasoning:
                    p = doc.add_paragraph()
                    p.add_run("Reasoning: ").bold = True
                    p.add_run(reasoning)
                
                doc.add_paragraph()  # Spacing
        
        doc.add_paragraph()
    
    def _add_data_actions_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add data actions section"""
        actions = analysis.get("data_actions", [])
        
        if not actions:
            return
        
        doc.add_heading("Data Actions Required", level=1)
        
        for i, action in enumerate(actions, 1):
            if isinstance(action, dict):
                action_type = action.get("type", "N/A")
                description = action.get("description", "")
                thought_process = action.get("thought_process", "")
                citations = action.get("citations", [])
                
                doc.add_heading(f"Action {i}: {action_type}", level=2)
                
                # Description
                p = doc.add_paragraph()
                p.add_run("Description: ").bold = True
                p.add_run(description)
                
                # Thought process
                if thought_process:
                    p = doc.add_paragraph()
                    p.add_run("Analysis: ").bold = True
                    p.add_run(thought_process)
                
                # Citations
                if citations:
                    p = doc.add_paragraph()
                    p.add_run("Supporting Citations: ").bold = True
                    for cite in citations[:3]:  # Limit to first 3
                        doc.add_paragraph(f'"{cite}"', style='List Bullet 2')
                
                doc.add_paragraph()  # Spacing
        
        doc.add_paragraph()
    
    def _add_constraints_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add constraints section"""
        constraints = analysis.get("constraints", [])
        
        if not constraints:
            return
        
        doc.add_heading("Constraints and Conditions", level=1)
        
        for i, constraint in enumerate(constraints, 1):
            if isinstance(constraint, dict):
                constraint_type = constraint.get("type", "N/A")
                description = constraint.get("description", "")
                thought_process = constraint.get("thought_process", "")
                left_operand = constraint.get("left_operand", "")
                operator = constraint.get("operator", "")
                right_operand = constraint.get("right_operand", "")
                
                doc.add_heading(f"Constraint {i}: {constraint_type}", level=2)
                
                # Description
                p = doc.add_paragraph()
                p.add_run("Description: ").bold = True
                p.add_run(description)
                
                # Formal expression
                if left_operand and operator:
                    p = doc.add_paragraph()
                    p.add_run("Formal Expression: ").bold = True
                    p.add_run(f"{left_operand} {operator} {right_operand}")
                    p.runs[-1].font.italic = True
                
                # Thought process
                if thought_process:
                    p = doc.add_paragraph()
                    p.add_run("Analysis: ").bold = True
                    p.add_run(thought_process)
                
                doc.add_paragraph()  # Spacing
        
        doc.add_paragraph()
    
    def _add_user_evidence_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add user evidence section"""
        evidence_list = analysis.get("user_evidence", [])
        
        if not evidence_list:
            return
        
        doc.add_heading("User Evidence Requirements", level=1)
        
        intro = doc.add_paragraph(
            "These are actions and evidence that individual users must provide or maintain:"
        )
        intro.runs[0].font.italic = True
        
        for i, evidence in enumerate(evidence_list, 1):
            if isinstance(evidence, dict):
                description = evidence.get("description", "")
                thought_process = evidence.get("thought_process", "")
                citations = evidence.get("citations", [])
                
                doc.add_heading(f"User Requirement {i}", level=2)
                
                # Description
                p = doc.add_paragraph()
                p.add_run("Description: ").bold = True
                p.add_run(description)
                
                # Thought process
                if thought_process:
                    p = doc.add_paragraph()
                    p.add_run("Analysis: ").bold = True
                    p.add_run(thought_process)
                
                # Citations
                if citations:
                    p = doc.add_paragraph()
                    p.add_run("Supporting Citations: ").bold = True
                    for cite in citations[:2]:
                        doc.add_paragraph(f'"{cite}"', style='List Bullet 2')
                
                doc.add_paragraph()  # Spacing
        
        doc.add_paragraph()
    
    def _add_system_evidence_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add system evidence section"""
        evidence_list = analysis.get("system_evidence", [])
        
        if not evidence_list:
            return
        
        doc.add_heading("System Implementation Requirements", level=1)
        
        intro = doc.add_paragraph(
            "These are technical and system-level implementations required for compliance:"
        )
        intro.runs[0].font.italic = True
        
        for i, evidence in enumerate(evidence_list, 1):
            if isinstance(evidence, dict):
                description = evidence.get("description", "")
                thought_process = evidence.get("thought_process", "")
                citations = evidence.get("citations", [])
                
                doc.add_heading(f"System Requirement {i}", level=2)
                
                # Description
                p = doc.add_paragraph()
                p.add_run("Description: ").bold = True
                p.add_run(description)
                
                # Thought process
                if thought_process:
                    p = doc.add_paragraph()
                    p.add_run("Analysis: ").bold = True
                    p.add_run(thought_process)
                
                # Citations
                if citations:
                    p = doc.add_paragraph()
                    p.add_run("Supporting Citations: ").bold = True
                    for cite in citations[:2]:
                        doc.add_paragraph(f'"{cite}"', style='List Bullet 2')
                
                doc.add_paragraph()  # Spacing
        
        doc.add_paragraph()
    
    def _add_enterprise_policies_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add enterprise policies section"""
        policies = analysis.get("enterprise_policies", [])
        
        if not policies:
            return
        
        doc.add_heading("Enterprise-Specific Policies", level=1)
        
        intro = doc.add_paragraph(
            "These are organization-specific policies that go beyond legal requirements:"
        )
        intro.runs[0].font.italic = True
        
        for i, policy in enumerate(policies, 1):
            if isinstance(policy, dict):
                policy_name = policy.get("policy_name", "")
                description = policy.get("description", "")
                organization = policy.get("organization", "")
                applies_to = policy.get("applies_to", [])
                internal_tools = policy.get("internal_tools", [])
                thought_process = policy.get("thought_process", "")
                
                doc.add_heading(f"{i}. {policy_name}", level=2)
                
                # Organization
                if organization:
                    p = doc.add_paragraph()
                    p.add_run("Organization: ").bold = True
                    p.add_run(organization)
                
                # Description
                p = doc.add_paragraph()
                p.add_run("Description: ").bold = True
                p.add_run(description)
                
                # Applies to
                if applies_to:
                    p = doc.add_paragraph()
                    p.add_run("Applies To: ").bold = True
                    p.add_run(", ".join(applies_to))
                
                # Internal tools
                if internal_tools:
                    p = doc.add_paragraph()
                    p.add_run("Internal Tools: ").bold = True
                    p.add_run(", ".join(internal_tools))
                
                # Thought process
                if thought_process:
                    p = doc.add_paragraph()
                    p.add_run("Analysis: ").bold = True
                    p.add_run(thought_process)
                
                doc.add_paragraph()  # Spacing
        
        doc.add_paragraph()
    
    def _add_classification_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add classification section"""
        doc.add_heading("Classification", level=1)
        
        classification = analysis.get("classification", "N/A")
        reasoning = analysis.get("classification_reasoning", "No reasoning provided")
        
        # Classification type
        p = doc.add_paragraph()
        p.add_run("Type: ").bold = True
        run = p.add_run(classification.upper())
        run.font.size = Pt(12)
        run.font.bold = True
        
        if classification == "restriction":
            run.font.color.rgb = RGBColor(255, 0, 0)
        else:
            run.font.color.rgb = RGBColor(0, 128, 0)
        
        # Reasoning
        p = doc.add_paragraph()
        p.add_run("Reasoning: ").bold = True
        p.add_run(reasoning)
        
        doc.add_paragraph()
    
    def _add_level_details_section(self, doc: Document, analysis: Dict[str, Any]):
        """Add level-specific details"""
        metadata = analysis.get("metadata", {})
        
        if not metadata:
            return
        
        doc.add_heading("Analysis Details", level=1)
        
        details = [
            f"Level 1 Chunks Processed: {metadata.get('level_1_chunks', 0)}",
            f"Level 2 Chunks Processed: {metadata.get('level_2_chunks', 0)}",
            f"Level 3 Chunks Processed: {metadata.get('level_3_chunks', 0)}",
            f"Total Citations Extracted: {metadata.get('total_citations', 0)}",
            f"Total Actions Identified: {metadata.get('total_actions', 0)}",
            f"Total Constraints Found: {metadata.get('total_constraints', 0)}"
        ]
        
        for detail in details:
            p = doc.add_paragraph(detail, style='List Bullet')
            p.runs[0].font.size = Pt(10)
        
        doc.add_paragraph()
    
    def _add_document_footer(self, doc: Document):
        """Add disclaimer and generation info"""
        doc.add_page_break()
        
        # Add disclaimer
        doc.add_heading("Disclaimer", level=1)
        
        disclaimer = doc.add_paragraph(
            "This document is generated automatically from legal and regulatory sources. "
            "It should be reviewed by qualified legal professionals before implementation. "
            "The analysis is based on the documents provided and may require updates "
            "as regulations evolve."
        )
        disclaimer.runs[0].font.italic = True
        disclaimer.runs[0].font.size = Pt(9)
        disclaimer.runs[0].font.color.rgb = RGBColor(100, 100, 100)
        
        # Add generation timestamp
        doc.add_paragraph()
        timestamp = doc.add_paragraph(
            f"Document generated on {datetime.now().strftime('%Y-%m-%d at %H:%M:%S')}"
        )
        timestamp.alignment = WD_ALIGN_PARAGRAPH.CENTER
        timestamp.runs[0].font.size = Pt(9)
        timestamp.runs[0].font.color.rgb = RGBColor(150, 150, 150)
    
    def save_document(
        self,
        doc: Document,
        rule_name: str,
        jurisdiction: str,
        filename: Optional[str] = None
    ) -> str:
        """Save the document to file"""
        if filename is None:
            # Generate filename from rule name and jurisdiction
            safe_rule_name = "".join(c if c.isalnum() or c in (' ', '_') else '_' for c in rule_name)
            safe_rule_name = safe_rule_name.replace(' ', '_')
            safe_jurisdiction = jurisdiction.replace(' ', '_')
            
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"{safe_rule_name}_{safe_jurisdiction}_{timestamp}.docx"
        
        filepath = os.path.join(self.output_dir, filename)
        doc.save(filepath)
        
        return filepath
    
    def create_index_document(self, all_analyses: Dict[str, Dict[str, Any]]) -> str:
        """Create an index document summarizing all analyses"""
        doc = Document()
        
        # Title
        title = doc.add_heading("Legal Analysis Index", level=0)
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        subtitle = doc.add_paragraph(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        subtitle.alignment = WD_ALIGN_PARAGRAPH.CENTER
        subtitle.runs[0].font.italic = True
        
        doc.add_paragraph()
        
        # Summary
        doc.add_heading("Summary", level=1)
        doc.add_paragraph(f"Total Rules Analyzed: {len(all_analyses)}")
        
        doc.add_paragraph()
        
        # Index of rules
        doc.add_heading("Rules Index", level=1)
        
        for i, (rule_name, analysis) in enumerate(all_analyses.items(), 1):
            metadata = analysis.get("metadata", {})
            jurisdiction = metadata.get("jurisdiction", "Unknown")
            classification = analysis.get("classification", "N/A")
            
            doc.add_heading(f"{i}. {rule_name}", level=2)
            
            details = [
                f"Jurisdiction: {jurisdiction}",
                f"Classification: {classification.upper()}",
                f"Citations: {len(analysis.get('citations', []))}",
                f"Actions: {len(analysis.get('data_actions', []))}",
                f"Constraints: {len(analysis.get('constraints', []))}"
            ]
            
            for detail in details:
                doc.add_paragraph(detail, style='List Bullet')
            
            doc.add_paragraph()
        
        # Save index
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"INDEX_Legal_Analysis_{timestamp}.docx"
        filepath = os.path.join(self.output_dir, filename)
        doc.save(filepath)
        
        return filepath
