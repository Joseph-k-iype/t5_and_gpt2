"""
ODRL to CSV Converter - Convert ODRL policies to CSV format for review

UPDATED:
- Removed assigner and assignee columns from CSV output
- Focus on action, target, constraints, and detailed comments

Location: src/converters/odrl_to_csv.py
"""

import json
import csv
from pathlib import Path
from typing import Dict, List, Any, Union
import logging

logger = logging.getLogger(__name__)


class ODRLToCSVConverter:
    """
    Convert ODRL policies (JSON-LD format) to CSV for stakeholder review.
    
    Supports multiple CSV formats:
    - Wide format: One row per policy with all info
    - Long format: One row per permission/prohibition
    - Multi-CSV: Separate files for policies, permissions, prohibitions, constraints
    """
    
    def __init__(self, json_filepath: Union[str, Path]):
        """
        Initialize converter with ODRL JSON file.
        
        Args:
            json_filepath: Path to ODRL JSON-LD file
        """
        self.json_filepath = Path(json_filepath)
        
        if not self.json_filepath.exists():
            raise FileNotFoundError(f"ODRL JSON file not found: {json_filepath}")
        
        # Load JSON data
        with open(self.json_filepath, 'r', encoding='utf-8') as f:
            self.odrl_data = json.load(f)
        
        # Extract policies (can be single policy or array)
        if isinstance(self.odrl_data, dict):
            self.policies = [self.odrl_data]
        elif isinstance(self.odrl_data, list):
            self.policies = self.odrl_data
        else:
            raise ValueError("Invalid ODRL format")
    
    def convert_to_wide_csv(self, output_path: str = None) -> str:
        """
        Convert to WIDE format CSV: One row per policy with summary info.
        
        Args:
            output_path: Output CSV path (optional)
            
        Returns:
            Path to generated CSV
        """
        if output_path is None:
            output_path = self.json_filepath.stem + "_wide.csv"
        
        output_path = Path(output_path)
        
        rows = []
        for policy in self.policies:
            row = self._extract_policy_summary(policy)
            rows.append(row)
        
        # Write to CSV
        if rows:
            fieldnames = rows[0].keys()
            with open(output_path, 'w', newline='', encoding='utf-8') as f:
                writer = csv.DictWriter(f, fieldnames=fieldnames)
                writer.writeheader()
                writer.writerows(rows)
            
            print(f"✅ Wide format CSV saved to: {output_path}")
            print(f"   Rows: {len(rows)}, Columns: {len(fieldnames)}")
        
        return output_path
    
    def convert_to_long_csv(self, output_path: str = None) -> str:
        """
        Convert to LONG format CSV: One row per permission/prohibition.
        UPDATED: Removed assigner and assignee columns.
        
        Args:
            output_path: Output CSV path (optional)
            
        Returns:
            Path to generated CSV
        """
        if output_path is None:
            output_path = self.json_filepath.stem + "_long.csv"
        
        output_path = Path(output_path)
        
        rows = []
        for policy in self.policies:
            # Base policy data
            base_data = {
                'policy_uid': policy.get('uid', ''),
                'policy_type': policy.get('@type', '').replace('odrl:', ''),
                'created': policy.get('dct:created', ''),
                'creator': policy.get('dct:creator', '')
            }
            
            # Extract permissions
            permissions = policy.get('permission', [])
            if not isinstance(permissions, list):
                permissions = [permissions]
            
            for idx, perm in enumerate(permissions, 1):
                row = base_data.copy()
                row['rule_number'] = idx
                row['rule_class'] = 'permission'
                
                # Action
                action = perm.get('action', '')
                if isinstance(action, str):
                    row['action'] = self._extract_action_name(action)
                    row['action_uri'] = action
                else:
                    row['action'] = ''
                    row['action_uri'] = ''
                
                # Target
                target = perm.get('target', '')
                row['target'] = target
                
                # REMOVED: assigner and assignee columns
                # Focus on action and conditions only
                
                # Constraints
                constraints = perm.get('constraint', [])
                if constraints:
                    row['num_constraints'] = len(constraints) if isinstance(constraints, list) else 1
                    row['constraint_summary'] = self._summarize_constraints(constraints)
                    row['constraint_details'] = json.dumps(constraints, ensure_ascii=False)
                else:
                    row['num_constraints'] = 0
                    row['constraint_summary'] = ''
                    row['constraint_details'] = ''
                
                # Duties
                duties = perm.get('duty', [])
                if duties:
                    row['num_duties'] = len(duties) if isinstance(duties, list) else 1
                    row['duty_summary'] = self._summarize_duties(duties)
                else:
                    row['num_duties'] = 0
                    row['duty_summary'] = ''
                
                # Comment
                row['comment'] = perm.get('rdfs:comment', '')
                
                rows.append(row)
            
            # Extract prohibitions
            prohibitions = policy.get('prohibition', [])
            if not isinstance(prohibitions, list):
                prohibitions = [prohibitions]
            
            for idx, prohib in enumerate(prohibitions, 1):
                row = base_data.copy()
                row['rule_number'] = idx
                row['rule_class'] = 'prohibition'
                
                # Action
                action = prohib.get('action', '')
                if isinstance(action, str):
                    row['action'] = self._extract_action_name(action)
                    row['action_uri'] = action
                else:
                    row['action'] = ''
                    row['action_uri'] = ''
                
                # Target
                target = prohib.get('target', '')
                row['target'] = target
                
                # REMOVED: assigner and assignee columns
                
                # Constraints
                constraints = prohib.get('constraint', [])
                if constraints:
                    row['num_constraints'] = len(constraints) if isinstance(constraints, list) else 1
                    row['constraint_summary'] = self._summarize_constraints(constraints)
                    row['constraint_details'] = json.dumps(constraints, ensure_ascii=False)
                else:
                    row['num_constraints'] = 0
                    row['constraint_summary'] = ''
                    row['constraint_details'] = ''
                
                row['num_duties'] = 0
                row['duty_summary'] = ''
                row['comment'] = prohib.get('rdfs:comment', '')
                
                rows.append(row)
            
            # If no permissions or prohibitions, add one row for the policy
            if not policy.get('permission') and not policy.get('prohibition'):
                row = base_data.copy()
                row['rule_number'] = 0
                row['rule_class'] = 'none'
                row['action'] = ''
                row['action_uri'] = ''
                row['target'] = ''
                row['num_constraints'] = 0
                row['constraint_summary'] = ''
                row['constraint_details'] = ''
                row['num_duties'] = 0
                row['duty_summary'] = ''
                row['comment'] = ''
                rows.append(row)
        
        # Write to CSV
        if rows:
            fieldnames = rows[0].keys()
            with open(output_path, 'w', newline='', encoding='utf-8') as f:
                writer = csv.DictWriter(f, fieldnames=fieldnames)
                writer.writeheader()
                writer.writerows(rows)
            
            print(f"✅ Long format CSV saved to: {output_path}")
            print(f"   Rows: {len(rows)}, Columns: {len(fieldnames)}")
        
        return output_path
    
    def convert_to_multi_csv(self, output_dir: str = None):
        """
        Convert to MULTIPLE CSVs: Separate files for different entities.
        UPDATED: Removed assigner/assignee from all CSV files.
        
        - policies.csv: Policy metadata
        - permissions.csv: All permissions
        - prohibitions.csv: All prohibitions
        - constraints.csv: All constraints
        """
        if output_dir is None:
            output_dir = self.json_filepath.stem + "_multi"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(exist_ok=True)
        
        # 1. Policies CSV
        policies_rows = []
        for policy in self.policies:
            policies_rows.append(self._extract_policy_summary(policy))
        
        if policies_rows:
            with open(output_dir / "policies.csv", 'w', newline='', encoding='utf-8') as f:
                writer = csv.DictWriter(f, fieldnames=policies_rows[0].keys())
                writer.writeheader()
                writer.writerows(policies_rows)
        
        # 2. Permissions CSV
        permissions_rows = []
        for policy in self.policies:
            policy_uid = policy.get('uid', '')
            permissions = policy.get('permission', [])
            if not isinstance(permissions, list):
                permissions = [permissions]
            
            for idx, perm in enumerate(permissions, 1):
                row = {
                    'policy_uid': policy_uid,
                    'permission_id': f"{policy_uid}_perm_{idx}",
                    'action': self._extract_action_name(perm.get('action', '')),
                    'action_uri': perm.get('action', ''),
                    'target': perm.get('target', ''),
                    # REMOVED: assigner, assignee
                    'num_constraints': len(perm.get('constraint', [])),
                    'num_duties': len(perm.get('duty', [])),
                    'comment': perm.get('rdfs:comment', '')
                }
                permissions_rows.append(row)
        
        if permissions_rows:
            with open(output_dir / "permissions.csv", 'w', newline='', encoding='utf-8') as f:
                writer = csv.DictWriter(f, fieldnames=permissions_rows[0].keys())
                writer.writeheader()
                writer.writerows(permissions_rows)
        
        # 3. Prohibitions CSV
        prohibitions_rows = []
        for policy in self.policies:
            policy_uid = policy.get('uid', '')
            prohibitions = policy.get('prohibition', [])
            if not isinstance(prohibitions, list):
                prohibitions = [prohibitions]
            
            for idx, prohib in enumerate(prohibitions, 1):
                row = {
                    'policy_uid': policy_uid,
                    'prohibition_id': f"{policy_uid}_prohib_{idx}",
                    'action': self._extract_action_name(prohib.get('action', '')),
                    'action_uri': prohib.get('action', ''),
                    'target': prohib.get('target', ''),
                    # REMOVED: assigner, assignee
                    'num_constraints': len(prohib.get('constraint', [])),
                    'comment': prohib.get('rdfs:comment', '')
                }
                prohibitions_rows.append(row)
        
        if prohibitions_rows:
            with open(output_dir / "prohibitions.csv", 'w', newline='', encoding='utf-8') as f:
                writer = csv.DictWriter(f, fieldnames=prohibitions_rows[0].keys())
                writer.writeheader()
                writer.writerows(prohibitions_rows)
        
        # 4. Constraints CSV (from all permissions and prohibitions)
        constraints_rows = []
        for policy in self.policies:
            policy_uid = policy.get('uid', '')
            
            # From permissions
            permissions = policy.get('permission', [])
            if not isinstance(permissions, list):
                permissions = [permissions]
            
            for perm_idx, perm in enumerate(permissions, 1):
                constraints = perm.get('constraint', [])
                if not isinstance(constraints, list):
                    constraints = [constraints] if constraints else []
                
                for const_idx, const in enumerate(constraints, 1):
                    row = {
                        'policy_uid': policy_uid,
                        'parent_id': f"{policy_uid}_perm_{perm_idx}",
                        'parent_type': 'permission',
                        'constraint_id': f"{policy_uid}_perm_{perm_idx}_const_{const_idx}",
                        'left_operand': const.get('leftOperand', ''),
                        'operator': self._extract_operator_name(const.get('operator', '')),
                        'operator_uri': const.get('operator', ''),
                        'right_operand': str(const.get('rightOperand', '')),
                        'unit': const.get('unit', ''),
                        'data_type': const.get('dataType', ''),
                        'comment': const.get('rdfs:comment', '')
                    }
                    constraints_rows.append(row)
            
            # From prohibitions
            prohibitions = policy.get('prohibition', [])
            if not isinstance(prohibitions, list):
                prohibitions = [prohibitions]
            
            for prohib_idx, prohib in enumerate(prohibitions, 1):
                constraints = prohib.get('constraint', [])
                if not isinstance(constraints, list):
                    constraints = [constraints] if constraints else []
                
                for const_idx, const in enumerate(constraints, 1):
                    row = {
                        'policy_uid': policy_uid,
                        'parent_id': f"{policy_uid}_prohib_{prohib_idx}",
                        'parent_type': 'prohibition',
                        'constraint_id': f"{policy_uid}_prohib_{prohib_idx}_const_{const_idx}",
                        'left_operand': const.get('leftOperand', ''),
                        'operator': self._extract_operator_name(const.get('operator', '')),
                        'operator_uri': const.get('operator', ''),
                        'right_operand': str(const.get('rightOperand', '')),
                        'unit': const.get('unit', ''),
                        'data_type': const.get('dataType', ''),
                        'comment': const.get('rdfs:comment', '')
                    }
                    constraints_rows.append(row)
        
        if constraints_rows:
            with open(output_dir / "constraints.csv", 'w', newline='', encoding='utf-8') as f:
                writer = csv.DictWriter(f, fieldnames=constraints_rows[0].keys())
                writer.writeheader()
                writer.writerows(constraints_rows)
        
        print(f"✅ Multi-CSV format saved to: {output_dir}/")
        print(f"   Files: policies.csv, permissions.csv, prohibitions.csv, constraints.csv")
        
        return output_dir
    
    def _extract_policy_summary(self, policy: Dict[str, Any]) -> Dict[str, Any]:
        """Extract summary information from policy."""
        permissions = policy.get('permission', [])
        prohibitions = policy.get('prohibition', [])
        
        if not isinstance(permissions, list):
            permissions = [permissions] if permissions else []
        if not isinstance(prohibitions, list):
            prohibitions = [prohibitions] if prohibitions else []
        
        return {
            'uid': policy.get('uid', ''),
            'type': policy.get('@type', '').replace('odrl:', ''),
            'profile': policy.get('profile', ''),
            'created': policy.get('dct:created', ''),
            'creator': policy.get('dct:creator', ''),
            'num_permissions': len(permissions),
            'num_prohibitions': len(prohibitions),
            'total_rules': len(permissions) + len(prohibitions)
        }
    
    def _extract_action_name(self, action_uri: str) -> str:
        """Extract action name from URI."""
        if not action_uri:
            return ''
        
        # If it's already just a name, return it
        if '/' not in action_uri and ':' not in action_uri:
            return action_uri
        
        # Extract from URI
        if '/' in action_uri:
            return action_uri.split('/')[-1]
        elif ':' in action_uri:
            return action_uri.split(':')[-1]
        
        return action_uri
    
    def _extract_operator_name(self, operator_uri: str) -> str:
        """Extract operator name from URI."""
        if not operator_uri:
            return ''
        
        if '/' in operator_uri:
            return operator_uri.split('/')[-1]
        elif ':' in operator_uri:
            return operator_uri.split(':')[-1]
        
        return operator_uri
    
    def _summarize_constraints(self, constraints: Union[Dict, List[Dict]]) -> str:
        """Create human-readable summary of constraints."""
        if not constraints:
            return ''
        
        if not isinstance(constraints, list):
            constraints = [constraints]
        
        summaries = []
        for const in constraints:
            left = self._extract_action_name(const.get('leftOperand', ''))
            op = self._extract_operator_name(const.get('operator', ''))
            right = const.get('rightOperand', '')
            
            if left and op and right:
                summaries.append(f"{left} {op} {right}")
        
        return "; ".join(summaries)
    
    def _summarize_duties(self, duties: Union[Dict, List[Dict]]) -> str:
        """Create human-readable summary of duties."""
        if not duties:
            return ''
        
        if not isinstance(duties, list):
            duties = [duties]
        
        summaries = []
        for duty in duties:
            action = self._extract_action_name(duty.get('action', ''))
            if action:
                summaries.append(action)
        
        return "; ".join(summaries)


def convert_odrl_to_csv(
    json_filepath: str,
    output_format: str = "long",
    output_path: str = None
) -> str:
    """
    Convenience function to convert ODRL JSON to CSV.
    
    Args:
        json_filepath: Path to ODRL JSON file
        output_format: 'wide', 'long', or 'multi'
        output_path: Output path (optional)
        
    Returns:
        Path to generated CSV (or directory for multi format)
    """
    converter = ODRLToCSVConverter(json_filepath)
    
    if output_format == "wide":
        return converter.convert_to_wide_csv(output_path)
    elif output_format == "long":
        return converter.convert_to_long_csv(output_path)
    elif output_format == "multi":
        return converter.convert_to_multi_csv(output_path)
    else:
        raise ValueError(f"Invalid output format: {output_format}. Use 'wide', 'long', or 'multi'")
